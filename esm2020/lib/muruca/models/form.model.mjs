import { Subject, ReplaySubject } from 'rxjs';
import { MrInputTextDS } from '../data-sources/form/input-text.ds';
import { MrInputTextEH } from '../event-handlers/form/input-text.eh';
import { MrInputSelectDS } from '../data-sources/form/input-select.ds';
import { MrInputSelectEH } from '../event-handlers/form/input-select.eh';
import { MrInputCheckboxDS } from '../data-sources/form/input-checkbox.ds';
import { MrInputCheckboxEH } from '../event-handlers/form/input-checkbox.eh';
export class MrFormModel {
    constructor() {
        this.loaded$ = new ReplaySubject();
        this.inputs = {};
        this.inputTypes = {
            text: {
                ds: MrInputTextDS,
                eh: MrInputTextEH
            },
            select: {
                ds: MrInputSelectDS,
                eh: MrInputSelectEH
            },
            checkbox: {
                ds: MrInputCheckboxDS,
                eh: MrInputCheckboxEH
            }
        };
        this.changed$ = new Subject();
        this.getInput = (id) => this.inputs[id].ds;
        this.getInputs = () => {
            const inputs = {};
            Object.keys(this.inputs).forEach((id) => {
                inputs[id] = this.getInput(id);
            });
            return inputs;
        };
    }
    init(config) {
        this.config = config;
        // init inputs
        this.initInputs();
        // emit signal
        this.loaded$.next(true);
    }
    getState() {
        const state = {};
        Object.keys(this.inputs).forEach((key) => {
            state[key] = this.inputs[key].ds.getState();
        });
        return state;
    }
    addInputType(type, ds, eh) {
        if (this.inputTypes[type]) {
            throw Error(`input type ${type} already exists!`);
        }
        this.inputTypes[type] = { ds, eh };
    }
    initInputs() {
        const { sections } = this.config;
        sections.forEach((section) => {
            section.inputs.forEach(({ id, type, options, state, data }) => {
                const DSClass = this.inputTypes[type].ds;
                const EHClass = this.inputTypes[type].eh;
                const DSInstance = new DSClass(options || {});
                const EHInstance = new EHClass();
                // set datasource id
                DSInstance.id = id;
                // set initial data
                if (data) {
                    DSInstance.update(data);
                }
                // set state
                if (state) {
                    DSInstance.setState(state);
                }
                // set eventhandler hostid
                EHInstance.hostId = id;
                // attach datasource to eventhandler
                EHInstance.dataSource = DSInstance;
                // attach changed$ to eventhandler
                EHInstance.changed$ = this.changed$;
                // listen to input events
                EHInstance.listen();
                // save it to input
                this.inputs[id] = {
                    ds: DSInstance,
                    eh: EHInstance,
                    emit: (t, p) => EHInstance.emitInner(t, p)
                };
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL243LWJvaWxlcnBsYXRlLWxpYi9zcmMvbGliL211cnVjYS9tb2RlbHMvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDbkUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUN2RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDekUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFPN0UsTUFBTSxPQUFPLFdBQVc7SUFBeEI7UUFHUyxZQUFPLEdBQTJCLElBQUksYUFBYSxFQUFFLENBQUM7UUFFdEQsV0FBTSxHQU1ULEVBQUUsQ0FBQztRQUVDLGVBQVUsR0FLZDtZQUNGLElBQUksRUFBRTtnQkFDSixFQUFFLEVBQUUsYUFBYTtnQkFDakIsRUFBRSxFQUFFLGFBQWE7YUFDbEI7WUFDRCxNQUFNLEVBQUU7Z0JBQ04sRUFBRSxFQUFFLGVBQWU7Z0JBQ25CLEVBQUUsRUFBRSxlQUFlO2FBQ3BCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLEVBQUUsRUFBRSxpQkFBaUI7Z0JBQ3JCLEVBQUUsRUFBRSxpQkFBaUI7YUFDdEI7U0FDRixDQUFDO1FBRUYsYUFBUSxHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBWW5ELGFBQVEsR0FBRyxDQUFDLEVBQVUsRUFBMEIsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFD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QUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3BCLG1CQUFtQjtnQkFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRztvQkFDaEIsRUFBRSxFQUFFLFVBQVU7b0JBQ2QsRUFBRSxFQUFFLFVBQVU7b0JBQ2QsSUFBSSxFQUFFLENBQUMsQ0FBUyxFQUFFLENBQU0sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUN4RCxDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTXJJbnB1dFRleHREUyB9IGZyb20gJy4uL2RhdGEtc291cmNlcy9mb3JtL2lucHV0LXRleHQuZHMnO1xyXG5pbXBvcnQgeyBNcklucHV0VGV4dEVIIH0gZnJvbSAnLi4vZXZlbnQtaGFuZGxlcnMvZm9ybS9pbnB1dC10ZXh0LmVoJztcclxuaW1wb3J0IHsgTXJJbnB1dFNlbGVjdERTIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2VzL2Zvcm0vaW5wdXQtc2VsZWN0LmRzJztcclxuaW1wb3J0IHsgTXJJbnB1dFNlbGVjdEVIIH0gZnJvbSAnLi4vZXZlbnQtaGFuZGxlcnMvZm9ybS9pbnB1dC1zZWxlY3QuZWgnO1xyXG5pbXBvcnQgeyBNcklucHV0Q2hlY2tib3hEUyB9IGZyb20gJy4uL2RhdGEtc291cmNlcy9mb3JtL2lucHV0LWNoZWNrYm94LmRzJztcclxuaW1wb3J0IHsgTXJJbnB1dENoZWNrYm94RUggfSBmcm9tICcuLi9ldmVudC1oYW5kbGVycy9mb3JtL2lucHV0LWNoZWNrYm94LmVoJztcclxuaW1wb3J0IHtcclxuICBNckNoYW5nZWRQYXJhbXMsXHJcbiAgTXJJbnB1dERhdGFTb3VyY2UsXHJcbiAgTXJGb3JtQ29uZmlnLFxyXG59IGZyb20gJy4uL2ludGVyZmFjZXMvZm9ybS5pbnRlcmZhY2UnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE1yRm9ybU1vZGVsIHtcclxuICBwdWJsaWMgY29uZmlnOiBNckZvcm1Db25maWc7XHJcblxyXG4gIHB1YmxpYyBsb2FkZWQkOiBSZXBsYXlTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFJlcGxheVN1YmplY3QoKTtcclxuXHJcbiAgcHVibGljIGlucHV0czoge1xyXG4gICAgW2lkOiBzdHJpbmddOiB7XHJcbiAgICAgIGRzOiBhbnk7XHJcbiAgICAgIGVoOiBhbnk7XHJcbiAgICAgIGVtaXQ6ICh0OiBzdHJpbmcsIHA6IGFueSkgPT4gRnVuY3Rpb247XHJcbiAgICB9O1xyXG4gIH0gPSB7fTtcclxuXHJcbiAgcHJpdmF0ZSBpbnB1dFR5cGVzOiB7XHJcbiAgICBbaWQ6IHN0cmluZ106IHtcclxuICAgICAgZHM6IGFueTtcclxuICAgICAgZWg6IGFueTtcclxuICAgIH07XHJcbiAgfSA9IHtcclxuICAgIHRleHQ6IHtcclxuICAgICAgZHM6IE1ySW5wdXRUZXh0RFMsXHJcbiAgICAgIGVoOiBNcklucHV0VGV4dEVIXHJcbiAgICB9LFxyXG4gICAgc2VsZWN0OiB7XHJcbiAgICAgIGRzOiBNcklucHV0U2VsZWN0RFMsXHJcbiAgICAgIGVoOiBNcklucHV0U2VsZWN0RUhcclxuICAgIH0sXHJcbiAgICBjaGVja2JveDoge1xyXG4gICAgICBkczogTXJJbnB1dENoZWNrYm94RFMsXHJcbiAgICAgIGVoOiBNcklucHV0Q2hlY2tib3hFSFxyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGNoYW5nZWQkOiBTdWJqZWN0PE1yQ2hhbmdlZFBhcmFtcz4gPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuICBpbml0KGNvbmZpZzogTXJGb3JtQ29uZmlnKSB7XHJcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcclxuXHJcbiAgICAvLyBpbml0IGlucHV0c1xyXG4gICAgdGhpcy5pbml0SW5wdXRzKCk7XHJcblxyXG4gICAgLy8gZW1pdCBzaWduYWxcclxuICAgIHRoaXMubG9hZGVkJC5uZXh0KHRydWUpO1xyXG4gIH1cclxuXHJcbiAgZ2V0SW5wdXQgPSAoaWQ6IHN0cmluZyk6IE1ySW5wdXREYXRhU291cmNlPGFueT4gPT4gdGhpcy5pbnB1dHNbaWRdLmRzO1xyXG5cclxuICBnZXRJbnB1dHMgPSAoKToge1xyXG4gICAgW2lkOiBzdHJpbmddOiBNcklucHV0RGF0YVNvdXJjZTxhbnk+O1xyXG4gIH0gPT4ge1xyXG4gICAgY29uc3QgaW5wdXRzID0ge307XHJcbiAgICBPYmplY3Qua2V5cyh0aGlzLmlucHV0cykuZm9yRWFjaCgoaWQpID0+IHtcclxuICAgICAgaW5wdXRzW2lkXSA9IHRoaXMuZ2V0SW5wdXQoaWQpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaW5wdXRzO1xyXG4gIH1cclxuXHJcbiAgZ2V0U3RhdGUoKSB7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xyXG4gICAgT2JqZWN0LmtleXModGhpcy5pbnB1dHMpLmZvckVhY2goKGtleSkgPT4ge1xyXG4gICAgICBzdGF0ZVtrZXldID0gdGhpcy5pbnB1dHNba2V5XS5kcy5nZXRTdGF0ZSgpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gc3RhdGU7XHJcbiAgfVxyXG5cclxuICBhZGRJbnB1dFR5cGUodHlwZTogc3RyaW5nLCBkczogYW55LCBlaDogYW55KSB7XHJcbiAgICBpZiAodGhpcy5pbnB1dFR5cGVzW3R5cGVdKSB7XHJcbiAgICAgIHRocm93IEVycm9yKGBpbnB1dCB0eXBlICR7dHlwZX0gYWxyZWFkeSBleGlzdHMhYCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5pbnB1dFR5cGVzW3R5cGVdID0geyBkcywgZWggfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdElucHV0cygpIHtcclxuICAgIGNvbnN0IHsgc2VjdGlvbnMgfSA9IHRoaXMuY29uZmlnO1xyXG4gICAgc2VjdGlvbnMuZm9yRWFjaCgoc2VjdGlvbikgPT4ge1xyXG4gICAgICBzZWN0aW9uLmlucHV0cy5mb3JFYWNoKCh7XHJcbiAgICAgICAgaWQsIHR5cGUsIG9wdGlvbnMsIHN0YXRlLCBkYXRhXHJcbiAgICAgIH0pID0+IHtcclxuICAgICAgICBjb25zdCBEU0NsYXNzID0gdGhpcy5pbnB1dFR5cGVzW3R5cGVdLmRzO1xyXG4gICAgICAgIGNvbnN0IEVIQ2xhc3MgPSB0aGlzLmlucHV0VHlwZXNbdHlwZV0uZWg7XHJcbiAgICAgICAgY29uc3QgRFNJbnN0YW5jZSA9IG5ldyBEU0NsYXNzKG9wdGlvbnMgfHwge30pO1xyXG4gICAgICAgIGNvbnN0IEVISW5zdGFuY2UgPSBuZXcgRUhDbGFzcygpO1xyXG4gICAgICAgIC8vIHNldCBkYXRhc291cmNlIGlkXHJcbiAgICAgICAgRFNJbnN0YW5jZS5pZCA9IGlkO1xyXG4gICAgICAgIC8vIHNldCBpbml0aWFsIGRhdGFcclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgRFNJbnN0YW5jZS51cGRhdGUoZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHNldCBzdGF0ZVxyXG4gICAgICAgIGlmIChzdGF0ZSkge1xyXG4gICAgICAgICAgRFNJbnN0YW5jZS5zZXRTdGF0ZShzdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIHNldCBldmVudGhhbmRsZXIgaG9zdGlkXHJcbiAgICAgICAgRUhJbnN0YW5jZS5ob3N0SWQgPSBpZDtcclxuICAgICAgICAvLyBhdHRhY2ggZGF0YXNvdXJjZSB0byBldmVudGhhbmRsZXJcclxuICAgICAgICBFSEluc3RhbmNlLmRhdGFTb3VyY2UgPSBEU0luc3RhbmNlO1xyXG4gICAgICAgIC8vIGF0dGFjaCBjaGFuZ2VkJCB0byBldmVudGhhbmRsZXJcclxuICAgICAgICBFSEluc3RhbmNlLmNoYW5nZWQkID0gdGhpcy5jaGFuZ2VkJDtcclxuICAgICAgICAvLyBsaXN0ZW4gdG8gaW5wdXQgZXZlbnRzXHJcbiAgICAgICAgRUhJbnN0YW5jZS5saXN0ZW4oKTtcclxuICAgICAgICAvLyBzYXZlIGl0IHRvIGlucHV0XHJcbiAgICAgICAgdGhpcy5pbnB1dHNbaWRdID0ge1xyXG4gICAgICAgICAgZHM6IERTSW5zdGFuY2UsXHJcbiAgICAgICAgICBlaDogRUhJbnN0YW5jZSxcclxuICAgICAgICAgIGVtaXQ6ICh0OiBzdHJpbmcsIHA6IGFueSkgPT4gRUhJbnN0YW5jZS5lbWl0SW5uZXIodCwgcClcclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=