import { Subject, ReplaySubject } from 'rxjs';
import { MrInputTextDS } from '../data-sources/form/input-text.ds';
import { MrInputTextEH } from '../event-handlers/form/input-text.eh';
import { MrInputSelectDS } from '../data-sources/form/input-select.ds';
import { MrInputSelectEH } from '../event-handlers/form/input-select.eh';
import { MrInputCheckboxDS } from '../data-sources/form/input-checkbox.ds';
import { MrInputCheckboxEH } from '../event-handlers/form/input-checkbox.eh';
export class MrFormModel {
    constructor() {
        this.loaded$ = new ReplaySubject();
        this.inputs = {};
        this.inputTypes = {
            text: {
                ds: MrInputTextDS,
                eh: MrInputTextEH
            },
            select: {
                ds: MrInputSelectDS,
                eh: MrInputSelectEH
            },
            checkbox: {
                ds: MrInputCheckboxDS,
                eh: MrInputCheckboxEH
            }
        };
        this.changed$ = new Subject();
        this.getInput = (id) => this.inputs[id].ds;
        this.getInputs = () => {
            const inputs = {};
            Object.keys(this.inputs).forEach((id) => {
                inputs[id] = this.getInput(id);
            });
            return inputs;
        };
    }
    init(config) {
        this.config = config;
        // init inputs
        this.initInputs();
        // emit signal
        this.loaded$.next(true);
    }
    getState() {
        const state = {};
        Object.keys(this.inputs).forEach((key) => {
            state[key] = this.inputs[key].ds.getState();
        });
        return state;
    }
    addInputType(type, ds, eh) {
        if (this.inputTypes[type]) {
            throw Error(`input type ${type} already exists!`);
        }
        this.inputTypes[type] = { ds, eh };
    }
    initInputs() {
        const { sections } = this.config;
        sections.forEach((section) => {
            section.inputs.forEach(({ id, type, options, state, data }) => {
                const DSClass = this.inputTypes[type].ds;
                const EHClass = this.inputTypes[type].eh;
                const DSInstance = new DSClass(options || {});
                const EHInstance = new EHClass();
                // set datasource id
                DSInstance.id = id;
                // set initial data
                if (data) {
                    DSInstance.update(data);
                }
                // set state
                if (state) {
                    DSInstance.setState(state);
                }
                // set eventhandler hostid
                EHInstance.hostId = id;
                // attach datasource to eventhandler
                EHInstance.dataSource = DSInstance;
                // attach changed$ to eventhandler
                EHInstance.changed$ = this.changed$;
                // listen to input events
                EHInstance.listen();
                // save it to input
                this.inputs[id] = {
                    ds: DSInstance,
                    eh: EHInstance,
                    emit: (t, p) => EHInstance.emitInner(t, p)
                };
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL243LWJvaWxlcnBsYXRlLWxpYi9zcmMvbGliL211cnVjYS9tb2RlbHMvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDbkUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUN2RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDekUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFPN0UsTUFBTSxPQUFPLFdBQVc7SUFBeEI7UUFHUyxZQUFPLEdBQTJCLElBQUksYUFBYSxFQUFFLENBQUM7UUFFdEQsV0FBTSxHQU1ULEVBQUUsQ0FBQztRQUVDLGVBQVUsR0FLZDtZQUNGLElBQUksRUFBRTtnQkFDSixFQUFFLEVBQUUsYUFBYTtnQkFDakIsRUFBRSxFQUFFLGFBQWE7YUFDbEI7WUFDRCxNQUFNLEVBQUU7Z0JBQ04sRUFBRSxFQUFFLGVBQWU7Z0JBQ25CLEVBQUUsRUFBRSxlQUFlO2FBQ3BCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLEVBQUUsRUFBRSxpQkFBaUI7Z0JBQ3JCLEVBQUUsRUFBRSxpQkFBaUI7YUFDdEI7U0FDRixDQUFDO1FBRUYsYUFBUSxHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBWW5ELGFBQVEsR0FBRyxDQUFDLEVBQVUsRUFBMEIsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFD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QUMsTUFBTSxFQUFFLENBQUM7Z0JBQ3BCLG1CQUFtQjtnQkFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRztvQkFDaEIsRUFBRSxFQUFFLFVBQVU7b0JBQ2QsRUFBRSxFQUFFLFVBQVU7b0JBQ2QsSUFBSSxFQUFFLENBQUMsQ0FBUyxFQUFFLENBQU0sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUN4RCxDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE1ySW5wdXRUZXh0RFMgfSBmcm9tICcuLi9kYXRhLXNvdXJjZXMvZm9ybS9pbnB1dC10ZXh0LmRzJztcbmltcG9ydCB7IE1ySW5wdXRUZXh0RUggfSBmcm9tICcuLi9ldmVudC1oYW5kbGVycy9mb3JtL2lucHV0LXRleHQuZWgnO1xuaW1wb3J0IHsgTXJJbnB1dFNlbGVjdERTIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2VzL2Zvcm0vaW5wdXQtc2VsZWN0LmRzJztcbmltcG9ydCB7IE1ySW5wdXRTZWxlY3RFSCB9IGZyb20gJy4uL2V2ZW50LWhhbmRsZXJzL2Zvcm0vaW5wdXQtc2VsZWN0LmVoJztcbmltcG9ydCB7IE1ySW5wdXRDaGVja2JveERTIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2VzL2Zvcm0vaW5wdXQtY2hlY2tib3guZHMnO1xuaW1wb3J0IHsgTXJJbnB1dENoZWNrYm94RUggfSBmcm9tICcuLi9ldmVudC1oYW5kbGVycy9mb3JtL2lucHV0LWNoZWNrYm94LmVoJztcbmltcG9ydCB7XG4gIE1yQ2hhbmdlZFBhcmFtcyxcbiAgTXJJbnB1dERhdGFTb3VyY2UsXG4gIE1yRm9ybUNvbmZpZyxcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9mb3JtLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjbGFzcyBNckZvcm1Nb2RlbCB7XG4gIHB1YmxpYyBjb25maWc6IE1yRm9ybUNvbmZpZztcblxuICBwdWJsaWMgbG9hZGVkJDogUmVwbGF5U3ViamVjdDxib29sZWFuPiA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XG5cbiAgcHVibGljIGlucHV0czoge1xuICAgIFtpZDogc3RyaW5nXToge1xuICAgICAgZHM6IGFueTtcbiAgICAgIGVoOiBhbnk7XG4gICAgICBlbWl0OiAodDogc3RyaW5nLCBwOiBhbnkpID0+IEZ1bmN0aW9uO1xuICAgIH07XG4gIH0gPSB7fTtcblxuICBwcml2YXRlIGlucHV0VHlwZXM6IHtcbiAgICBbaWQ6IHN0cmluZ106IHtcbiAgICAgIGRzOiBhbnk7XG4gICAgICBlaDogYW55O1xuICAgIH07XG4gIH0gPSB7XG4gICAgdGV4dDoge1xuICAgICAgZHM6IE1ySW5wdXRUZXh0RFMsXG4gICAgICBlaDogTXJJbnB1dFRleHRFSFxuICAgIH0sXG4gICAgc2VsZWN0OiB7XG4gICAgICBkczogTXJJbnB1dFNlbGVjdERTLFxuICAgICAgZWg6IE1ySW5wdXRTZWxlY3RFSFxuICAgIH0sXG4gICAgY2hlY2tib3g6IHtcbiAgICAgIGRzOiBNcklucHV0Q2hlY2tib3hEUyxcbiAgICAgIGVoOiBNcklucHV0Q2hlY2tib3hFSFxuICAgIH1cbiAgfTtcblxuICBjaGFuZ2VkJDogU3ViamVjdDxNckNoYW5nZWRQYXJhbXM+ID0gbmV3IFN1YmplY3QoKTtcblxuICBpbml0KGNvbmZpZzogTXJGb3JtQ29uZmlnKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAvLyBpbml0IGlucHV0c1xuICAgIHRoaXMuaW5pdElucHV0cygpO1xuXG4gICAgLy8gZW1pdCBzaWduYWxcbiAgICB0aGlzLmxvYWRlZCQubmV4dCh0cnVlKTtcbiAgfVxuXG4gIGdldElucHV0ID0gKGlkOiBzdHJpbmcpOiBNcklucHV0RGF0YVNvdXJjZTxhbnk+ID0+IHRoaXMuaW5wdXRzW2lkXS5kcztcblxuICBnZXRJbnB1dHMgPSAoKToge1xuICAgIFtpZDogc3RyaW5nXTogTXJJbnB1dERhdGFTb3VyY2U8YW55PjtcbiAgfSA9PiB7XG4gICAgY29uc3QgaW5wdXRzID0ge307XG4gICAgT2JqZWN0LmtleXModGhpcy5pbnB1dHMpLmZvckVhY2goKGlkKSA9PiB7XG4gICAgICBpbnB1dHNbaWRdID0gdGhpcy5nZXRJbnB1dChpZCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGlucHV0cztcbiAgfVxuXG4gIGdldFN0YXRlKCkge1xuICAgIGNvbnN0IHN0YXRlID0ge307XG4gICAgT2JqZWN0LmtleXModGhpcy5pbnB1dHMpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgc3RhdGVba2V5XSA9IHRoaXMuaW5wdXRzW2tleV0uZHMuZ2V0U3RhdGUoKTtcbiAgICB9KTtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cblxuICBhZGRJbnB1dFR5cGUodHlwZTogc3RyaW5nLCBkczogYW55LCBlaDogYW55KSB7XG4gICAgaWYgKHRoaXMuaW5wdXRUeXBlc1t0eXBlXSkge1xuICAgICAgdGhyb3cgRXJyb3IoYGlucHV0IHR5cGUgJHt0eXBlfSBhbHJlYWR5IGV4aXN0cyFgKTtcbiAgICB9XG5cbiAgICB0aGlzLmlucHV0VHlwZXNbdHlwZV0gPSB7IGRzLCBlaCB9O1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0SW5wdXRzKCkge1xuICAgIGNvbnN0IHsgc2VjdGlvbnMgfSA9IHRoaXMuY29uZmlnO1xuICAgIHNlY3Rpb25zLmZvckVhY2goKHNlY3Rpb24pID0+IHtcbiAgICAgIHNlY3Rpb24uaW5wdXRzLmZvckVhY2goKHtcbiAgICAgICAgaWQsIHR5cGUsIG9wdGlvbnMsIHN0YXRlLCBkYXRhXG4gICAgICB9KSA9PiB7XG4gICAgICAgIGNvbnN0IERTQ2xhc3MgPSB0aGlzLmlucHV0VHlwZXNbdHlwZV0uZHM7XG4gICAgICAgIGNvbnN0IEVIQ2xhc3MgPSB0aGlzLmlucHV0VHlwZXNbdHlwZV0uZWg7XG4gICAgICAgIGNvbnN0IERTSW5zdGFuY2UgPSBuZXcgRFNDbGFzcyhvcHRpb25zIHx8IHt9KTtcbiAgICAgICAgY29uc3QgRUhJbnN0YW5jZSA9IG5ldyBFSENsYXNzKCk7XG4gICAgICAgIC8vIHNldCBkYXRhc291cmNlIGlkXG4gICAgICAgIERTSW5zdGFuY2UuaWQgPSBpZDtcbiAgICAgICAgLy8gc2V0IGluaXRpYWwgZGF0YVxuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIERTSW5zdGFuY2UudXBkYXRlKGRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHNldCBzdGF0ZVxuICAgICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgICBEU0luc3RhbmNlLnNldFN0YXRlKHN0YXRlKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBzZXQgZXZlbnRoYW5kbGVyIGhvc3RpZFxuICAgICAgICBFSEluc3RhbmNlLmhvc3RJZCA9IGlkO1xuICAgICAgICAvLyBhdHRhY2ggZGF0YXNvdXJjZSB0byBldmVudGhhbmRsZXJcbiAgICAgICAgRUhJbnN0YW5jZS5kYXRhU291cmNlID0gRFNJbnN0YW5jZTtcbiAgICAgICAgLy8gYXR0YWNoIGNoYW5nZWQkIHRvIGV2ZW50aGFuZGxlclxuICAgICAgICBFSEluc3RhbmNlLmNoYW5nZWQkID0gdGhpcy5jaGFuZ2VkJDtcbiAgICAgICAgLy8gbGlzdGVuIHRvIGlucHV0IGV2ZW50c1xuICAgICAgICBFSEluc3RhbmNlLmxpc3RlbigpO1xuICAgICAgICAvLyBzYXZlIGl0IHRvIGlucHV0XG4gICAgICAgIHRoaXMuaW5wdXRzW2lkXSA9IHtcbiAgICAgICAgICBkczogRFNJbnN0YW5jZSxcbiAgICAgICAgICBlaDogRUhJbnN0YW5jZSxcbiAgICAgICAgICBlbWl0OiAodDogc3RyaW5nLCBwOiBhbnkpID0+IEVISW5zdGFuY2UuZW1pdElubmVyKHQsIHApXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19