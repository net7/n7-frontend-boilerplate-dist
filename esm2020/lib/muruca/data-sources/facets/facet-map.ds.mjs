import { DataSource } from '@n7-frontend/core';
import 'leaflet.markercluster';
import { Subject } from 'rxjs';
const ACTIVE_CLASS = 'is-active';
export class FacetMapDS extends DataSource {
    constructor() {
        super(...arguments);
        this.value = [];
        this.markerEvents$ = new Subject();
        this.isUpdate = false;
        this.iconSize = this.options.libOptions.iconSize ?? [13, 20];
        this.MARKER_ICON = L.icon({
            iconUrl: '/assets/pin.png',
            iconSize: this.iconSize,
            popupAnchor: [0, -15],
            className: 'marker-icon'
        });
        this.MARKER_ICON_UNAVAILABLE = L.icon({
            iconUrl: '/assets/pin-unavailable.png',
            iconSize: this.iconSize,
            popupAnchor: [0, -15],
            className: 'marker-icon'
        });
        this.MARKER_ICON_SELECTED = L.icon({
            iconUrl: '/assets/pin-selected.png',
            iconSize: this.iconSize,
            popupAnchor: [0, -15],
            className: 'marker-icon-selected'
        });
        this.getIcon = (id, counter) => {
            if (this.value.includes(id))
                return this.MARKER_ICON_SELECTED;
            if (counter > 0)
                return this.MARKER_ICON;
            return this.MARKER_ICON_UNAVAILABLE;
        };
        this.getZindex = (id, counter) => {
            if (this.value.includes(id))
                return 19999;
            if (counter > 0)
                return 9999;
            return null;
        };
        this.getValue = () => this.value;
    }
    transform({ links }) {
        const markers = [];
        links
            .filter((d) => d.args?.lat && d.args?.lon)
            .forEach((d) => {
            // if a link has more than one corresponding marker
            if (Array.isArray(d.args.lat)) {
                d.args.lat.forEach((element, i) => {
                    markers.push({
                        coords: [+d.args.lat[i], +d.args.lon[i]],
                        template: d.text,
                        title: d.text,
                        id: d.payload,
                        slug: d.payload,
                        counter: d.counter,
                    });
                });
            }
            else {
                // if a link has only one marker
                markers.push({
                    coords: [+d.args.lat, +d.args.lon],
                    template: d.text,
                    title: d.text,
                    id: d.payload,
                    slug: d.payload,
                    counter: d.counter,
                });
            }
        });
        const mapConfig = this.options?.libOptions;
        return {
            containerId: 'map-canvas',
            libOptions: {
                attributionControl: false,
                minZoom: mapConfig.minZoom ?? 8,
                maxZoom: mapConfig.maxZoom ?? undefined,
                maxBounds: [[46.8505, 10.3393], [45.6635, 12.2429]]
            },
            tileLayers: [{
                    // url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    url: mapConfig.layerUrl ?? 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png',
                    // url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
                    options: null
                }],
            initialView: {
                center: mapConfig.center ?? [46.06, 11.21],
                zoom: mapConfig.zoom ?? 9
            },
            _setInstance: (map) => {
                this.mapInstance = map;
                this.buildMarkers(markers);
            },
        };
    }
    /**
     * Builds markers with a custom icon and adds them to the map.
     * @param markers an array of markers
     */
    buildMarkers(markers) {
        if (!markers)
            return;
        const mapConfig = this.options?.libOptions;
        // remove all existing markers
        if (this.markerLayer) {
            this.markerLayer.clearLayers();
            this.mapInstance.removeLayer(this.markerLayer);
        }
        const markerGroup = L.markerClusterGroup({
            maxClusterRadius: mapConfig.maxClusterRadius ?? 10,
            disableClusteringAtZoom: mapConfig.disableClusteringAtZoom ?? 8
        });
        markers.forEach(({ coords, template, id, slug, counter }) => {
            // create custom icon marker
            const newMarker = L.marker(coords, {
                icon: this.getIcon(id, counter),
                zIndexOffset: this.getZindex(id, counter)
            });
            if (id && slug) {
                newMarker.id = id;
                newMarker.counter = counter;
                newMarker.slug = slug;
            }
            newMarker
                // add the marker to the group
                .addTo(markerGroup)
                // add the on-click tooltip
                .bindPopup(template);
            newMarker.on('click', ({ target }) => {
                this.markerEvents$.next({
                    type: 'marker.click',
                    id: target.id
                });
            });
            newMarker.on('mouseover', ({ target }) => {
                target.openPopup();
            });
            newMarker.on('mouseout', ({ target }) => {
                target.closePopup();
            });
        });
        // add the markers to the map instance
        this.mapInstance.addLayer(markerGroup);
        // update the marker layer instance
        this.markerLayer = markerGroup;
    }
    setValue(value, update = false) {
        // prevent the search service from assigning a plain string
        // eslint-disable-next-line no-param-reassign
        if (typeof value === 'string')
            value = [value];
        if (this.value !== value) {
            this.value = value;
        }
        this.isUpdate = update || this.value === [];
        if (update && this.input) {
            const { links } = this.input;
            const updatedLinks = links.map((link) => ({
                ...link,
                classes: this.value.includes(link.payload) ? ACTIVE_CLASS : ''
            }));
            // update marker icons
            if (this.markerLayer) {
                this.markerLayer.eachLayer((marker) => {
                    const { id } = marker;
                    const counter = links.find(({ payload }) => payload === id)?.counter || 0;
                    marker.getPopup()._source.setIcon(this.getIcon(id, counter))
                        .setZIndexOffset(this.getZindex(id, counter));
                });
            }
            // ---
            this.update({
                ...this.input,
                links: updatedLinks
            });
        }
    }
    toggleValue(value) {
        const exists = this.value.includes(value);
        if (!exists) {
            this.value.push(value);
        }
        else if (exists) {
            this.value.splice(this.value.indexOf(value), 1);
        }
        // update
        this.setValue(this.value, true);
    }
    clear() {
        this.value = [];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjZXQtbWFwLmRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbjctYm9pbGVycGxhdGUtbGliL3NyYy9saWIvbXVydWNhL2RhdGEtc291cmNlcy9mYWNldHMvZmFjZXQtbWFwLmRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUvQyxPQUFPLHVCQUF1QixDQUFDO0FBQy9CLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFNL0IsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDO0FBeUJqQyxNQUFNLE9BQU8sVUFBVyxTQUFRLFVBQVU7SUFBMUM7O1FBR0UsVUFBSyxHQUFnQixFQUFFLENBQUM7UUFNeEIsa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO1FBRTNDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFFakIsYUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVoRCxnQkFBVyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDM0IsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3JCLFNBQVMsRUFBRSxhQUFhO1NBQ3pCLENBQUMsQ0FBQztRQUVLLDRCQUF1QixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDdkMsT0FBTyxFQUFFLDZCQUE2QjtZQUN0QyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3JCLFNBQVMsRUFBRSxhQUFhO1NBQ3pCLENBQUMsQ0FBQztRQUVLLHlCQUFv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SUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBSUQsS0FBSztRQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ2xCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICdAbjctZnJvbnRlbmQvY29yZSc7XG5pbXBvcnQgeyBNYXBEYXRhLCBNYXJrZXJEYXRhIH0gZnJvbSAnQG43LWZyb250ZW5kL2NvbXBvbmVudHMnO1xuaW1wb3J0ICdsZWFmbGV0Lm1hcmtlcmNsdXN0ZXInO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRmFjZXREYXRhU291cmNlIH0gZnJvbSAnLi9mYWNldC1kYXRhc291cmNlJztcbi8vIGxlYWZsZXQgaXMgYWxyZWFkeSBwcmVzZW50IGluIHRoZSB3aW5kb3csXG4vLyBhIGRvdWJsZSBpbXBvcnQgcmVzdWx0cyBpbiBlcnJvcnMgd2l0aCB0b29sdGlwcy5cbmRlY2xhcmUgY29uc3QgTDtcblxuY29uc3QgQUNUSVZFX0NMQVNTID0gJ2lzLWFjdGl2ZSc7XG5cbnR5cGUgRkFDRVRfVkFMVUUgPSBzdHJpbmdbXTtcblxudHlwZSBDYWRhc3RyYWxVbml0ID0ge1xuICB0ZXh0OiBzdHJpbmc7XG4gIHBheWxvYWQ6IHN0cmluZztcbiAgY291bnRlcjogbnVtYmVyO1xuICBhcmdzOiB7XG4gICAgbGF0OiBzdHJpbmcgfCBudWxsO1xuICAgIGxvbjogc3RyaW5nIHwgbnVsbDtcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBNYXJrZXJFdmVudCB7XG4gIHR5cGU6IHN0cmluZztcbiAgaWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE1hcmtlcldpdGhJRCBleHRlbmRzIE1hcmtlckRhdGEge1xuICBpZD86IHN0cmluZztcbiAgY291bnRlcjogbnVtYmVyO1xuICBzbHVnOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBGYWNldE1hcERTIGV4dGVuZHMgRGF0YVNvdXJjZSBpbXBsZW1lbnRzIEZhY2V0RGF0YVNvdXJjZSB7XG4gIGlkOiBzdHJpbmc7XG5cbiAgdmFsdWU6IEZBQ0VUX1ZBTFVFID0gW107XG5cbiAgbWFwSW5zdGFuY2U7XG5cbiAgbWFya2VyTGF5ZXI7XG5cbiAgbWFya2VyRXZlbnRzJCA9IG5ldyBTdWJqZWN0PE1hcmtlckV2ZW50PigpO1xuXG4gIGlzVXBkYXRlID0gZmFsc2U7XG5cbiAgaWNvblNpemUgPSB0aGlzLm9wdGlvbnMubGliT3B0aW9ucy5pY29uU2l6ZSA/PyBbMTMsIDIwXTtcblxuICBwcml2YXRlIE1BUktFUl9JQ09OID0gTC5pY29uKHtcbiAgICBpY29uVXJsOiAnL2Fzc2V0cy9waW4ucG5nJyxcbiAgICBpY29uU2l6ZTogdGhpcy5pY29uU2l6ZSxcbiAgICBwb3B1cEFuY2hvcjogWzAsIC0xNV0sXG4gICAgY2xhc3NOYW1lOiAnbWFya2VyLWljb24nXG4gIH0pO1xuXG4gIHByaXZhdGUgTUFSS0VSX0lDT05fVU5BVkFJTEFCTEUgPSBMLmljb24oe1xuICAgIGljb25Vcmw6ICcvYXNzZXRzL3Bpbi11bmF2YWlsYWJsZS5wbmcnLFxuICAgIGljb25TaXplOiB0aGlzLmljb25TaXplLFxuICAgIHBvcHVwQW5jaG9yOiBbMCwgLTE1XSxcbiAgICBjbGFzc05hbWU6ICdtYXJrZXItaWNvbidcbiAgfSk7XG5cbiAgcHJpdmF0ZSBNQVJLRVJfSUNPTl9TRUxFQ1RFRCA9IEwuaWNvbih7XG4gICAgaWNvblVybDogJy9hc3NldHMvcGluLXNlbGVjdGVkLnBuZycsXG4gICAgaWNvblNpemU6IHRoaXMuaWNvblNpemUsXG4gICAgcG9wdXBBbmNob3I6IFswLCAtMTVdLFxuICAgIGNsYXNzTmFtZTogJ21hcmtlci1pY29uLXNlbGVjdGVkJ1xuICB9KTtcblxuICBwcm90ZWN0ZWQgdHJhbnNmb3JtKHsgbGlua3MgfTogeyBsaW5rczogQ2FkYXN0cmFsVW5pdFtdIH0pOiBNYXBEYXRhIHtcbiAgICBjb25zdCBtYXJrZXJzID0gW107XG4gICAgbGlua3NcbiAgICAgIC5maWx0ZXIoKGQpID0+IGQuYXJncz8ubGF0ICYmIGQuYXJncz8ubG9uKVxuICAgICAgLmZvckVhY2goKGQpID0+IHtcbiAgICAgICAgLy8gaWYgYSBsaW5rIGhhcyBtb3JlIHRoYW4gb25lIGNvcnJlc3BvbmRpbmcgbWFya2VyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGQuYXJncy5sYXQpKSB7XG4gICAgICAgICAgZC5hcmdzLmxhdC5mb3JFYWNoKChlbGVtZW50LCBpKSA9PiB7XG4gICAgICAgICAgICBtYXJrZXJzLnB1c2goe1xuICAgICAgICAgICAgICBjb29yZHM6IFsrZC5hcmdzLmxhdFtpXSwgK2QuYXJncy5sb25baV1dIGFzIFtudW1iZXIsIG51bWJlcl0sXG4gICAgICAgICAgICAgIHRlbXBsYXRlOiBkLnRleHQsXG4gICAgICAgICAgICAgIHRpdGxlOiBkLnRleHQsXG4gICAgICAgICAgICAgIGlkOiBkLnBheWxvYWQsXG4gICAgICAgICAgICAgIHNsdWc6IGQucGF5bG9hZCxcbiAgICAgICAgICAgICAgY291bnRlcjogZC5jb3VudGVyLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gaWYgYSBsaW5rIGhhcyBvbmx5IG9uZSBtYXJrZXJcbiAgICAgICAgICBtYXJrZXJzLnB1c2goe1xuICAgICAgICAgICAgY29vcmRzOiBbK2QuYXJncy5sYXQsICtkLmFyZ3MubG9uXSBhcyBbbnVtYmVyLCBudW1iZXJdLFxuICAgICAgICAgICAgdGVtcGxhdGU6IGQudGV4dCxcbiAgICAgICAgICAgIHRpdGxlOiBkLnRleHQsXG4gICAgICAgICAgICBpZDogZC5wYXlsb2FkLFxuICAgICAgICAgICAgc2x1ZzogZC5wYXlsb2FkLFxuICAgICAgICAgICAgY291bnRlcjogZC5jb3VudGVyLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICBjb25zdCBtYXBDb25maWcgPSB0aGlzLm9wdGlvbnM/LmxpYk9wdGlvbnM7XG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbnRhaW5lcklkOiAnbWFwLWNhbnZhcycsXG4gICAgICBsaWJPcHRpb25zOiB7XG4gICAgICAgIGF0dHJpYnV0aW9uQ29udHJvbDogZmFsc2UsXG4gICAgICAgIG1pblpvb206IG1hcENvbmZpZy5taW5ab29tID8/IDgsXG4gICAgICAgIG1heFpvb206IG1hcENvbmZpZy5tYXhab29tID8/IHVuZGVmaW5lZCxcbiAgICAgICAgbWF4Qm91bmRzOiBbWzQ2Ljg1MDUsIDEwLjMzOTNdLCBbNDUuNjYzNSwgMTIuMjQyOV1dXG4gICAgICB9LFxuICAgICAgdGlsZUxheWVyczogW3tcbiAgICAgICAgLy8gdXJsOiAnaHR0cHM6Ly97c30udGlsZS5vcGVuc3RyZWV0bWFwLm9yZy97en0ve3h9L3t5fS5wbmcnLFxuICAgICAgICB1cmw6IG1hcENvbmZpZy5sYXllclVybCA/PyAnaHR0cHM6Ly97c30uYmFzZW1hcHMuY2FydG9jZG4uY29tL3Jhc3RlcnRpbGVzL3ZveWFnZXJfbGFiZWxzX3VuZGVyL3t6fS97eH0ve3l9e3J9LnBuZycsXG4gICAgICAgIC8vIHVybDogJ2h0dHBzOi8vY2FydG9kYi1iYXNlbWFwcy17c30uZ2xvYmFsLnNzbC5mYXN0bHkubmV0L2xpZ2h0X2FsbC97en0ve3h9L3t5fS5wbmcnLFxuICAgICAgICBvcHRpb25zOiBudWxsXG4gICAgICB9XSxcbiAgICAgIGluaXRpYWxWaWV3OiB7XG4gICAgICAgIGNlbnRlcjogbWFwQ29uZmlnLmNlbnRlciA/PyBbNDYuMDYsIDExLjIxXSxcbiAgICAgICAgem9vbTogbWFwQ29uZmlnLnpvb20gPz8gOVxuICAgICAgfSxcbiAgICAgIF9zZXRJbnN0YW5jZTogKG1hcCkgPT4ge1xuICAgICAgICB0aGlzLm1hcEluc3RhbmNlID0gbWFwO1xuICAgICAgICB0aGlzLmJ1aWxkTWFya2VycyhtYXJrZXJzKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZHMgbWFya2VycyB3aXRoIGEgY3VzdG9tIGljb24gYW5kIGFkZHMgdGhlbSB0byB0aGUgbWFwLlxuICAgKiBAcGFyYW0gbWFya2VycyBhbiBhcnJheSBvZiBtYXJrZXJzXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkTWFya2VycyhtYXJrZXJzOiBNYXJrZXJXaXRoSURbXSkge1xuICAgIGlmICghbWFya2VycykgcmV0dXJuO1xuICAgIGNvbnN0IG1hcENvbmZpZyA9IHRoaXMub3B0aW9ucz8ubGliT3B0aW9ucztcbiAgICAvLyByZW1vdmUgYWxsIGV4aXN0aW5nIG1hcmtlcnNcbiAgICBpZiAodGhpcy5tYXJrZXJMYXllcikge1xuICAgICAgdGhpcy5tYXJrZXJMYXllci5jbGVhckxheWVycygpO1xuICAgICAgdGhpcy5tYXBJbnN0YW5jZS5yZW1vdmVMYXllcih0aGlzLm1hcmtlckxheWVyKTtcbiAgICB9XG4gICAgY29uc3QgbWFya2VyR3JvdXAgPSBMLm1hcmtlckNsdXN0ZXJHcm91cChcbiAgICAgIHtcbiAgICAgICAgbWF4Q2x1c3RlclJhZGl1czogbWFwQ29uZmlnLm1heENsdXN0ZXJSYWRpdXMgPz8gMTAsXG4gICAgICAgIGRpc2FibGVDbHVzdGVyaW5nQXRab29tOiBtYXBDb25maWcuZGlzYWJsZUNsdXN0ZXJpbmdBdFpvb20gPz8gOFxuICAgICAgfVxuICAgICk7XG4gICAgbWFya2Vycy5mb3JFYWNoKCh7XG4gICAgICBjb29yZHMsIHRlbXBsYXRlLCBpZCwgc2x1ZywgY291bnRlclxuICAgIH0pID0+IHtcbiAgICAgIC8vIGNyZWF0ZSBjdXN0b20gaWNvbiBtYXJrZXJcbiAgICAgIGNvbnN0IG5ld01hcmtlciA9IEwubWFya2VyKGNvb3Jkcywge1xuICAgICAgICBpY29uOiB0aGlzLmdldEljb24oaWQsIGNvdW50ZXIpLFxuICAgICAgICB6SW5kZXhPZmZzZXQ6IHRoaXMuZ2V0WmluZGV4KGlkLCBjb3VudGVyKVxuICAgICAgfSk7XG4gICAgICBpZiAoaWQgJiYgc2x1Zykge1xuICAgICAgICBuZXdNYXJrZXIuaWQgPSBpZDtcbiAgICAgICAgbmV3TWFya2VyLmNvdW50ZXIgPSBjb3VudGVyO1xuICAgICAgICBuZXdNYXJrZXIuc2x1ZyA9IHNsdWc7XG4gICAgICB9XG4gICAgICBuZXdNYXJrZXJcbiAgICAgICAgLy8gYWRkIHRoZSBtYXJrZXIgdG8gdGhlIGdyb3VwXG4gICAgICAgIC5hZGRUbyhtYXJrZXJHcm91cClcbiAgICAgICAgLy8gYWRkIHRoZSBvbi1jbGljayB0b29sdGlwXG4gICAgICAgIC5iaW5kUG9wdXAodGVtcGxhdGUpO1xuXG4gICAgICBuZXdNYXJrZXIub24oJ2NsaWNrJywgKHsgdGFyZ2V0IH0pID0+IHtcbiAgICAgICAgdGhpcy5tYXJrZXJFdmVudHMkLm5leHQoe1xuICAgICAgICAgIHR5cGU6ICdtYXJrZXIuY2xpY2snLFxuICAgICAgICAgIGlkOiB0YXJnZXQuaWRcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgbmV3TWFya2VyLm9uKCdtb3VzZW92ZXInLCAoeyB0YXJnZXQgfSkgPT4ge1xuICAgICAgICB0YXJnZXQub3BlblBvcHVwKCk7XG4gICAgICB9KTtcblxuICAgICAgbmV3TWFya2VyLm9uKCdtb3VzZW91dCcsICh7IHRhcmdldCB9KSA9PiB7XG4gICAgICAgIHRhcmdldC5jbG9zZVBvcHVwKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICAvLyBhZGQgdGhlIG1hcmtlcnMgdG8gdGhlIG1hcCBpbnN0YW5jZVxuICAgIHRoaXMubWFwSW5zdGFuY2UuYWRkTGF5ZXIobWFya2VyR3JvdXApO1xuICAgIC8vIHVwZGF0ZSB0aGUgbWFya2VyIGxheWVyIGluc3RhbmNlXG4gICAgdGhpcy5tYXJrZXJMYXllciA9IG1hcmtlckdyb3VwO1xuICB9XG5cbiAgc2V0VmFsdWUodmFsdWU6IEZBQ0VUX1ZBTFVFLCB1cGRhdGUgPSBmYWxzZSkge1xuICAgIC8vIHByZXZlbnQgdGhlIHNlYXJjaCBzZXJ2aWNlIGZyb20gYXNzaWduaW5nIGEgcGxhaW4gc3RyaW5nXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXBhcmFtLXJlYXNzaWduXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHZhbHVlID0gW3ZhbHVlXTtcblxuICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkge1xuICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgIH1cbiAgICB0aGlzLmlzVXBkYXRlID0gdXBkYXRlIHx8IHRoaXMudmFsdWUgPT09IFtdO1xuXG4gICAgaWYgKHVwZGF0ZSAmJiB0aGlzLmlucHV0KSB7XG4gICAgICBjb25zdCB7IGxpbmtzIH0gPSB0aGlzLmlucHV0O1xuICAgICAgY29uc3QgdXBkYXRlZExpbmtzID0gbGlua3MubWFwKChsaW5rOiBDYWRhc3RyYWxVbml0KSA9PiAoe1xuICAgICAgICAuLi5saW5rLFxuICAgICAgICBjbGFzc2VzOiB0aGlzLnZhbHVlLmluY2x1ZGVzKGxpbmsucGF5bG9hZCkgPyBBQ1RJVkVfQ0xBU1MgOiAnJ1xuICAgICAgfSkpO1xuICAgICAgLy8gdXBkYXRlIG1hcmtlciBpY29uc1xuICAgICAgaWYgKHRoaXMubWFya2VyTGF5ZXIpIHtcbiAgICAgICAgdGhpcy5tYXJrZXJMYXllci5lYWNoTGF5ZXIoKG1hcmtlcikgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgaWQgfSA9IG1hcmtlcjtcbiAgICAgICAgICBjb25zdCBjb3VudGVyID0gbGlua3MuZmluZCgoeyBwYXlsb2FkIH0pID0+IHBheWxvYWQgPT09IGlkKT8uY291bnRlciB8fCAwO1xuICAgICAgICAgIG1hcmtlci5nZXRQb3B1cCgpLl9zb3VyY2Uuc2V0SWNvbih0aGlzLmdldEljb24oaWQsIGNvdW50ZXIpKVxuICAgICAgICAgICAgLnNldFpJbmRleE9mZnNldCh0aGlzLmdldFppbmRleChpZCwgY291bnRlcikpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIC8vIC0tLVxuICAgICAgdGhpcy51cGRhdGUoe1xuICAgICAgICAuLi50aGlzLmlucHV0LFxuICAgICAgICBsaW5rczogdXBkYXRlZExpbmtzXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBnZXRJY29uID0gKGlkOiBzdHJpbmcsIGNvdW50ZXI6IG51bWJlcikgPT4ge1xuICAgIGlmICh0aGlzLnZhbHVlLmluY2x1ZGVzKGlkKSkgcmV0dXJuIHRoaXMuTUFSS0VSX0lDT05fU0VMRUNURUQ7XG4gICAgaWYgKGNvdW50ZXIgPiAwKSByZXR1cm4gdGhpcy5NQVJLRVJfSUNPTjtcbiAgICByZXR1cm4gdGhpcy5NQVJLRVJfSUNPTl9VTkFWQUlMQUJMRTtcbiAgfVxuXG4gIGdldFppbmRleCA9IChpZDogc3RyaW5nLCBjb3VudGVyOiBudW1iZXIpID0+IHtcbiAgICBpZiAodGhpcy52YWx1ZS5pbmNsdWRlcyhpZCkpIHJldHVybiAxOTk5OTtcbiAgICBpZiAoY291bnRlciA+IDApIHJldHVybiA5OTk5O1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdG9nZ2xlVmFsdWUodmFsdWU6IHN0cmluZykge1xuICAgIGNvbnN0IGV4aXN0cyA9IHRoaXMudmFsdWUuaW5jbHVkZXModmFsdWUpO1xuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0aGlzLnZhbHVlLnB1c2godmFsdWUpO1xuICAgIH0gZWxzZSBpZiAoZXhpc3RzKSB7XG4gICAgICB0aGlzLnZhbHVlLnNwbGljZSh0aGlzLnZhbHVlLmluZGV4T2YodmFsdWUpLCAxKTtcbiAgICB9XG5cbiAgICAvLyB1cGRhdGVcbiAgICB0aGlzLnNldFZhbHVlKHRoaXMudmFsdWUsIHRydWUpO1xuICB9XG5cbiAgZ2V0VmFsdWUgPSAoKTogRkFDRVRfVkFMVUUgPT4gdGhpcy52YWx1ZTtcblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnZhbHVlID0gW107XG4gIH1cbn1cbiJdfQ==