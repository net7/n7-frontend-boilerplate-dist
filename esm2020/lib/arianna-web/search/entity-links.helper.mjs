import { Subject, merge, fromEvent } from 'rxjs';
import { debounceTime, switchMap, mapTo } from 'rxjs/operators';
// import { isEmpty } from 'lodash';
const ENTITY_LINKS_CLASS = 'entity-links';
const ENTITY_LINKS_PARENT_SELECTOR = '.n7-facets-wrapper__group:last-child .n7-facet__section-input-links';
const loaderItem = {
    counter: null,
    label: 'Caricamento in corso...',
    searchData: [],
    value: '__loading__',
};
export default {
    paginationState: {},
    paginate$: new Subject(),
    listenToChanges(dataSource) {
        const facetsWrapperEH = dataSource.getWidgetEventHandler('facets-wrapper');
        return merge(facetsWrapperEH.internalFacetsChange$.pipe(mapTo(null)), this.paginate$).pipe(debounceTime(500), switchMap((pagination) => {
            const requestParams = dataSource.searchModel.getRequestParams();
            const internalFilters = dataSource.searchModel.getInternalFilters();
            this.paginationState.offset = pagination ? this.paginationState.offset : 0;
            this.updateParamsOffset(requestParams);
            const filters = [...requestParams.filters, ...internalFilters];
            const params = {
                searchParameters: {
                    totalCount: 100,
                    gallery: !!(dataSource.searchModel.getId() === 'aw-gallery-layout'),
                    ...requestParams,
                    filters
                },
            };
            // initial loader
            if (this.paginationState.offset === 0) {
                this.addInitialLoader(dataSource);
            }
            return dataSource.getFacetsReq$(params);
        }));
    },
    onFacetsResponse(searchModel, facets) {
        // pagination control
        const entityLinksFacet = facets.find(({ id }) => id === ENTITY_LINKS_CLASS);
        const { totalCount } = entityLinksFacet;
        let { limit, offset } = this.paginationState;
        if (typeof limit === 'undefined') {
            limit = 10;
        }
        if (typeof offset === 'undefined') {
            offset = 0;
        }
        this.paginationState.totalCount = totalCount;
        if (offset > 0) {
            const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
            const oldData = entityLinksInput.getData() || [];
            // remove fake loading element
            if (oldData.length) {
                oldData.pop();
            }
            const newData = oldData.concat(entityLinksFacet.data);
            entityLinksFacet.data = newData;
        }
        if (this.paginationState.totalCount > (limit + offset)) {
            entityLinksFacet.data.push(loaderItem);
        }
        // empty state
        const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
        entityLinksInput.setIsEmpty(!totalCount);
        // fix scroll
        if (offset === 0) {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            if (scrollEl) {
                scrollEl.scrollTop = 0;
            }
        }
        // update loading state
        this.paginationState.loading = false;
    },
    initPagination(searchModel) {
        searchModel.getFilters().filter((filter) => (filter.pagination)).forEach(({ pagination }) => {
            this.paginationState = {
                ...pagination,
                ...this.paginationState,
                loading: false
            };
        });
        setTimeout(() => {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            const scroll$ = fromEvent(scrollEl, 'scroll');
            scroll$.pipe(debounceTime(300)).subscribe(({ target }) => {
                const { scrollTop, clientHeight, scrollHeight } = target;
                const { offset, limit, totalCount, loading } = this.paginationState;
                const margin = 150;
                if ((scrollTop + clientHeight >= scrollHeight - margin)
                    && (offset + limit < totalCount)
                    && loading === false) {
                    this.paginationState.loading = true;
                    this.paginationState.offset = offset + limit;
                    this.paginate$.next(this.paginationState);
                }
            });
        });
    },
    /* clearInternalFilters(searchModel) {
      const searchFilter = searchModel.getFiltersByFacetId('entity-search')[0];
      const typesFilter = searchModel.getFiltersByFacetId('entity-types')[0];
      if (!isEmpty(searchFilter.value) || !isEmpty(typesFilter.value)) {
        searchFilter.value = '';
        typesFilter.value = [];
        searchModel.updateInputsFromFilters();
      }
    }, */
    updateParamsOffset(params) {
        const entityLinksFilter = params.filters
            .find(({ facetId }) => facetId === ENTITY_LINKS_CLASS);
        if (entityLinksFilter) {
            entityLinksFilter.pagination.offset = this.paginationState.offset;
        }
    },
    resetOffset() {
        this.paginationState.offset = 0;
    },
    addInitialLoader(dataSource) {
        dataSource.searchModel.setInputData(ENTITY_LINKS_CLASS, [loaderItem]);
        const facetsWrapperDS = dataSource.getWidgetDataSource('facets-wrapper');
        facetsWrapperDS.updateInputLinks();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWxpbmtzLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL243LWJvaWxlcnBsYXRlLWxpYi9zcmMvbGliL2FyaWFubmEtd2ViL3NlYXJjaC9lbnRpdHktbGlua3MuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQ0wsWUFBWSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQy9CLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsb0NBQW9DO0FBRXBDLE1BQU0sa0JBQWtCLEdBQUcsY0FBYyxDQUFDO0FBQzFDLE1BQU0sNEJBQTRCLEdBQUcscUVBQXFFLENBQUM7QUFFM0csTUFBTSxVQUFVLEdBQUc7SUFDakIsT0FBTyxFQUFFLElBQUk7SUFDYixLQUFLLEVBQUUseUJBQXlCO0lBQ2hDLFVBQVUsRUFBRSxFQUFFO0lBQ2QsS0FBSyxFQUFFLGFBQWE7Q0FDckIsQ0FBQztBQUVGLGVBQWU7SUFDYixlQUFlLEVBQUUsRUFBUztJQUMxQixTQUFTLEVBQUUsSUFBSSxPQUFPLEVBQUU7SUFDeEIsZUFBZSxDQUFDLFVBQVU7UUFDeEIsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0UsT0FBTyxLQUFLLENBQ1YsZUFBZSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDdkQsSUFBSSxDQUFDLFNBQVMsQ0FDZixDQUFDLElBQUksQ0FDSixZQUFZLENBQUMsR0FBRyxDQUFDLEVBQ2pCLFNBQVMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ3ZCLE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNoRSxNQUFN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dUJBQzdCLE9BQU8sS0FBSyxLQUFLLEVBQ3BCO29CQUNBLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztvQkFDcEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsTUFBTSxHQUFHLEtBQUssQ0FBQztvQkFDN0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2lCQUMzQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7Ozs7Ozs7O1NBUUs7SUFDTCxrQkFBa0IsQ0FBQyxNQUFNO1FBQ3ZCLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLE9BQU87YUFDckMsSUFBSSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsT0FBTyxLQUFLLGtCQUFrQixDQUFDLENBQUM7UUFFekQsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixpQkFBaUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO1NBQ25FO0lBQ0gsQ0FBQztJQUNELFdBQVc7UUFDVCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUNELGdCQUFnQixDQUFDLFVBQVU7UUFDekIsVUFBVSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3pFLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ3JDLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgbWVyZ2UsIGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAsIG1hcFRvXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbi8vIGltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICdsb2Rhc2gnO1xuXG5jb25zdCBFTlRJVFlfTElOS1NfQ0xBU1MgPSAnZW50aXR5LWxpbmtzJztcbmNvbnN0IEVOVElUWV9MSU5LU19QQVJFTlRfU0VMRUNUT1IgPSAnLm43LWZhY2V0cy13cmFwcGVyX19ncm91cDpsYXN0LWNoaWxkIC5uNy1mYWNldF9fc2VjdGlvbi1pbnB1dC1saW5rcyc7XG5cbmNvbnN0IGxvYWRlckl0ZW0gPSB7XG4gIGNvdW50ZXI6IG51bGwsXG4gIGxhYmVsOiAnQ2FyaWNhbWVudG8gaW4gY29yc28uLi4nLFxuICBzZWFyY2hEYXRhOiBbXSxcbiAgdmFsdWU6ICdfX2xvYWRpbmdfXycsXG59O1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gIHBhZ2luYXRpb25TdGF0ZToge30gYXMgYW55LFxuICBwYWdpbmF0ZSQ6IG5ldyBTdWJqZWN0KCksXG4gIGxpc3RlblRvQ2hhbmdlcyhkYXRhU291cmNlKSB7XG4gICAgY29uc3QgZmFjZXRzV3JhcHBlckVIID0gZGF0YVNvdXJjZS5nZXRXaWRnZXRFdmVudEhhbmRsZXIoJ2ZhY2V0cy13cmFwcGVyJyk7XG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgZmFjZXRzV3JhcHBlckVILmludGVybmFsRmFjZXRzQ2hhbmdlJC5waXBlKG1hcFRvKG51bGwpKSxcbiAgICAgIHRoaXMucGFnaW5hdGUkLFxuICAgICkucGlwZShcbiAgICAgIGRlYm91bmNlVGltZSg1MDApLFxuICAgICAgc3dpdGNoTWFwKChwYWdpbmF0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RQYXJhbXMgPSBkYXRhU291cmNlLnNlYXJjaE1vZGVsLmdldFJlcXVlc3RQYXJhbXMoKTtcbiAgICAgICAgY29uc3QgaW50ZXJuYWxGaWx0ZXJzID0gZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5nZXRJbnRlcm5hbEZpbHRlcnMoKTtcbiAgICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0ID0gcGFnaW5hdGlvbiA/IHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA6IDA7XG4gICAgICAgIHRoaXMudXBkYXRlUGFyYW1zT2Zmc2V0KHJlcXVlc3RQYXJhbXMpO1xuICAgICAgICBjb25zdCBmaWx0ZXJzID0gWy4uLnJlcXVlc3RQYXJhbXMuZmlsdGVycywgLi4uaW50ZXJuYWxGaWx0ZXJzXTtcbiAgICAgICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgICAgIHNlYXJjaFBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIHRvdGFsQ291bnQ6IDEwMCxcbiAgICAgICAgICAgIGdhbGxlcnk6ICEhKGRhdGFTb3VyY2Uuc2VhcmNoTW9kZWwuZ2V0SWQoKSA9PT0gJ2F3LWdhbGxlcnktbGF5b3V0JyksXG4gICAgICAgICAgICAuLi5yZXF1ZXN0UGFyYW1zLFxuICAgICAgICAgICAgZmlsdGVyc1xuICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gaW5pdGlhbCBsb2FkZXJcbiAgICAgICAgaWYgKHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMuYWRkSW5pdGlhbExvYWRlcihkYXRhU291cmNlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkYXRhU291cmNlLmdldEZhY2V0c1JlcSQocGFyYW1zKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfSxcbiAgb25GYWNldHNSZXNwb25zZShzZWFyY2hNb2RlbCwgZmFjZXRzKSB7XG4gICAgLy8gcGFnaW5hdGlvbiBjb250cm9sXG4gICAgY29uc3QgZW50aXR5TGlua3NGYWNldCA9IGZhY2V0cy5maW5kKCh7IGlkIH0pID0+IGlkID09PSBFTlRJVFlfTElOS1NfQ0xBU1MpO1xuICAgIGNvbnN0IHsgdG90YWxDb3VudCB9ID0gZW50aXR5TGlua3NGYWNldDtcbiAgICBsZXQgeyBsaW1pdCwgb2Zmc2V0IH0gPSB0aGlzLnBhZ2luYXRpb25TdGF0ZTtcbiAgICBpZiAodHlwZW9mIGxpbWl0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgbGltaXQgPSAxMDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBvZmZzZXQgPSAwO1xuICAgIH1cbiAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS50b3RhbENvdW50ID0gdG90YWxDb3VudDtcbiAgICBpZiAob2Zmc2V0ID4gMCkge1xuICAgICAgY29uc3QgZW50aXR5TGlua3NJbnB1dCA9IHNlYXJjaE1vZGVsLmdldElucHV0QnlGYWNldElkKEVOVElUWV9MSU5LU19DTEFTUyk7XG4gICAgICBjb25zdCBvbGREYXRhID0gZW50aXR5TGlua3NJbnB1dC5nZXREYXRhKCkgfHwgW107XG4gICAgICAvLyByZW1vdmUgZmFrZSBsb2FkaW5nIGVsZW1lbnRcbiAgICAgIGlmIChvbGREYXRhLmxlbmd0aCkge1xuICAgICAgICBvbGREYXRhLnBvcCgpO1xuICAgICAgfVxuICAgICAgY29uc3QgbmV3RGF0YSA9IG9sZERhdGEuY29uY2F0KGVudGl0eUxpbmtzRmFjZXQuZGF0YSk7XG4gICAgICBlbnRpdHlMaW5rc0ZhY2V0LmRhdGEgPSBuZXdEYXRhO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhZ2luYXRpb25TdGF0ZS50b3RhbENvdW50ID4gKGxpbWl0ICsgb2Zmc2V0KSkge1xuICAgICAgZW50aXR5TGlua3NGYWNldC5kYXRhLnB1c2gobG9hZGVySXRlbSk7XG4gICAgfVxuXG4gICAgLy8gZW1wdHkgc3RhdGVcbiAgICBjb25zdCBlbnRpdHlMaW5rc0lucHV0ID0gc2VhcmNoTW9kZWwuZ2V0SW5wdXRCeUZhY2V0SWQoRU5USVRZX0xJTktTX0NMQVNTKTtcbiAgICBlbnRpdHlMaW5rc0lucHV0LnNldElzRW1wdHkoIXRvdGFsQ291bnQpO1xuXG4gICAgLy8gZml4IHNjcm9sbFxuICAgIGlmIChvZmZzZXQgPT09IDApIHtcbiAgICAgIGNvbnN0IHNjcm9sbEVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihFTlRJVFlfTElOS1NfUEFSRU5UX1NFTEVDVE9SKTtcbiAgICAgIGlmIChzY3JvbGxFbCkge1xuICAgICAgICBzY3JvbGxFbC5zY3JvbGxUb3AgPSAwO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHVwZGF0ZSBsb2FkaW5nIHN0YXRlXG4gICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUubG9hZGluZyA9IGZhbHNlO1xuICB9LFxuICBpbml0UGFnaW5hdGlvbihzZWFyY2hNb2RlbCkge1xuICAgIHNlYXJjaE1vZGVsLmdldEZpbHRlcnMoKS5maWx0ZXIoKGZpbHRlcikgPT4gKFxuICAgICAgZmlsdGVyLnBhZ2luYXRpb25cbiAgICApKS5mb3JFYWNoKCh7IHBhZ2luYXRpb24gfSkgPT4ge1xuICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUgPSB7XG4gICAgICAgIC4uLnBhZ2luYXRpb24sXG4gICAgICAgIC4uLnRoaXMucGFnaW5hdGlvblN0YXRlLFxuICAgICAgICBsb2FkaW5nOiBmYWxzZVxuICAgICAgfTtcbiAgICB9KTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGNvbnN0IHNjcm9sbEVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihFTlRJVFlfTElOS1NfUEFSRU5UX1NFTEVDVE9SKTtcbiAgICAgIGNvbnN0IHNjcm9sbCQgPSBmcm9tRXZlbnQoc2Nyb2xsRWwsICdzY3JvbGwnKTtcbiAgICAgIHNjcm9sbCQucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMClcbiAgICAgICkuc3Vic2NyaWJlKCh7IHRhcmdldCB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHsgc2Nyb2xsVG9wLCBjbGllbnRIZWlnaHQsIHNjcm9sbEhlaWdodCB9ID0gdGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgb2Zmc2V0LCBsaW1pdCwgdG90YWxDb3VudCwgbG9hZGluZ1xuICAgICAgICB9ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGU7XG4gICAgICAgIGNvbnN0IG1hcmdpbiA9IDE1MDtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIChzY3JvbGxUb3AgKyBjbGllbnRIZWlnaHQgPj0gc2Nyb2xsSGVpZ2h0IC0gbWFyZ2luKVxuICAgICAgICAgICYmIChvZmZzZXQgKyBsaW1pdCA8IHRvdGFsQ291bnQpXG4gICAgICAgICAgJiYgbG9hZGluZyA9PT0gZmFsc2VcbiAgICAgICAgKSB7XG4gICAgICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUubG9hZGluZyA9IHRydWU7XG4gICAgICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0ID0gb2Zmc2V0ICsgbGltaXQ7XG4gICAgICAgICAgdGhpcy5wYWdpbmF0ZSQubmV4dCh0aGlzLnBhZ2luYXRpb25TdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9LFxuICAvKiBjbGVhckludGVybmFsRmlsdGVycyhzZWFyY2hNb2RlbCkge1xuICAgIGNvbnN0IHNlYXJjaEZpbHRlciA9IHNlYXJjaE1vZGVsLmdldEZpbHRlcnNCeUZhY2V0SWQoJ2VudGl0eS1zZWFyY2gnKVswXTtcbiAgICBjb25zdCB0eXBlc0ZpbHRlciA9IHNlYXJjaE1vZGVsLmdldEZpbHRlcnNCeUZhY2V0SWQoJ2VudGl0eS10eXBlcycpWzBdO1xuICAgIGlmICghaXNFbXB0eShzZWFyY2hGaWx0ZXIudmFsdWUpIHx8ICFpc0VtcHR5KHR5cGVzRmlsdGVyLnZhbHVlKSkge1xuICAgICAgc2VhcmNoRmlsdGVyLnZhbHVlID0gJyc7XG4gICAgICB0eXBlc0ZpbHRlci52YWx1ZSA9IFtdO1xuICAgICAgc2VhcmNoTW9kZWwudXBkYXRlSW5wdXRzRnJvbUZpbHRlcnMoKTtcbiAgICB9XG4gIH0sICovXG4gIHVwZGF0ZVBhcmFtc09mZnNldChwYXJhbXMpIHtcbiAgICBjb25zdCBlbnRpdHlMaW5rc0ZpbHRlciA9IHBhcmFtcy5maWx0ZXJzXG4gICAgICAuZmluZCgoeyBmYWNldElkIH0pID0+IGZhY2V0SWQgPT09IEVOVElUWV9MSU5LU19DTEFTUyk7XG5cbiAgICBpZiAoZW50aXR5TGlua3NGaWx0ZXIpIHtcbiAgICAgIGVudGl0eUxpbmtzRmlsdGVyLnBhZ2luYXRpb24ub2Zmc2V0ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0O1xuICAgIH1cbiAgfSxcbiAgcmVzZXRPZmZzZXQoKSB7XG4gICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0ID0gMDtcbiAgfSxcbiAgYWRkSW5pdGlhbExvYWRlcihkYXRhU291cmNlKSB7XG4gICAgZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5zZXRJbnB1dERhdGEoRU5USVRZX0xJTktTX0NMQVNTLCBbbG9hZGVySXRlbV0pO1xuICAgIGNvbnN0IGZhY2V0c1dyYXBwZXJEUyA9IGRhdGFTb3VyY2UuZ2V0V2lkZ2V0RGF0YVNvdXJjZSgnZmFjZXRzLXdyYXBwZXInKTtcbiAgICBmYWNldHNXcmFwcGVyRFMudXBkYXRlSW5wdXRMaW5rcygpO1xuICB9XG59O1xuIl19