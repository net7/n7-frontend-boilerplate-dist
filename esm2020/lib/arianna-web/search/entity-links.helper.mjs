import { Subject, merge, fromEvent } from 'rxjs';
import { debounceTime, switchMap, mapTo } from 'rxjs/operators';
// import { isEmpty } from 'lodash';
const ENTITY_LINKS_CLASS = 'entity-links';
const ENTITY_LINKS_PARENT_SELECTOR = '.n7-facets-wrapper__group:last-child .n7-facet__section-input-links';
const loaderItem = {
    counter: null,
    label: 'Caricamento in corso...',
    searchData: [],
    value: '__loading__',
};
export default {
    paginationState: {},
    paginate$: new Subject(),
    listenToChanges(dataSource) {
        const facetsWrapperEH = dataSource.getWidgetEventHandler('facets-wrapper');
        return merge(facetsWrapperEH.internalFacetsChange$.pipe(mapTo(null)), this.paginate$).pipe(debounceTime(500), switchMap((pagination) => {
            const requestParams = dataSource.searchModel.getRequestParams();
            const internalFilters = dataSource.searchModel.getInternalFilters();
            this.paginationState.offset = pagination ? this.paginationState.offset : 0;
            this.updateParamsOffset(requestParams);
            const filters = [...requestParams.filters, ...internalFilters];
            const params = {
                searchParameters: {
                    totalCount: 100,
                    gallery: !!(dataSource.searchModel.getId() === 'aw-gallery-layout'),
                    ...requestParams,
                    filters
                },
            };
            // initial loader
            if (this.paginationState.offset === 0) {
                this.addInitialLoader(dataSource);
            }
            return dataSource.getFacetsReq$(params);
        }));
    },
    onFacetsResponse(searchModel, facets) {
        // pagination control
        const entityLinksFacet = facets.find(({ id }) => id === ENTITY_LINKS_CLASS);
        const { totalCount } = entityLinksFacet;
        let { limit, offset } = this.paginationState;
        if (typeof limit === 'undefined') {
            limit = 10;
        }
        if (typeof offset === 'undefined') {
            offset = 0;
        }
        this.paginationState.totalCount = totalCount;
        if (offset > 0) {
            const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
            const oldData = entityLinksInput.getData() || [];
            // remove fake loading element
            if (oldData.length) {
                oldData.pop();
            }
            const newData = oldData.concat(entityLinksFacet.data);
            entityLinksFacet.data = newData;
        }
        if (this.paginationState.totalCount > (limit + offset)) {
            entityLinksFacet.data.push(loaderItem);
        }
        // empty state
        const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
        entityLinksInput.setIsEmpty(!totalCount);
        // fix scroll
        if (offset === 0) {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            if (scrollEl) {
                scrollEl.scrollTop = 0;
            }
        }
        // update loading state
        this.paginationState.loading = false;
    },
    initPagination(searchModel) {
        searchModel.getFilters().filter((filter) => (filter.pagination)).forEach(({ pagination }) => {
            this.paginationState = {
                ...pagination,
                ...this.paginationState,
                loading: false
            };
        });
        setTimeout(() => {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            const scroll$ = fromEvent(scrollEl, 'scroll');
            scroll$.pipe(debounceTime(300)).subscribe(({ target }) => {
                const { scrollTop, clientHeight, scrollHeight } = target;
                const { offset, limit, totalCount, loading } = this.paginationState;
                const margin = 150;
                if ((scrollTop + clientHeight >= scrollHeight - margin)
                    && (offset + limit < totalCount)
                    && loading === false) {
                    this.paginationState.loading = true;
                    this.paginationState.offset = offset + limit;
                    this.paginate$.next(this.paginationState);
                }
            });
        });
    },
    /* clearInternalFilters(searchModel) {
      const searchFilter = searchModel.getFiltersByFacetId('entity-search')[0];
      const typesFilter = searchModel.getFiltersByFacetId('entity-types')[0];
      if (!isEmpty(searchFilter.value) || !isEmpty(typesFilter.value)) {
        searchFilter.value = '';
        typesFilter.value = [];
        searchModel.updateInputsFromFilters();
      }
    }, */
    updateParamsOffset(params) {
        const entityLinksFilter = params.filters
            .find(({ facetId }) => facetId === ENTITY_LINKS_CLASS);
        if (entityLinksFilter) {
            entityLinksFilter.pagination.offset = this.paginationState.offset;
        }
    },
    resetOffset() {
        this.paginationState.offset = 0;
    },
    addInitialLoader(dataSource) {
        dataSource.searchModel.setInputData(ENTITY_LINKS_CLASS, [loaderItem]);
        const facetsWrapperDS = dataSource.getWidgetDataSource('facets-wrapper');
        facetsWrapperDS.updateInputLinks();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWxpbmtzLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL243LWJvaWxlcnBsYXRlLWxpYi9zcmMvbGliL2FyaWFubmEtd2ViL3NlYXJjaC9lbnRpdHktbGlua3MuaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQ0wsWUFBWSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQy9CLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsb0NBQW9DO0FBRXBDLE1BQU0sa0JBQWtCLEdBQUcsY0FBYyxDQUFDO0FBQzFDLE1BQU0sNEJBQTRCLEdBQUcscUVBQXFFLENBQUM7QUFFM0csTUFBTSxVQUFVLEdBQUc7SUFDakIsT0FBTyxFQUFFLElBQUk7SUFDYixLQUFLLEVBQUUseUJBQXlCO0lBQ2hDLFVBQVUsRUFBRSxFQUFFO0lBQ2QsS0FBSyxFQUFFLGFBQWE7Q0FDckIsQ0FBQztBQUVGLGVBQWU7SUFDYixlQUFlLEVBQUUsRUFBUztJQUMxQixTQUFTLEVBQUUsSUFBSSxPQUFPLEVBQUU7SUFDeEIsZUFBZSxDQUFDLFVBQVU7UUFDeEIsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLHFCQUFxQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0UsT0FBTyxLQUFLLENBQ1YsZUFBZSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDdkQsSUFBSSxDQUFDLFNBQVMsQ0FDZixDQUFDLElBQUksQ0FDSixZQUFZLENBQUMsR0FBRyxDQUFDLEVBQ2pCLFNBQVMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO1lBQ3ZCLE1BQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNoRSxNQUFN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dUJBQzdCLE9BQU8sS0FBSyxLQUFLLEVBQ3BCO29CQUNBLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztvQkFDcEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsTUFBTSxHQUFHLEtBQUssQ0FBQztvQkFDN0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2lCQUMzQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7Ozs7Ozs7O1NBUUs7SUFDTCxrQkFBa0IsQ0FBQyxNQUFNO1FBQ3ZCLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLE9BQU87YUFDckMsSUFBSSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUMsT0FBTyxLQUFLLGtCQUFrQixDQUFDLENBQUM7UUFFekQsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixpQkFBaUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO1NBQ25FO0lBQ0gsQ0FBQztJQUNELFdBQVc7UUFDVCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUNELGdCQUFnQixDQUFDLFVBQVU7UUFDekIsVUFBVSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3pFLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ3JDLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgbWVyZ2UsIGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge1xyXG4gIGRlYm91bmNlVGltZSwgc3dpdGNoTWFwLCBtYXBUb1xyXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuLy8gaW1wb3J0IHsgaXNFbXB0eSB9IGZyb20gJ2xvZGFzaCc7XHJcblxyXG5jb25zdCBFTlRJVFlfTElOS1NfQ0xBU1MgPSAnZW50aXR5LWxpbmtzJztcclxuY29uc3QgRU5USVRZX0xJTktTX1BBUkVOVF9TRUxFQ1RPUiA9ICcubjctZmFjZXRzLXdyYXBwZXJfX2dyb3VwOmxhc3QtY2hpbGQgLm43LWZhY2V0X19zZWN0aW9uLWlucHV0LWxpbmtzJztcclxuXHJcbmNvbnN0IGxvYWRlckl0ZW0gPSB7XHJcbiAgY291bnRlcjogbnVsbCxcclxuICBsYWJlbDogJ0NhcmljYW1lbnRvIGluIGNvcnNvLi4uJyxcclxuICBzZWFyY2hEYXRhOiBbXSxcclxuICB2YWx1ZTogJ19fbG9hZGluZ19fJyxcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICBwYWdpbmF0aW9uU3RhdGU6IHt9IGFzIGFueSxcclxuICBwYWdpbmF0ZSQ6IG5ldyBTdWJqZWN0KCksXHJcbiAgbGlzdGVuVG9DaGFuZ2VzKGRhdGFTb3VyY2UpIHtcclxuICAgIGNvbnN0IGZhY2V0c1dyYXBwZXJFSCA9IGRhdGFTb3VyY2UuZ2V0V2lkZ2V0RXZlbnRIYW5kbGVyKCdmYWNldHMtd3JhcHBlcicpO1xyXG4gICAgcmV0dXJuIG1lcmdlKFxyXG4gICAgICBmYWNldHNXcmFwcGVyRUguaW50ZXJuYWxGYWNldHNDaGFuZ2UkLnBpcGUobWFwVG8obnVsbCkpLFxyXG4gICAgICB0aGlzLnBhZ2luYXRlJCxcclxuICAgICkucGlwZShcclxuICAgICAgZGVib3VuY2VUaW1lKDUwMCksXHJcbiAgICAgIHN3aXRjaE1hcCgocGFnaW5hdGlvbikgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RQYXJhbXMgPSBkYXRhU291cmNlLnNlYXJjaE1vZGVsLmdldFJlcXVlc3RQYXJhbXMoKTtcclxuICAgICAgICBjb25zdCBpbnRlcm5hbEZpbHRlcnMgPSBkYXRhU291cmNlLnNlYXJjaE1vZGVsLmdldEludGVybmFsRmlsdGVycygpO1xyXG4gICAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IHBhZ2luYXRpb24gPyB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgOiAwO1xyXG4gICAgICAgIHRoaXMudXBkYXRlUGFyYW1zT2Zmc2V0KHJlcXVlc3RQYXJhbXMpO1xyXG4gICAgICAgIGNvbnN0IGZpbHRlcnMgPSBbLi4ucmVxdWVzdFBhcmFtcy5maWx0ZXJzLCAuLi5pbnRlcm5hbEZpbHRlcnNdO1xyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcclxuICAgICAgICAgIHNlYXJjaFBhcmFtZXRlcnM6IHtcclxuICAgICAgICAgICAgdG90YWxDb3VudDogMTAwLFxyXG4gICAgICAgICAgICBnYWxsZXJ5OiAhIShkYXRhU291cmNlLnNlYXJjaE1vZGVsLmdldElkKCkgPT09ICdhdy1nYWxsZXJ5LWxheW91dCcpLFxyXG4gICAgICAgICAgICAuLi5yZXF1ZXN0UGFyYW1zLFxyXG4gICAgICAgICAgICBmaWx0ZXJzXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIGluaXRpYWwgbG9hZGVyXHJcbiAgICAgICAgaWYgKHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9PT0gMCkge1xyXG4gICAgICAgICAgdGhpcy5hZGRJbml0aWFsTG9hZGVyKGRhdGFTb3VyY2UpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGRhdGFTb3VyY2UuZ2V0RmFjZXRzUmVxJChwYXJhbXMpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9LFxyXG4gIG9uRmFjZXRzUmVzcG9uc2Uoc2VhcmNoTW9kZWwsIGZhY2V0cykge1xyXG4gICAgLy8gcGFnaW5hdGlvbiBjb250cm9sXHJcbiAgICBjb25zdCBlbnRpdHlMaW5rc0ZhY2V0ID0gZmFjZXRzLmZpbmQoKHsgaWQgfSkgPT4gaWQgPT09IEVOVElUWV9MSU5LU19DTEFTUyk7XHJcbiAgICBjb25zdCB7IHRvdGFsQ291bnQgfSA9IGVudGl0eUxpbmtzRmFjZXQ7XHJcbiAgICBsZXQgeyBsaW1pdCwgb2Zmc2V0IH0gPSB0aGlzLnBhZ2luYXRpb25TdGF0ZTtcclxuICAgIGlmICh0eXBlb2YgbGltaXQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGxpbWl0ID0gMTA7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIG9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgb2Zmc2V0ID0gMDtcclxuICAgIH1cclxuICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLnRvdGFsQ291bnQgPSB0b3RhbENvdW50O1xyXG4gICAgaWYgKG9mZnNldCA+IDApIHtcclxuICAgICAgY29uc3QgZW50aXR5TGlua3NJbnB1dCA9IHNlYXJjaE1vZGVsLmdldElucHV0QnlGYWNldElkKEVOVElUWV9MSU5LU19DTEFTUyk7XHJcbiAgICAgIGNvbnN0IG9sZERhdGEgPSBlbnRpdHlMaW5rc0lucHV0LmdldERhdGEoKSB8fCBbXTtcclxuICAgICAgLy8gcmVtb3ZlIGZha2UgbG9hZGluZyBlbGVtZW50XHJcbiAgICAgIGlmIChvbGREYXRhLmxlbmd0aCkge1xyXG4gICAgICAgIG9sZERhdGEucG9wKCk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgbmV3RGF0YSA9IG9sZERhdGEuY29uY2F0KGVudGl0eUxpbmtzRmFjZXQuZGF0YSk7XHJcbiAgICAgIGVudGl0eUxpbmtzRmFjZXQuZGF0YSA9IG5ld0RhdGE7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMucGFnaW5hdGlvblN0YXRlLnRvdGFsQ291bnQgPiAobGltaXQgKyBvZmZzZXQpKSB7XHJcbiAgICAgIGVudGl0eUxpbmtzRmFjZXQuZGF0YS5wdXNoKGxvYWRlckl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGVtcHR5IHN0YXRlXHJcbiAgICBjb25zdCBlbnRpdHlMaW5rc0lucHV0ID0gc2VhcmNoTW9kZWwuZ2V0SW5wdXRCeUZhY2V0SWQoRU5USVRZX0xJTktTX0NMQVNTKTtcclxuICAgIGVudGl0eUxpbmtzSW5wdXQuc2V0SXNFbXB0eSghdG90YWxDb3VudCk7XHJcblxyXG4gICAgLy8gZml4IHNjcm9sbFxyXG4gICAgaWYgKG9mZnNldCA9PT0gMCkge1xyXG4gICAgICBjb25zdCBzY3JvbGxFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoRU5USVRZX0xJTktTX1BBUkVOVF9TRUxFQ1RPUik7XHJcbiAgICAgIGlmIChzY3JvbGxFbCkge1xyXG4gICAgICAgIHNjcm9sbEVsLnNjcm9sbFRvcCA9IDA7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyB1cGRhdGUgbG9hZGluZyBzdGF0ZVxyXG4gICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUubG9hZGluZyA9IGZhbHNlO1xyXG4gIH0sXHJcbiAgaW5pdFBhZ2luYXRpb24oc2VhcmNoTW9kZWwpIHtcclxuICAgIHNlYXJjaE1vZGVsLmdldEZpbHRlcnMoKS5maWx0ZXIoKGZpbHRlcikgPT4gKFxyXG4gICAgICBmaWx0ZXIucGFnaW5hdGlvblxyXG4gICAgKSkuZm9yRWFjaCgoeyBwYWdpbmF0aW9uIH0pID0+IHtcclxuICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUgPSB7XHJcbiAgICAgICAgLi4ucGFnaW5hdGlvbixcclxuICAgICAgICAuLi50aGlzLnBhZ2luYXRpb25TdGF0ZSxcclxuICAgICAgICBsb2FkaW5nOiBmYWxzZVxyXG4gICAgICB9O1xyXG4gICAgfSk7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgY29uc3Qgc2Nyb2xsRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKEVOVElUWV9MSU5LU19QQVJFTlRfU0VMRUNUT1IpO1xyXG4gICAgICBjb25zdCBzY3JvbGwkID0gZnJvbUV2ZW50KHNjcm9sbEVsLCAnc2Nyb2xsJyk7XHJcbiAgICAgIHNjcm9sbCQucGlwZShcclxuICAgICAgICBkZWJvdW5jZVRpbWUoMzAwKVxyXG4gICAgICApLnN1YnNjcmliZSgoeyB0YXJnZXQgfSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgc2Nyb2xsVG9wLCBjbGllbnRIZWlnaHQsIHNjcm9sbEhlaWdodCB9ID0gdGFyZ2V0IGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgIG9mZnNldCwgbGltaXQsIHRvdGFsQ291bnQsIGxvYWRpbmdcclxuICAgICAgICB9ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGU7XHJcbiAgICAgICAgY29uc3QgbWFyZ2luID0gMTUwO1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIChzY3JvbGxUb3AgKyBjbGllbnRIZWlnaHQgPj0gc2Nyb2xsSGVpZ2h0IC0gbWFyZ2luKVxyXG4gICAgICAgICAgJiYgKG9mZnNldCArIGxpbWl0IDwgdG90YWxDb3VudClcclxuICAgICAgICAgICYmIGxvYWRpbmcgPT09IGZhbHNlXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS5sb2FkaW5nID0gdHJ1ZTtcclxuICAgICAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IG9mZnNldCArIGxpbWl0O1xyXG4gICAgICAgICAgdGhpcy5wYWdpbmF0ZSQubmV4dCh0aGlzLnBhZ2luYXRpb25TdGF0ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0sXHJcbiAgLyogY2xlYXJJbnRlcm5hbEZpbHRlcnMoc2VhcmNoTW9kZWwpIHtcclxuICAgIGNvbnN0IHNlYXJjaEZpbHRlciA9IHNlYXJjaE1vZGVsLmdldEZpbHRlcnNCeUZhY2V0SWQoJ2VudGl0eS1zZWFyY2gnKVswXTtcclxuICAgIGNvbnN0IHR5cGVzRmlsdGVyID0gc2VhcmNoTW9kZWwuZ2V0RmlsdGVyc0J5RmFjZXRJZCgnZW50aXR5LXR5cGVzJylbMF07XHJcbiAgICBpZiAoIWlzRW1wdHkoc2VhcmNoRmlsdGVyLnZhbHVlKSB8fCAhaXNFbXB0eSh0eXBlc0ZpbHRlci52YWx1ZSkpIHtcclxuICAgICAgc2VhcmNoRmlsdGVyLnZhbHVlID0gJyc7XHJcbiAgICAgIHR5cGVzRmlsdGVyLnZhbHVlID0gW107XHJcbiAgICAgIHNlYXJjaE1vZGVsLnVwZGF0ZUlucHV0c0Zyb21GaWx0ZXJzKCk7XHJcbiAgICB9XHJcbiAgfSwgKi9cclxuICB1cGRhdGVQYXJhbXNPZmZzZXQocGFyYW1zKSB7XHJcbiAgICBjb25zdCBlbnRpdHlMaW5rc0ZpbHRlciA9IHBhcmFtcy5maWx0ZXJzXHJcbiAgICAgIC5maW5kKCh7IGZhY2V0SWQgfSkgPT4gZmFjZXRJZCA9PT0gRU5USVRZX0xJTktTX0NMQVNTKTtcclxuXHJcbiAgICBpZiAoZW50aXR5TGlua3NGaWx0ZXIpIHtcclxuICAgICAgZW50aXR5TGlua3NGaWx0ZXIucGFnaW5hdGlvbi5vZmZzZXQgPSB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQ7XHJcbiAgICB9XHJcbiAgfSxcclxuICByZXNldE9mZnNldCgpIHtcclxuICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IDA7XHJcbiAgfSxcclxuICBhZGRJbml0aWFsTG9hZGVyKGRhdGFTb3VyY2UpIHtcclxuICAgIGRhdGFTb3VyY2Uuc2VhcmNoTW9kZWwuc2V0SW5wdXREYXRhKEVOVElUWV9MSU5LU19DTEFTUywgW2xvYWRlckl0ZW1dKTtcclxuICAgIGNvbnN0IGZhY2V0c1dyYXBwZXJEUyA9IGRhdGFTb3VyY2UuZ2V0V2lkZ2V0RGF0YVNvdXJjZSgnZmFjZXRzLXdyYXBwZXInKTtcclxuICAgIGZhY2V0c1dyYXBwZXJEUy51cGRhdGVJbnB1dExpbmtzKCk7XHJcbiAgfVxyXG59O1xyXG4iXX0=