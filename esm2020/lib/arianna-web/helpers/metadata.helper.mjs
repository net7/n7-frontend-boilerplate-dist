import helpers from '../../common/helpers';
const metadataIsEmpty = (value) => (!value || value === 'null');
const isLink = (fields) => !!fields.filter(({ key }) => key === 'isLink').length;
const isRepeater = (fields) => Array.isArray(fields);
const getLink = (fields, paths) => {
    const schedaTypes = ['oggetto-culturale', 'aggregazione-logica'];
    const label = fields.find(({ key }) => key === 'label').value;
    const slug = helpers.slugify(label);
    const id = fields.find(({ key }) => key === 'id').value;
    const type = fields.find(({ key }) => key === 'type').value;
    let basePath = paths.entitaBasePath;
    if (schedaTypes.includes(type)) {
        basePath = paths.schedaBasePath;
    }
    return `<a href="${basePath}${id}/${slug}">${label}</a>`;
};
const getRepeater = (fields, labels, metadataToShow, type, parentLabel, paths) => {
    const html = [];
    fields
        .filter(({ fields: subFields }) => subFields)
        .forEach(({ fields: subFields }) => {
        const subHtml = [];
        if (isLink(subFields)) {
            subHtml.push('<div>');
            subHtml.push(`<dd>${getLink(subFields, paths)}</dd>`);
            subHtml.push('</div>');
        }
        subFields
            .filter(({ key }) => {
            if (isLink(subFields)) {
                return !(['label', 'id', 'type', 'isLink'].includes(key));
            }
            return true;
        })
            .filter(({ key, value }) => metadataToShow.includes(`${parentLabel}.${key}`) && !metadataIsEmpty(value))
            .map(({ key, value }) => ({
            key,
            value,
            order: metadataToShow.indexOf(`${parentLabel}.${key}`),
            label: helpers.prettifySnakeCase(key, labels[`${type}.${parentLabel}.${key}`])
        }))
            .sort((a, b) => a.order - b.order)
            .forEach(({ label, value }) => {
            subHtml.push('<div>');
            subHtml.push(`<dt>${label}</dt>`);
            subHtml.push(`<dd>${value}</dd>`);
            subHtml.push('</div>');
        });
        if (subHtml.length) {
            html.push(`<dl>${subHtml.join('')}</dl>`);
        }
    });
    return html.length ? html.join('') : null;
};
export default {
    normalize: ({ fields: data, paths, labels, metadataToShow, type }) => {
        const result = [];
        if (Array.isArray(data)) {
            data.forEach(({ key, value, label, fields }) => {
                // link & repeater control
                if (fields && Array.isArray(fields)) {
                    if (isLink(fields)) {
                        result.push({ key: label, value: getLink(fields, paths) });
                    }
                    else if (isRepeater(fields) && metadataToShow.includes(label)) {
                        result.push({
                            key: label,
                            value: getRepeater(fields, labels, metadataToShow, type, label, paths)
                        });
                    }
                    // default
                }
                else if (metadataToShow.includes(key)) {
                    result.push({ key, value });
                }
            });
        }
        return result
            .filter(({ value }) => !metadataIsEmpty(value))
            .map(({ key, value }) => ({
            key,
            value,
            order: metadataToShow.indexOf(key),
            label: helpers.prettifySnakeCase(key, labels[`${type}.${key}`]),
        }))
            .sort((a, b) => a.order - b.order);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YWRhdGEuaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbjctYm9pbGVycGxhdGUtbGliL3NyYy9saWIvYXJpYW5uYS13ZWIvaGVscGVycy9tZXRhZGF0YS5oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sc0JBQXNCLENBQUM7QUFFM0MsTUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksS0FBSyxLQUFLLE1BQU0sQ0FBQyxDQUFDO0FBRWhFLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBYSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUM7QUFFeEYsTUFBTSxVQUFVLEdBQUcsQ0FBQyxNQUFhLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFFNUQsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFhLEVBQUUsS0FBSyxFQUFFLEVBQUU7SUFDdkMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEtBQUssT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQzlELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsS0FBSyxJQUFJ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QUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO3lCQUN2RSxDQUFDLENBQUM7cUJBQ0o7b0JBQ0QsVUFBVTtpQkFDWDtxQkFBTSxJQUFJLGNBQWMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3ZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztpQkFDN0I7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxNQUFNO2FBQ1YsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDOUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDeEIsR0FBRztZQUNILEtBQUs7WUFDTCxLQUFLLEVBQUUsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDbEMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLEdBQUcsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7U0FDaEUsQ0FBQyxDQUFDO2FBQ0YsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkMsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaGVscGVycyBmcm9tICcuLi8uLi9jb21tb24vaGVscGVycyc7XHJcblxyXG5jb25zdCBtZXRhZGF0YUlzRW1wdHkgPSAodmFsdWUpID0+ICghdmFsdWUgfHwgdmFsdWUgPT09ICdudWxsJyk7XHJcblxyXG5jb25zdCBpc0xpbmsgPSAoZmllbGRzOiBhbnlbXSkgPT4gISFmaWVsZHMuZmlsdGVyKCh7IGtleSB9KSA9PiBrZXkgPT09ICdpc0xpbmsnKS5sZW5ndGg7XHJcblxyXG5jb25zdCBpc1JlcGVhdGVyID0gKGZpZWxkczogYW55W10pID0+IEFycmF5LmlzQXJyYXkoZmllbGRzKTtcclxuXHJcbmNvbnN0IGdldExpbmsgPSAoZmllbGRzOiBhbnlbXSwgcGF0aHMpID0+IHtcclxuICBjb25zdCBzY2hlZGFUeXBlcyA9IFsnb2dnZXR0by1jdWx0dXJhbGUnLCAnYWdncmVnYXppb25lLWxvZ2ljYSddO1xyXG4gIGNvbnN0IGxhYmVsID0gZmllbGRzLmZpbmQoKHsga2V5IH0pID0+IGtleSA9PT0gJ2xhYmVsJykudmFsdWU7XHJcbiAgY29uc3Qgc2x1ZyA9IGhlbHBlcnMuc2x1Z2lmeShsYWJlbCk7XHJcbiAgY29uc3QgaWQgPSBmaWVsZHMuZmluZCgoeyBrZXkgfSkgPT4ga2V5ID09PSAnaWQnKS52YWx1ZTtcclxuICBjb25zdCB0eXBlID0gZmllbGRzLmZpbmQoKHsga2V5IH0pID0+IGtleSA9PT0gJ3R5cGUnKS52YWx1ZTtcclxuICBsZXQgYmFzZVBhdGggPSBwYXRocy5lbnRpdGFCYXNlUGF0aDtcclxuICBpZiAoc2NoZWRhVHlwZXMuaW5jbHVkZXModHlwZSkpIHtcclxuICAgIGJhc2VQYXRoID0gcGF0aHMuc2NoZWRhQmFzZVBhdGg7XHJcbiAgfVxyXG4gIHJldHVybiBgPGEgaHJlZj1cIiR7YmFzZVBhdGh9JHtpZH0vJHtzbHVnfVwiPiR7bGFiZWx9PC9hPmA7XHJcbn07XHJcblxyXG5jb25zdCBnZXRSZXBlYXRlciA9IChmaWVsZHM6IGFueVtdLCBsYWJlbHMsIG1ldGFkYXRhVG9TaG93LCB0eXBlLCBwYXJlbnRMYWJlbCwgcGF0aHMpID0+IHtcclxuICBjb25zdCBodG1sID0gW107XHJcbiAgZmllbGRzXHJcbiAgICAuZmlsdGVyKCh7IGZpZWxkczogc3ViRmllbGRzIH0pID0+IHN1YkZpZWxkcylcclxuICAgIC5mb3JFYWNoKCh7IGZpZWxkczogc3ViRmllbGRzIH0pID0+IHtcclxuICAgICAgY29uc3Qgc3ViSHRtbCA9IFtdO1xyXG4gICAgICBpZiAoaXNMaW5rKHN1YkZpZWxkcykpIHtcclxuICAgICAgICBzdWJIdG1sLnB1c2goJzxkaXY+Jyk7XHJcbiAgICAgICAgc3ViSHRtbC5wdXNoKGA8ZGQ+JHtnZXRMaW5rKHN1YkZpZWxkcywgcGF0aHMpfTwvZGQ+YCk7XHJcbiAgICAgICAgc3ViSHRtbC5wdXNoKCc8L2Rpdj4nKTtcclxuICAgICAgfVxyXG4gICAgICBzdWJGaWVsZHNcclxuICAgICAgICAuZmlsdGVyKCh7IGtleSB9KSA9PiB7XHJcbiAgICAgICAgICBpZiAoaXNMaW5rKHN1YkZpZWxkcykpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEoWydsYWJlbCcsICdpZCcsICd0eXBlJywgJ2lzTGluayddLmluY2x1ZGVzKGtleSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuZmlsdGVyKCh7IGtleSwgdmFsdWUgfSkgPT4gbWV0YWRhdGFUb1Nob3cuaW5jbHVkZXMoYCR7cGFyZW50TGFiZWx9LiR7a2V5fWApICYmICFtZXRhZGF0YUlzRW1wdHkodmFsdWUpKVxyXG4gICAgICAgIC5tYXAoKHsga2V5LCB2YWx1ZSB9KSA9PiAoe1xyXG4gICAgICAgICAga2V5LFxyXG4gICAgICAgICAgdmFsdWUsXHJcbiAgICAgICAgICBvcmRlcjogbWV0YWRhdGFUb1Nob3cuaW5kZXhPZihgJHtwYXJlbnRMYWJlbH0uJHtrZXl9YCksXHJcbiAgICAgICAgICBsYWJlbDogaGVscGVycy5wcmV0dGlmeVNuYWtlQ2FzZShrZXksIGxhYmVsc1tgJHt0eXBlfS4ke3BhcmVudExhYmVsfS4ke2tleX1gXSlcclxuICAgICAgICB9KSlcclxuICAgICAgICAuc29ydCgoYSwgYikgPT4gYS5vcmRlciAtIGIub3JkZXIpXHJcbiAgICAgICAgLmZvckVhY2goKHsgbGFiZWwsIHZhbHVlIH0pID0+IHtcclxuICAgICAgICAgIHN1Ykh0bWwucHVzaCgnPGRpdj4nKTtcclxuICAgICAgICAgIHN1Ykh0bWwucHVzaChgPGR0PiR7bGFiZWx9PC9kdD5gKTtcclxuICAgICAgICAgIHN1Ykh0bWwucHVzaChgPGRkPiR7dmFsdWV9PC9kZD5gKTtcclxuICAgICAgICAgIHN1Ykh0bWwucHVzaCgnPC9kaXY+Jyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAoc3ViSHRtbC5sZW5ndGgpIHtcclxuICAgICAgICBodG1sLnB1c2goYDxkbD4ke3N1Ykh0bWwuam9pbignJyl9PC9kbD5gKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgcmV0dXJuIGh0bWwubGVuZ3RoID8gaHRtbC5qb2luKCcnKSA6IG51bGw7XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCB7XHJcbiAgbm9ybWFsaXplOiAoe1xyXG4gICAgZmllbGRzOiBkYXRhLFxyXG4gICAgcGF0aHMsXHJcbiAgICBsYWJlbHMsXHJcbiAgICBtZXRhZGF0YVRvU2hvdyxcclxuICAgIHR5cGVcclxuICB9KSA9PiB7XHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgIGRhdGEuZm9yRWFjaCgoe1xyXG4gICAgICAgIGtleSwgdmFsdWUsIGxhYmVsLCBmaWVsZHNcclxuICAgICAgfSkgPT4ge1xyXG4gICAgICAgIC8vIGxpbmsgJiByZXBlYXRlciBjb250cm9sXHJcbiAgICAgICAgaWYgKGZpZWxkcyAmJiBBcnJheS5pc0FycmF5KGZpZWxkcykpIHtcclxuICAgICAgICAgIGlmIChpc0xpbmsoZmllbGRzKSkge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh7IGtleTogbGFiZWwsIHZhbHVlOiBnZXRMaW5rKGZpZWxkcywgcGF0aHMpIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChpc1JlcGVhdGVyKGZpZWxkcykgJiYgbWV0YWRhdGFUb1Nob3cuaW5jbHVkZXMobGFiZWwpKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcclxuICAgICAgICAgICAgICBrZXk6IGxhYmVsLFxyXG4gICAgICAgICAgICAgIHZhbHVlOiBnZXRSZXBlYXRlcihmaWVsZHMsIGxhYmVscywgbWV0YWRhdGFUb1Nob3csIHR5cGUsIGxhYmVsLCBwYXRocylcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyBkZWZhdWx0XHJcbiAgICAgICAgfSBlbHNlIGlmIChtZXRhZGF0YVRvU2hvdy5pbmNsdWRlcyhrZXkpKSB7XHJcbiAgICAgICAgICByZXN1bHQucHVzaCh7IGtleSwgdmFsdWUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHRcclxuICAgICAgLmZpbHRlcigoeyB2YWx1ZSB9KSA9PiAhbWV0YWRhdGFJc0VtcHR5KHZhbHVlKSlcclxuICAgICAgLm1hcCgoeyBrZXksIHZhbHVlIH0pID0+ICh7XHJcbiAgICAgICAga2V5LFxyXG4gICAgICAgIHZhbHVlLFxyXG4gICAgICAgIG9yZGVyOiBtZXRhZGF0YVRvU2hvdy5pbmRleE9mKGtleSksXHJcbiAgICAgICAgbGFiZWw6IGhlbHBlcnMucHJldHRpZnlTbmFrZUNhc2Uoa2V5LCBsYWJlbHNbYCR7dHlwZX0uJHtrZXl9YF0pLFxyXG4gICAgICB9KSlcclxuICAgICAgLnNvcnQoKGEsIGIpID0+IGEub3JkZXIgLSBiLm9yZGVyKTtcclxuICB9XHJcbn07XHJcbiJdfQ==