import { LayoutDataSource } from '@n7-frontend/core';
import { BehaviorSubject } from 'rxjs';
import { first, map } from 'rxjs/operators';
import slugify from 'slugify';
export class AwCollectionLayoutDS extends LayoutDataSource {
    constructor() {
        super(...arguments);
        this.innerTitleData = new BehaviorSubject({
            title: { main: { text: '' } },
        });
        this.collectionDescription = new BehaviorSubject('');
        this.pageSize = 6;
        this.currentOffset = 0;
        this.loadMoreButton = new BehaviorSubject(true);
    }
    onInit(payload) {
        this.communication = payload.communication;
        this.route = payload.route;
        this.configuration = payload.configuration;
        this.loadedCollections = new BehaviorSubject([]);
        this.layoutOptions = this.configuration.get('collection-layout');
    }
    /**
     * After the collection ID has been loaded
     */
    onCollectionID() {
        // reset pagination params
        this.pageSize = 6;
        this.currentOffset = 0;
        // load
        this.loadMore(true);
    }
    loadMore(reload = false) {
        const collection = this.loadedCollections.getValue();
        const params = {
            id: this.collectionID,
            itemPagination: {
                limit: this.pageSize,
                offset: this.currentOffset,
            }
        };
        this.communication.request$('getCollection', {
            onError: (error) => console.error(error),
            params
        }).pipe(first((d) => !!d), map((d) => ({
            // map the backend response to the format used by ItemPreviewComponent
            response: d.items.map((item) => ({
                title: this.stringLimiter(item.title, {
                    maxLength: this.layoutOptions.item.title.maxLength,
                    char: this.layoutOptions.item.title.char,
                }),
                text: this.stringLimiter(item.content, {
                    maxLength: this.layoutOptions.item.description.maxLength,
                    char: this.layoutOptions.item.description.char
                }),
                classes: `${item.image ? 'is-overlay has-image' : 'is-overlay has-image has-watermark'} ${item.classification ? `is-${item.classification}` : ''}`,
                image: item.image || this.layoutOptions.watermark,
                color: item.background,
                anchor: {
                    href: item.url || this.urlBuilder(item.a4vId, item.title, item.type)
                },
                classification: item.classification
            })),
            text: d.text,
            title: d.title,
            total: d.total,
        }))).subscribe({
            next: (data) => {
                if (data.title) {
                    this.setTitle(this.stringLimiter(data.title, {
                        maxLength: this.layoutOptions.header.maxLength,
                        char: this.layoutOptions.header.char
                    }));
                }
                this.collectionDescription.next(data.text ? this.stringLimiter(data.text, {
                    maxLength: this.layoutOptions.description.maxLength,
                    char: this.layoutOptions.description.char
                }) : '');
                this.currentOffset += this.pageSize;
                const collectionData = !reload
                    ? [...collection, ...data.response]
                    : [...data.response];
                this.loadedCollections.next(collectionData);
                this.loadMoreButton.next(data.total > this.loadedCollections.getValue().length);
            },
            error: (e) => {
                console.error(e);
                this.loadMoreButton.next(false);
            },
        });
    }
    /**
     * Builds a URL from entity type,
     * entity id, and a slug string.
     *
     * @param type entity type
     * @param id entity ID
     * @param title human-readable title
     * @returns URL string including a slug
     */
    urlBuilder(id, title, type) {
        if (id && title) {
            const titleSlug = slugify(title);
            const { schedaBasePath, entitaBasePath } = this.configuration.get('paths');
            const basePath = type === 'entity' ? entitaBasePath : schedaBasePath;
            return `/${basePath}/${id}/${titleSlug}`;
        }
        return undefined;
    }
    stringLimiter(content, options) {
        let res = content;
        if (content && options.maxLength) {
            res = content.slice(0, options.maxLength);
            if (options.char && res !== content) {
                res += options.char;
            }
        }
        return res;
    }
    setTitle(title) {
        this.innerTitleData.next({
            title: { main: { text: title } }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi1sYXlvdXQuZHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbjctZnJvbnRlbmQvYm9pbGVycGxhdGUvIiwic291cmNlcyI6WyJsaWIvYXJpYW5uYS13ZWIvbGF5b3V0cy9jb2xsZWN0aW9uLWxheW91dC9jb2xsZWN0aW9uLWxheW91dC5kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBSzlCLE1BQU0sT0FBTyxvQkFBcUIsU0FBUSxnQkFBZ0I7SUFBMUQ7O1FBV0UsbUJBQWMsR0FBRyxJQUFJLGVBQWUsQ0FBaUI7WUFDbkQsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxFQUFFO1NBQzlCLENBQUMsQ0FBQTtRQUVGLDBCQUFxQixHQUFHLElBQUksZUFBZSxDQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRXhELGFBQVEsR0FBRyxDQUFDLENBQUM7UUFFYixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUlsQixtQkFBYyxHQUFHLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBd0g1QyxDQUFDO0lBdEhDLE1BQU0sQ0FBQyxPQUFPO1FBQ1osSUFBSSxDQUFDLGFBQWEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQzNDLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDM0MsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pELElBQUks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QUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7U0FDakMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5uZXJUaXRsZURhdGEsIEl0ZW1QcmV2aWV3RGF0YSB9IGZyb20gJ0BuNy1mcm9udGVuZC9jb21wb25lbnRzJztcbmltcG9ydCB7IExheW91dERhdGFTb3VyY2UgfSBmcm9tICdAbjctZnJvbnRlbmQvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpcnN0LCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgc2x1Z2lmeSBmcm9tICdzbHVnaWZ5JztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL3NlcnZpY2VzL2NvbmZpZ3VyYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBDb21tdW5pY2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9zZXJ2aWNlcy9jb21tdW5pY2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29sbGVjdGlvbkl0ZW0sIEdldENvbGxlY3Rpb25QYXJhbXMsIEdldENvbGxlY3Rpb25SZXNwb25zZSB9IGZyb20gJy4vY29sbGVjdGlvbi1sYXlvdXQudHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgQXdDb2xsZWN0aW9uTGF5b3V0RFMgZXh0ZW5kcyBMYXlvdXREYXRhU291cmNlIHtcbiAgcHJpdmF0ZSBjb21tdW5pY2F0aW9uOiBDb21tdW5pY2F0aW9uU2VydmljZTtcblxuICBwcml2YXRlIGNvbmZpZ3VyYXRpb246IENvbmZpZ3VyYXRpb25TZXJ2aWNlO1xuXG4gIHByaXZhdGUgbGF5b3V0T3B0aW9ucztcblxuICBwcml2YXRlIHJvdXRlO1xuXG4gIHB1YmxpYyBjb2xsZWN0aW9uSUQ6IHN0cmluZztcblxuICBpbm5lclRpdGxlRGF0YSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SW5uZXJUaXRsZURhdGE+KHtcbiAgICB0aXRsZTogeyBtYWluOiB7IHRleHQ6ICcnIH0gfSxcbiAgfSlcblxuICBjb2xsZWN0aW9uRGVzY3JpcHRpb24gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4oJycpO1xuXG4gIHBhZ2VTaXplID0gNjtcblxuICBjdXJyZW50T2Zmc2V0ID0gMDtcblxuICBsb2FkZWRDb2xsZWN0aW9uczogQmVoYXZpb3JTdWJqZWN0PEl0ZW1QcmV2aWV3RGF0YVtdIHwgW10+O1xuXG4gIGxvYWRNb3JlQnV0dG9uID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0cnVlKVxuXG4gIG9uSW5pdChwYXlsb2FkKSB7XG4gICAgdGhpcy5jb21tdW5pY2F0aW9uID0gcGF5bG9hZC5jb21tdW5pY2F0aW9uO1xuICAgIHRoaXMucm91dGUgPSBwYXlsb2FkLnJvdXRlO1xuICAgIHRoaXMuY29uZmlndXJhdGlvbiA9IHBheWxvYWQuY29uZmlndXJhdGlvbjtcbiAgICB0aGlzLmxvYWRlZENvbGxlY3Rpb25zID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gICAgdGhpcy5sYXlvdXRPcHRpb25zID0gdGhpcy5jb25maWd1cmF0aW9uLmdldCgnY29sbGVjdGlvbi1sYXlvdXQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZnRlciB0aGUgY29sbGVjdGlvbiBJRCBoYXMgYmVlbiBsb2FkZWRcbiAgICovXG4gIG9uQ29sbGVjdGlvbklEKCkge1xuICAgIC8vIHJlc2V0IHBhZ2luYXRpb24gcGFyYW1zXG4gICAgdGhpcy5wYWdlU2l6ZSA9IDY7XG4gICAgdGhpcy5jdXJyZW50T2Zmc2V0ID0gMDtcbiAgICAvLyBsb2FkXG4gICAgdGhpcy5sb2FkTW9yZSh0cnVlKTtcbiAgfVxuXG4gIGxvYWRNb3JlKHJlbG9hZCA9IGZhbHNlKSB7XG4gICAgY29uc3QgY29sbGVjdGlvbiA9IHRoaXMubG9hZGVkQ29sbGVjdGlvbnMuZ2V0VmFsdWUoKTtcbiAgICBjb25zdCBwYXJhbXM6IEdldENvbGxlY3Rpb25QYXJhbXMgPSB7XG4gICAgICBpZDogdGhpcy5jb2xsZWN0aW9uSUQsXG4gICAgICBpdGVtUGFnaW5hdGlvbjoge1xuICAgICAgICBsaW1pdDogdGhpcy5wYWdlU2l6ZSxcbiAgICAgICAgb2Zmc2V0OiB0aGlzLmN1cnJlbnRPZmZzZXQsXG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLmNvbW11bmljYXRpb24ucmVxdWVzdCQoJ2dldENvbGxlY3Rpb24nLCB7XG4gICAgICBvbkVycm9yOiAoZXJyb3IpID0+IGNvbnNvbGUuZXJyb3IoZXJyb3IpLFxuICAgICAgcGFyYW1zXG4gICAgfSkucGlwZShcbiAgICAgIGZpcnN0KChkKSA9PiAhIWQpLFxuICAgICAgbWFwKChkOiBHZXRDb2xsZWN0aW9uUmVzcG9uc2UpID0+ICh7XG4gICAgICAgIC8vIG1hcCB0aGUgYmFja2VuZCByZXNwb25zZSB0byB0aGUgZm9ybWF0IHVzZWQgYnkgSXRlbVByZXZpZXdDb21wb25lbnRcbiAgICAgICAgcmVzcG9uc2U6IGQuaXRlbXMubWFwKChpdGVtOiBDb2xsZWN0aW9uSXRlbSkgPT4gKHtcbiAgICAgICAgICB0aXRsZTogdGhpcy5zdHJpbmdMaW1pdGVyKGl0ZW0udGl0bGUsIHtcbiAgICAgICAgICAgIG1heExlbmd0aDogdGhpcy5sYXlvdXRPcHRpb25zLml0ZW0udGl0bGUubWF4TGVuZ3RoLFxuICAgICAgICAgICAgY2hhcjogdGhpcy5sYXlvdXRPcHRpb25zLml0ZW0udGl0bGUuY2hhcixcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB0ZXh0OiB0aGlzLnN0cmluZ0xpbWl0ZXIoaXRlbS5jb250ZW50LCB7XG4gICAgICAgICAgICBtYXhMZW5ndGg6IHRoaXMubGF5b3V0T3B0aW9ucy5pdGVtLmRlc2NyaXB0aW9uLm1heExlbmd0aCxcbiAgICAgICAgICAgIGNoYXI6IHRoaXMubGF5b3V0T3B0aW9ucy5pdGVtLmRlc2NyaXB0aW9uLmNoYXJcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjbGFzc2VzOiBgJHtpdGVtLmltYWdlID8gJ2lzLW92ZXJsYXkgaGFzLWltYWdlJyA6ICdpcy1vdmVybGF5IGhhcy1pbWFnZSBoYXMtd2F0ZXJtYXJrJ30gJHtpdGVtLmNsYXNzaWZpY2F0aW9uID8gYGlzLSR7aXRlbS5jbGFzc2lmaWNhdGlvbn1gIDogJyd9YCxcbiAgICAgICAgICBpbWFnZTogaXRlbS5pbWFnZSB8fCB0aGlzLmxheW91dE9wdGlvbnMud2F0ZXJtYXJrLFxuICAgICAgICAgIGNvbG9yOiBpdGVtLmJhY2tncm91bmQsXG4gICAgICAgICAgYW5jaG9yOiB7XG4gICAgICAgICAgICBocmVmOiBpdGVtLnVybCB8fCB0aGlzLnVybEJ1aWxkZXIoaXRlbS5hNHZJZCwgaXRlbS50aXRsZSwgaXRlbS50eXBlKVxuICAgICAgICAgIH0sXG4gICAgICAgICAgY2xhc3NpZmljYXRpb246IGl0ZW0uY2xhc3NpZmljYXRpb25cbiAgICAgICAgfSkpLFxuICAgICAgICB0ZXh0OiBkLnRleHQsXG4gICAgICAgIHRpdGxlOiBkLnRpdGxlLFxuICAgICAgICB0b3RhbDogZC50b3RhbCxcbiAgICAgIH0pKVxuICAgICkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6IChkYXRhKSA9PiB7XG4gICAgICAgIGlmIChkYXRhLnRpdGxlKSB7XG4gICAgICAgICAgdGhpcy5zZXRUaXRsZSh0aGlzLnN0cmluZ0xpbWl0ZXIoZGF0YS50aXRsZSwge1xuICAgICAgICAgICAgbWF4TGVuZ3RoOiB0aGlzLmxheW91dE9wdGlvbnMuaGVhZGVyLm1heExlbmd0aCxcbiAgICAgICAgICAgIGNoYXI6IHRoaXMubGF5b3V0T3B0aW9ucy5oZWFkZXIuY2hhclxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNvbGxlY3Rpb25EZXNjcmlwdGlvbi5uZXh0KGRhdGEudGV4dCA/IHRoaXMuc3RyaW5nTGltaXRlcihkYXRhLnRleHQsIHtcbiAgICAgICAgICBtYXhMZW5ndGg6IHRoaXMubGF5b3V0T3B0aW9ucy5kZXNjcmlwdGlvbi5tYXhMZW5ndGgsXG4gICAgICAgICAgY2hhcjogdGhpcy5sYXlvdXRPcHRpb25zLmRlc2NyaXB0aW9uLmNoYXJcbiAgICAgICAgfSkgOiAnJyk7XG4gICAgICAgIHRoaXMuY3VycmVudE9mZnNldCArPSB0aGlzLnBhZ2VTaXplO1xuICAgICAgICBjb25zdCBjb2xsZWN0aW9uRGF0YSA9ICFyZWxvYWRcbiAgICAgICAgICA/IFsuLi5jb2xsZWN0aW9uLCAuLi5kYXRhLnJlc3BvbnNlXVxuICAgICAgICAgIDogWy4uLmRhdGEucmVzcG9uc2VdO1xuICAgICAgICB0aGlzLmxvYWRlZENvbGxlY3Rpb25zLm5leHQoY29sbGVjdGlvbkRhdGEpO1xuICAgICAgICB0aGlzLmxvYWRNb3JlQnV0dG9uLm5leHQoXG4gICAgICAgICAgZGF0YS50b3RhbCA+IHRoaXMubG9hZGVkQ29sbGVjdGlvbnMuZ2V0VmFsdWUoKS5sZW5ndGhcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgICBlcnJvcjogKGUpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgdGhpcy5sb2FkTW9yZUJ1dHRvbi5uZXh0KGZhbHNlKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGRzIGEgVVJMIGZyb20gZW50aXR5IHR5cGUsXG4gICAqIGVudGl0eSBpZCwgYW5kIGEgc2x1ZyBzdHJpbmcuXG4gICAqXG4gICAqIEBwYXJhbSB0eXBlIGVudGl0eSB0eXBlXG4gICAqIEBwYXJhbSBpZCBlbnRpdHkgSURcbiAgICogQHBhcmFtIHRpdGxlIGh1bWFuLXJlYWRhYmxlIHRpdGxlXG4gICAqIEByZXR1cm5zIFVSTCBzdHJpbmcgaW5jbHVkaW5nIGEgc2x1Z1xuICAgKi9cbiAgdXJsQnVpbGRlcihpZCwgdGl0bGUsIHR5cGU6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGlkICYmIHRpdGxlKSB7XG4gICAgICBjb25zdCB0aXRsZVNsdWcgPSBzbHVnaWZ5KHRpdGxlKTtcbiAgICAgIGNvbnN0IHsgc2NoZWRhQmFzZVBhdGgsIGVudGl0YUJhc2VQYXRoIH0gPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0KCdwYXRocycpO1xuICAgICAgY29uc3QgYmFzZVBhdGggPSB0eXBlID09PSAnZW50aXR5JyA/IGVudGl0YUJhc2VQYXRoIDogc2NoZWRhQmFzZVBhdGg7XG4gICAgICByZXR1cm4gYC8ke2Jhc2VQYXRofS8ke2lkfS8ke3RpdGxlU2x1Z31gO1xuICAgIH0gcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIHN0cmluZ0xpbWl0ZXIoY29udGVudDogc3RyaW5nLCBvcHRpb25zOiB7IG1heExlbmd0aDogbnVtYmVyOyBjaGFyOiBzdHJpbmcgfSk6IHN0cmluZyB7XG4gICAgbGV0IHJlcyA9IGNvbnRlbnQ7XG4gICAgaWYgKGNvbnRlbnQgJiYgb3B0aW9ucy5tYXhMZW5ndGgpIHtcbiAgICAgIHJlcyA9IGNvbnRlbnQuc2xpY2UoMCwgb3B0aW9ucy5tYXhMZW5ndGgpO1xuICAgICAgaWYgKG9wdGlvbnMuY2hhciAmJiByZXMgIT09IGNvbnRlbnQpIHtcbiAgICAgICAgcmVzICs9IG9wdGlvbnMuY2hhcjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHNldFRpdGxlKHRpdGxlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmlubmVyVGl0bGVEYXRhLm5leHQoe1xuICAgICAgdGl0bGU6IHsgbWFpbjogeyB0ZXh0OiB0aXRsZSB9IH1cbiAgICB9KTtcbiAgfVxufVxuIl19