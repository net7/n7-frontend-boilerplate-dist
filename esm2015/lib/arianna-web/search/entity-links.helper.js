import { Subject, merge, fromEvent } from 'rxjs';
import { debounceTime, switchMap, mapTo } from 'rxjs/operators';
// import { isEmpty } from 'lodash';
const ENTITY_LINKS_CLASS = 'entity-links';
const ENTITY_LINKS_PARENT_SELECTOR = '.n7-facets-wrapper__group:last-child .n7-facet__section-input-links';
const loaderItem = {
    counter: null,
    label: 'Caricamento in corso...',
    searchData: [],
    value: '__loading__',
};
export default {
    paginationState: {},
    paginate$: new Subject(),
    listenToChanges(dataSource) {
        const facetsWrapperEH = dataSource.getWidgetEventHandler('facets-wrapper');
        return merge(facetsWrapperEH.internalFacetsChange$.pipe(mapTo(null)), this.paginate$).pipe(debounceTime(500), switchMap((pagination) => {
            const requestParams = dataSource.searchModel.getRequestParams();
            const internalFilters = dataSource.searchModel.getInternalFilters();
            this.paginationState.offset = pagination ? this.paginationState.offset : 0;
            this.updateParamsOffset(requestParams);
            const filters = [...requestParams.filters, ...internalFilters];
            const params = {
                searchParameters: Object.assign(Object.assign({ totalCount: 100, gallery: !!(dataSource.searchModel.getId() === 'aw-gallery-layout') }, requestParams), { filters }),
            };
            // initial loader
            if (this.paginationState.offset === 0) {
                this.addInitialLoader(dataSource);
            }
            return dataSource.getFacetsReq$(params);
        }));
    },
    onFacetsResponse(searchModel, facets) {
        // pagination control
        const entityLinksFacet = facets.find(({ id }) => id === ENTITY_LINKS_CLASS);
        const { totalCount } = entityLinksFacet;
        let { limit, offset } = this.paginationState;
        if (typeof limit === 'undefined') {
            limit = 10;
        }
        if (typeof offset === 'undefined') {
            offset = 0;
        }
        this.paginationState.totalCount = totalCount;
        if (offset > 0) {
            const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
            const oldData = entityLinksInput.getData() || [];
            // remove fake loading element
            if (oldData.length) {
                oldData.pop();
            }
            const newData = oldData.concat(entityLinksFacet.data);
            entityLinksFacet.data = newData;
        }
        if (this.paginationState.totalCount > (limit + offset)) {
            entityLinksFacet.data.push(loaderItem);
        }
        // empty state
        const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
        entityLinksInput.setIsEmpty(!totalCount);
        // fix scroll
        if (offset === 0) {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            if (scrollEl) {
                scrollEl.scrollTop = 0;
            }
        }
        // update loading state
        this.paginationState.loading = false;
    },
    initPagination(searchModel) {
        searchModel.getFilters().filter((filter) => (filter.pagination)).forEach(({ pagination }) => {
            this.paginationState = Object.assign(Object.assign(Object.assign({}, pagination), this.paginationState), { loading: false });
        });
        setTimeout(() => {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            const scroll$ = fromEvent(scrollEl, 'scroll');
            scroll$.pipe(debounceTime(300)).subscribe(({ target }) => {
                const { scrollTop, clientHeight, scrollHeight } = target;
                const { offset, limit, totalCount, loading } = this.paginationState;
                const margin = 150;
                if ((scrollTop + clientHeight >= scrollHeight - margin)
                    && (offset + limit < totalCount)
                    && loading === false) {
                    this.paginationState.loading = true;
                    this.paginationState.offset = offset + limit;
                    this.paginate$.next(this.paginationState);
                }
            });
        });
    },
    /* clearInternalFilters(searchModel) {
      const searchFilter = searchModel.getFiltersByFacetId('entity-search')[0];
      const typesFilter = searchModel.getFiltersByFacetId('entity-types')[0];
      if (!isEmpty(searchFilter.value) || !isEmpty(typesFilter.value)) {
        searchFilter.value = '';
        typesFilter.value = [];
        searchModel.updateInputsFromFilters();
      }
    }, */
    updateParamsOffset(params) {
        const entityLinksFilter = params.filters
            .find(({ facetId }) => facetId === ENTITY_LINKS_CLASS);
        if (entityLinksFilter) {
            entityLinksFilter.pagination.offset = this.paginationState.offset;
        }
    },
    resetOffset() {
        this.paginationState.offset = 0;
    },
    addInitialLoader(dataSource) {
        dataSource.searchModel.setInputData(ENTITY_LINKS_CLASS, [loaderItem]);
        const facetsWrapperDS = dataSource.getWidgetDataSource('facets-wrapper');
        facetsWrapperDS.updateInputLinks();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWxpbmtzLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuNy1mcm9udGVuZC9ib2lsZXJwbGF0ZS8iLCJzb3VyY2VzIjpbImxpYi9hcmlhbm5hLXdlYi9zZWFyY2gvZW50aXR5LWxpbmtzLmhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUNMLFlBQVksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUMvQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLG9DQUFvQztBQUVwQyxNQUFNLGtCQUFrQixHQUFHLGNBQWMsQ0FBQztBQUMxQyxNQUFNLDRCQUE0QixHQUFHLHFFQUFxRSxDQUFDO0FBRTNHLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLE9BQU8sRUFBRSxJQUFJO0lBQ2IsS0FBSyxFQUFFLHlCQUF5QjtJQUNoQyxVQUFVLEVBQUUsRUFBRTtJQUNkLEtBQUssRUFBRSxhQUFhO0NBQ3JCLENBQUM7QUFFRixlQUFlO0lBQ2IsZUFBZSxFQUFFLEVBQVM7SUFDMUIsU0FBUyxFQUFFLElBQUksT0FBTyxFQUFFO0lBQ3hCLGVBQWUsQ0FBQyxVQUFVO1FBQ3hCLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNFLE9BQU8sS0FBSyxDQUNWLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQ3ZELElBQUksQ0FBQyxTQUFTLENBQ2YsQ0FBQyxJQUFJLENBQ0osWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUNqQixTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUN2QixNQUFNLGFBQWEsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDaEUsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFD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LE9BQU8sR0FBRyxJQUFJLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxLQUFLLENBQUM7b0JBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztpQkFDM0M7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7Ozs7OztTQVFLO0lBQ0wsa0JBQWtCLENBQUMsTUFBTTtRQUN2QixNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxPQUFPO2FBQ3JDLElBQUksQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDLE9BQU8sS0FBSyxrQkFBa0IsQ0FBQyxDQUFDO1FBRXpELElBQUksaUJBQWlCLEVBQUU7WUFDckIsaUJBQWlCLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQztTQUNuRTtJQUNILENBQUM7SUFDRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDRCxnQkFBZ0IsQ0FBQyxVQUFVO1FBQ3pCLFVBQVUsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLGtCQUFrQixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUN0RSxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6RSxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIG1lcmdlLCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtcclxuICBkZWJvdW5jZVRpbWUsIHN3aXRjaE1hcCwgbWFwVG9cclxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbi8vIGltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICdsb2Rhc2gnO1xyXG5cclxuY29uc3QgRU5USVRZX0xJTktTX0NMQVNTID0gJ2VudGl0eS1saW5rcyc7XHJcbmNvbnN0IEVOVElUWV9MSU5LU19QQVJFTlRfU0VMRUNUT1IgPSAnLm43LWZhY2V0cy13cmFwcGVyX19ncm91cDpsYXN0LWNoaWxkIC5uNy1mYWNldF9fc2VjdGlvbi1pbnB1dC1saW5rcyc7XHJcblxyXG5jb25zdCBsb2FkZXJJdGVtID0ge1xyXG4gIGNvdW50ZXI6IG51bGwsXHJcbiAgbGFiZWw6ICdDYXJpY2FtZW50byBpbiBjb3Jzby4uLicsXHJcbiAgc2VhcmNoRGF0YTogW10sXHJcbiAgdmFsdWU6ICdfX2xvYWRpbmdfXycsXHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCB7XHJcbiAgcGFnaW5hdGlvblN0YXRlOiB7fSBhcyBhbnksXHJcbiAgcGFnaW5hdGUkOiBuZXcgU3ViamVjdCgpLFxyXG4gIGxpc3RlblRvQ2hhbmdlcyhkYXRhU291cmNlKSB7XHJcbiAgICBjb25zdCBmYWNldHNXcmFwcGVyRUggPSBkYXRhU291cmNlLmdldFdpZGdldEV2ZW50SGFuZGxlcignZmFjZXRzLXdyYXBwZXInKTtcclxuICAgIHJldHVybiBtZXJnZShcclxuICAgICAgZmFjZXRzV3JhcHBlckVILmludGVybmFsRmFjZXRzQ2hhbmdlJC5waXBlKG1hcFRvKG51bGwpKSxcclxuICAgICAgdGhpcy5wYWdpbmF0ZSQsXHJcbiAgICApLnBpcGUoXHJcbiAgICAgIGRlYm91bmNlVGltZSg1MDApLFxyXG4gICAgICBzd2l0Y2hNYXAoKHBhZ2luYXRpb24pID0+IHtcclxuICAgICAgICBjb25zdCByZXF1ZXN0UGFyYW1zID0gZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5nZXRSZXF1ZXN0UGFyYW1zKCk7XHJcbiAgICAgICAgY29uc3QgaW50ZXJuYWxGaWx0ZXJzID0gZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5nZXRJbnRlcm5hbEZpbHRlcnMoKTtcclxuICAgICAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgPSBwYWdpbmF0aW9uID8gdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0IDogMDtcclxuICAgICAgICB0aGlzLnVwZGF0ZVBhcmFtc09mZnNldChyZXF1ZXN0UGFyYW1zKTtcclxuICAgICAgICBjb25zdCBmaWx0ZXJzID0gWy4uLnJlcXVlc3RQYXJhbXMuZmlsdGVycywgLi4uaW50ZXJuYWxGaWx0ZXJzXTtcclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgICAgICBzZWFyY2hQYXJhbWV0ZXJzOiB7XHJcbiAgICAgICAgICAgIHRvdGFsQ291bnQ6IDEwMCxcclxuICAgICAgICAgICAgZ2FsbGVyeTogISEoZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5nZXRJZCgpID09PSAnYXctZ2FsbGVyeS1sYXlvdXQnKSxcclxuICAgICAgICAgICAgLi4ucmVxdWVzdFBhcmFtcyxcclxuICAgICAgICAgICAgZmlsdGVyc1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBpbml0aWFsIGxvYWRlclxyXG4gICAgICAgIGlmICh0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgPT09IDApIHtcclxuICAgICAgICAgIHRoaXMuYWRkSW5pdGlhbExvYWRlcihkYXRhU291cmNlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBkYXRhU291cmNlLmdldEZhY2V0c1JlcSQocGFyYW1zKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfSxcclxuICBvbkZhY2V0c1Jlc3BvbnNlKHNlYXJjaE1vZGVsLCBmYWNldHMpIHtcclxuICAgIC8vIHBhZ2luYXRpb24gY29udHJvbFxyXG4gICAgY29uc3QgZW50aXR5TGlua3NGYWNldCA9IGZhY2V0cy5maW5kKCh7IGlkIH0pID0+IGlkID09PSBFTlRJVFlfTElOS1NfQ0xBU1MpO1xyXG4gICAgY29uc3QgeyB0b3RhbENvdW50IH0gPSBlbnRpdHlMaW5rc0ZhY2V0O1xyXG4gICAgbGV0IHsgbGltaXQsIG9mZnNldCB9ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGU7XHJcbiAgICBpZiAodHlwZW9mIGxpbWl0ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBsaW1pdCA9IDEwO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBvZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIG9mZnNldCA9IDA7XHJcbiAgICB9XHJcbiAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS50b3RhbENvdW50ID0gdG90YWxDb3VudDtcclxuICAgIGlmIChvZmZzZXQgPiAwKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eUxpbmtzSW5wdXQgPSBzZWFyY2hNb2RlbC5nZXRJbnB1dEJ5RmFjZXRJZChFTlRJVFlfTElOS1NfQ0xBU1MpO1xyXG4gICAgICBjb25zdCBvbGREYXRhID0gZW50aXR5TGlua3NJbnB1dC5nZXREYXRhKCkgfHwgW107XHJcbiAgICAgIC8vIHJlbW92ZSBmYWtlIGxvYWRpbmcgZWxlbWVudFxyXG4gICAgICBpZiAob2xkRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICBvbGREYXRhLnBvcCgpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG5ld0RhdGEgPSBvbGREYXRhLmNvbmNhdChlbnRpdHlMaW5rc0ZhY2V0LmRhdGEpO1xyXG4gICAgICBlbnRpdHlMaW5rc0ZhY2V0LmRhdGEgPSBuZXdEYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnBhZ2luYXRpb25TdGF0ZS50b3RhbENvdW50ID4gKGxpbWl0ICsgb2Zmc2V0KSkge1xyXG4gICAgICBlbnRpdHlMaW5rc0ZhY2V0LmRhdGEucHVzaChsb2FkZXJJdGVtKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBlbXB0eSBzdGF0ZVxyXG4gICAgY29uc3QgZW50aXR5TGlua3NJbnB1dCA9IHNlYXJjaE1vZGVsLmdldElucHV0QnlGYWNldElkKEVOVElUWV9MSU5LU19DTEFTUyk7XHJcbiAgICBlbnRpdHlMaW5rc0lucHV0LnNldElzRW1wdHkoIXRvdGFsQ291bnQpO1xyXG5cclxuICAgIC8vIGZpeCBzY3JvbGxcclxuICAgIGlmIChvZmZzZXQgPT09IDApIHtcclxuICAgICAgY29uc3Qgc2Nyb2xsRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKEVOVElUWV9MSU5LU19QQVJFTlRfU0VMRUNUT1IpO1xyXG4gICAgICBpZiAoc2Nyb2xsRWwpIHtcclxuICAgICAgICBzY3JvbGxFbC5zY3JvbGxUb3AgPSAwO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gdXBkYXRlIGxvYWRpbmcgc3RhdGVcclxuICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLmxvYWRpbmcgPSBmYWxzZTtcclxuICB9LFxyXG4gIGluaXRQYWdpbmF0aW9uKHNlYXJjaE1vZGVsKSB7XHJcbiAgICBzZWFyY2hNb2RlbC5nZXRGaWx0ZXJzKCkuZmlsdGVyKChmaWx0ZXIpID0+IChcclxuICAgICAgZmlsdGVyLnBhZ2luYXRpb25cclxuICAgICkpLmZvckVhY2goKHsgcGFnaW5hdGlvbiB9KSA9PiB7XHJcbiAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlID0ge1xyXG4gICAgICAgIC4uLnBhZ2luYXRpb24sXHJcbiAgICAgICAgLi4udGhpcy5wYWdpbmF0aW9uU3RhdGUsXHJcbiAgICAgICAgbG9hZGluZzogZmFsc2VcclxuICAgICAgfTtcclxuICAgIH0pO1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHNjcm9sbEVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihFTlRJVFlfTElOS1NfUEFSRU5UX1NFTEVDVE9SKTtcclxuICAgICAgY29uc3Qgc2Nyb2xsJCA9IGZyb21FdmVudChzY3JvbGxFbCwgJ3Njcm9sbCcpO1xyXG4gICAgICBzY3JvbGwkLnBpcGUoXHJcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMClcclxuICAgICAgKS5zdWJzY3JpYmUoKHsgdGFyZ2V0IH0pID0+IHtcclxuICAgICAgICBjb25zdCB7IHNjcm9sbFRvcCwgY2xpZW50SGVpZ2h0LCBzY3JvbGxIZWlnaHQgfSA9IHRhcmdldCBhcyBIVE1MRWxlbWVudDtcclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICBvZmZzZXQsIGxpbWl0LCB0b3RhbENvdW50LCBsb2FkaW5nXHJcbiAgICAgICAgfSA9IHRoaXMucGFnaW5hdGlvblN0YXRlO1xyXG4gICAgICAgIGNvbnN0IG1hcmdpbiA9IDE1MDtcclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICAoc2Nyb2xsVG9wICsgY2xpZW50SGVpZ2h0ID49IHNjcm9sbEhlaWdodCAtIG1hcmdpbilcclxuICAgICAgICAgICYmIChvZmZzZXQgKyBsaW1pdCA8IHRvdGFsQ291bnQpXHJcbiAgICAgICAgICAmJiBsb2FkaW5nID09PSBmYWxzZVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUubG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgPSBvZmZzZXQgKyBsaW1pdDtcclxuICAgICAgICAgIHRoaXMucGFnaW5hdGUkLm5leHQodGhpcy5wYWdpbmF0aW9uU3RhdGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9LFxyXG4gIC8qIGNsZWFySW50ZXJuYWxGaWx0ZXJzKHNlYXJjaE1vZGVsKSB7XHJcbiAgICBjb25zdCBzZWFyY2hGaWx0ZXIgPSBzZWFyY2hNb2RlbC5nZXRGaWx0ZXJzQnlGYWNldElkKCdlbnRpdHktc2VhcmNoJylbMF07XHJcbiAgICBjb25zdCB0eXBlc0ZpbHRlciA9IHNlYXJjaE1vZGVsLmdldEZpbHRlcnNCeUZhY2V0SWQoJ2VudGl0eS10eXBlcycpWzBdO1xyXG4gICAgaWYgKCFpc0VtcHR5KHNlYXJjaEZpbHRlci52YWx1ZSkgfHwgIWlzRW1wdHkodHlwZXNGaWx0ZXIudmFsdWUpKSB7XHJcbiAgICAgIHNlYXJjaEZpbHRlci52YWx1ZSA9ICcnO1xyXG4gICAgICB0eXBlc0ZpbHRlci52YWx1ZSA9IFtdO1xyXG4gICAgICBzZWFyY2hNb2RlbC51cGRhdGVJbnB1dHNGcm9tRmlsdGVycygpO1xyXG4gICAgfVxyXG4gIH0sICovXHJcbiAgdXBkYXRlUGFyYW1zT2Zmc2V0KHBhcmFtcykge1xyXG4gICAgY29uc3QgZW50aXR5TGlua3NGaWx0ZXIgPSBwYXJhbXMuZmlsdGVyc1xyXG4gICAgICAuZmluZCgoeyBmYWNldElkIH0pID0+IGZhY2V0SWQgPT09IEVOVElUWV9MSU5LU19DTEFTUyk7XHJcblxyXG4gICAgaWYgKGVudGl0eUxpbmtzRmlsdGVyKSB7XHJcbiAgICAgIGVudGl0eUxpbmtzRmlsdGVyLnBhZ2luYXRpb24ub2Zmc2V0ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGUub2Zmc2V0O1xyXG4gICAgfVxyXG4gIH0sXHJcbiAgcmVzZXRPZmZzZXQoKSB7XHJcbiAgICB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgPSAwO1xyXG4gIH0sXHJcbiAgYWRkSW5pdGlhbExvYWRlcihkYXRhU291cmNlKSB7XHJcbiAgICBkYXRhU291cmNlLnNlYXJjaE1vZGVsLnNldElucHV0RGF0YShFTlRJVFlfTElOS1NfQ0xBU1MsIFtsb2FkZXJJdGVtXSk7XHJcbiAgICBjb25zdCBmYWNldHNXcmFwcGVyRFMgPSBkYXRhU291cmNlLmdldFdpZGdldERhdGFTb3VyY2UoJ2ZhY2V0cy13cmFwcGVyJyk7XHJcbiAgICBmYWNldHNXcmFwcGVyRFMudXBkYXRlSW5wdXRMaW5rcygpO1xyXG4gIH1cclxufTtcclxuIl19