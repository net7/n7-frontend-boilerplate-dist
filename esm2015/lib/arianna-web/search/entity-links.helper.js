import { Subject, merge, fromEvent } from 'rxjs';
import { debounceTime, switchMap, mapTo } from 'rxjs/operators';
// import { isEmpty } from 'lodash';
const ENTITY_LINKS_CLASS = 'entity-links';
const ENTITY_LINKS_PARENT_SELECTOR = '.n7-facets-wrapper__group:last-child .n7-facet__section-input-links';
const loaderItem = {
    counter: null,
    label: 'Caricamento in corso...',
    searchData: [],
    value: '__loading__',
};
export default {
    paginationState: {},
    paginate$: new Subject(),
    listenToChanges(dataSource) {
        const facetsWrapperEH = dataSource.getWidgetEventHandler('facets-wrapper');
        return merge(facetsWrapperEH.internalFacetsChange$.pipe(mapTo(null)), this.paginate$).pipe(debounceTime(500), switchMap((pagination) => {
            const requestParams = dataSource.searchModel.getRequestParams();
            const internalFilters = dataSource.searchModel.getInternalFilters();
            this.paginationState.offset = pagination ? this.paginationState.offset : 0;
            this.updateParamsOffset(requestParams);
            const filters = [...requestParams.filters, ...internalFilters];
            const params = {
                searchParameters: Object.assign(Object.assign({ totalCount: 100, gallery: !!(dataSource.searchModel.getId() === 'aw-gallery-layout') }, requestParams), { filters }),
            };
            // initial loader
            if (this.paginationState.offset === 0) {
                this.addInitialLoader(dataSource);
            }
            return dataSource.getFacetsReq$(params);
        }));
    },
    onFacetsResponse(searchModel, facets) {
        // pagination control
        const entityLinksFacet = facets.find(({ id }) => id === ENTITY_LINKS_CLASS);
        const { totalCount } = entityLinksFacet;
        let { limit, offset } = this.paginationState;
        if (typeof limit === 'undefined') {
            limit = 10;
        }
        if (typeof offset === 'undefined') {
            offset = 0;
        }
        this.paginationState.totalCount = totalCount;
        if (offset > 0) {
            const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
            const oldData = entityLinksInput.getData() || [];
            // remove fake loading element
            if (oldData.length) {
                oldData.pop();
            }
            const newData = oldData.concat(entityLinksFacet.data);
            entityLinksFacet.data = newData;
        }
        if (this.paginationState.totalCount > (limit + offset)) {
            entityLinksFacet.data.push(loaderItem);
        }
        // empty state
        const entityLinksInput = searchModel.getInputByFacetId(ENTITY_LINKS_CLASS);
        entityLinksInput.setIsEmpty(!totalCount);
        // fix scroll
        if (offset === 0) {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            if (scrollEl) {
                scrollEl.scrollTop = 0;
            }
        }
        // update loading state
        this.paginationState.loading = false;
    },
    initPagination(searchModel) {
        searchModel.getFilters().filter((filter) => (filter.pagination)).forEach(({ pagination }) => {
            this.paginationState = Object.assign(Object.assign(Object.assign({}, pagination), this.paginationState), { loading: false });
        });
        setTimeout(() => {
            const scrollEl = document.querySelector(ENTITY_LINKS_PARENT_SELECTOR);
            const scroll$ = fromEvent(scrollEl, 'scroll');
            scroll$.pipe(debounceTime(300)).subscribe(({ target }) => {
                const { scrollTop, clientHeight, scrollHeight } = target;
                const { offset, limit, totalCount, loading } = this.paginationState;
                const margin = 150;
                if ((scrollTop + clientHeight >= scrollHeight - margin)
                    && (offset + limit < totalCount)
                    && loading === false) {
                    this.paginationState.loading = true;
                    this.paginationState.offset = offset + limit;
                    this.paginate$.next(this.paginationState);
                }
            });
        });
    },
    /* clearInternalFilters(searchModel) {
      const searchFilter = searchModel.getFiltersByFacetId('entity-search')[0];
      const typesFilter = searchModel.getFiltersByFacetId('entity-types')[0];
      if (!isEmpty(searchFilter.value) || !isEmpty(typesFilter.value)) {
        searchFilter.value = '';
        typesFilter.value = [];
        searchModel.updateInputsFromFilters();
      }
    }, */
    updateParamsOffset(params) {
        const entityLinksFilter = params.filters
            .find(({ facetId }) => facetId === ENTITY_LINKS_CLASS);
        if (entityLinksFilter) {
            entityLinksFilter.pagination.offset = this.paginationState.offset;
        }
    },
    resetOffset() {
        this.paginationState.offset = 0;
    },
    addInitialLoader(dataSource) {
        dataSource.searchModel.setInputData(ENTITY_LINKS_CLASS, [loaderItem]);
        const facetsWrapperDS = dataSource.getWidgetDataSource('facets-wrapper');
        facetsWrapperDS.updateInputLinks();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWxpbmtzLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuNy1mcm9udGVuZC9ib2lsZXJwbGF0ZS8iLCJzb3VyY2VzIjpbImxpYi9hcmlhbm5hLXdlYi9zZWFyY2gvZW50aXR5LWxpbmtzLmhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUNMLFlBQVksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUMvQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLG9DQUFvQztBQUVwQyxNQUFNLGtCQUFrQixHQUFHLGNBQWMsQ0FBQztBQUMxQyxNQUFNLDRCQUE0QixHQUFHLHFFQUFxRSxDQUFDO0FBRTNHLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLE9BQU8sRUFBRSxJQUFJO0lBQ2IsS0FBSyxFQUFFLHlCQUF5QjtJQUNoQyxVQUFVLEVBQUUsRUFBRTtJQUNkLEtBQUssRUFBRSxhQUFhO0NBQ3JCLENBQUM7QUFFRixlQUFlO0lBQ2IsZUFBZSxFQUFFLEVBQVM7SUFDMUIsU0FBUyxFQUFFLElBQUksT0FBTyxFQUFFO0lBQ3hCLGVBQWUsQ0FBQyxVQUFVO1FBQ3hCLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNFLE9BQU8sS0FBSyxDQUNWLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQ3ZELElBQUksQ0FBQyxTQUFTLENBQ2YsQ0FBQyxJQUFJLENBQ0osWUFBWSxDQUFDLEdBQUcsQ0FBQyxFQUNqQixTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRTtZQUN2QixNQUFNLGFBQWEsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDaEUsTUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFD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LE9BQU8sR0FBRyxJQUFJLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxLQUFLLENBQUM7b0JBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztpQkFDM0M7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7Ozs7OztTQVFLO0lBQ0wsa0JBQWtCLENBQUMsTUFBTTtRQUN2QixNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxPQUFPO2FBQ3JDLElBQUksQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDLE9BQU8sS0FBSyxrQkFBa0IsQ0FBQyxDQUFDO1FBRXpELElBQUksaUJBQWlCLEVBQUU7WUFDckIsaUJBQWlCLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQztTQUNuRTtJQUNILENBQUM7SUFDRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDRCxnQkFBZ0IsQ0FBQyxVQUFVO1FBQ3pCLFVBQVUsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLGtCQUFrQixFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUN0RSxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6RSxlQUFlLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QsIG1lcmdlLCBmcm9tRXZlbnQgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRlYm91bmNlVGltZSwgc3dpdGNoTWFwLCBtYXBUb1xufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG4vLyBpbXBvcnQgeyBpc0VtcHR5IH0gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgRU5USVRZX0xJTktTX0NMQVNTID0gJ2VudGl0eS1saW5rcyc7XG5jb25zdCBFTlRJVFlfTElOS1NfUEFSRU5UX1NFTEVDVE9SID0gJy5uNy1mYWNldHMtd3JhcHBlcl9fZ3JvdXA6bGFzdC1jaGlsZCAubjctZmFjZXRfX3NlY3Rpb24taW5wdXQtbGlua3MnO1xuXG5jb25zdCBsb2FkZXJJdGVtID0ge1xuICBjb3VudGVyOiBudWxsLFxuICBsYWJlbDogJ0NhcmljYW1lbnRvIGluIGNvcnNvLi4uJyxcbiAgc2VhcmNoRGF0YTogW10sXG4gIHZhbHVlOiAnX19sb2FkaW5nX18nLFxufTtcblxuZXhwb3J0IGRlZmF1bHQge1xuICBwYWdpbmF0aW9uU3RhdGU6IHt9IGFzIGFueSxcbiAgcGFnaW5hdGUkOiBuZXcgU3ViamVjdCgpLFxuICBsaXN0ZW5Ub0NoYW5nZXMoZGF0YVNvdXJjZSkge1xuICAgIGNvbnN0IGZhY2V0c1dyYXBwZXJFSCA9IGRhdGFTb3VyY2UuZ2V0V2lkZ2V0RXZlbnRIYW5kbGVyKCdmYWNldHMtd3JhcHBlcicpO1xuICAgIHJldHVybiBtZXJnZShcbiAgICAgIGZhY2V0c1dyYXBwZXJFSC5pbnRlcm5hbEZhY2V0c0NoYW5nZSQucGlwZShtYXBUbyhudWxsKSksXG4gICAgICB0aGlzLnBhZ2luYXRlJCxcbiAgICApLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoNTAwKSxcbiAgICAgIHN3aXRjaE1hcCgocGFnaW5hdGlvbikgPT4ge1xuICAgICAgICBjb25zdCByZXF1ZXN0UGFyYW1zID0gZGF0YVNvdXJjZS5zZWFyY2hNb2RlbC5nZXRSZXF1ZXN0UGFyYW1zKCk7XG4gICAgICAgIGNvbnN0IGludGVybmFsRmlsdGVycyA9IGRhdGFTb3VyY2Uuc2VhcmNoTW9kZWwuZ2V0SW50ZXJuYWxGaWx0ZXJzKCk7XG4gICAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IHBhZ2luYXRpb24gPyB0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgOiAwO1xuICAgICAgICB0aGlzLnVwZGF0ZVBhcmFtc09mZnNldChyZXF1ZXN0UGFyYW1zKTtcbiAgICAgICAgY29uc3QgZmlsdGVycyA9IFsuLi5yZXF1ZXN0UGFyYW1zLmZpbHRlcnMsIC4uLmludGVybmFsRmlsdGVyc107XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgICAgICBzZWFyY2hQYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICB0b3RhbENvdW50OiAxMDAsXG4gICAgICAgICAgICBnYWxsZXJ5OiAhIShkYXRhU291cmNlLnNlYXJjaE1vZGVsLmdldElkKCkgPT09ICdhdy1nYWxsZXJ5LWxheW91dCcpLFxuICAgICAgICAgICAgLi4ucmVxdWVzdFBhcmFtcyxcbiAgICAgICAgICAgIGZpbHRlcnNcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIGluaXRpYWwgbG9hZGVyXG4gICAgICAgIGlmICh0aGlzLnBhZ2luYXRpb25TdGF0ZS5vZmZzZXQgPT09IDApIHtcbiAgICAgICAgICB0aGlzLmFkZEluaXRpYWxMb2FkZXIoZGF0YVNvdXJjZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YVNvdXJjZS5nZXRGYWNldHNSZXEkKHBhcmFtcyk7XG4gICAgICB9KVxuICAgICk7XG4gIH0sXG4gIG9uRmFjZXRzUmVzcG9uc2Uoc2VhcmNoTW9kZWwsIGZhY2V0cykge1xuICAgIC8vIHBhZ2luYXRpb24gY29udHJvbFxuICAgIGNvbnN0IGVudGl0eUxpbmtzRmFjZXQgPSBmYWNldHMuZmluZCgoeyBpZCB9KSA9PiBpZCA9PT0gRU5USVRZX0xJTktTX0NMQVNTKTtcbiAgICBjb25zdCB7IHRvdGFsQ291bnQgfSA9IGVudGl0eUxpbmtzRmFjZXQ7XG4gICAgbGV0IHsgbGltaXQsIG9mZnNldCB9ID0gdGhpcy5wYWdpbmF0aW9uU3RhdGU7XG4gICAgaWYgKHR5cGVvZiBsaW1pdCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGxpbWl0ID0gMTA7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb2Zmc2V0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgb2Zmc2V0ID0gMDtcbiAgICB9XG4gICAgdGhpcy5wYWdpbmF0aW9uU3RhdGUudG90YWxDb3VudCA9IHRvdGFsQ291bnQ7XG4gICAgaWYgKG9mZnNldCA+IDApIHtcbiAgICAgIGNvbnN0IGVudGl0eUxpbmtzSW5wdXQgPSBzZWFyY2hNb2RlbC5nZXRJbnB1dEJ5RmFjZXRJZChFTlRJVFlfTElOS1NfQ0xBU1MpO1xuICAgICAgY29uc3Qgb2xkRGF0YSA9IGVudGl0eUxpbmtzSW5wdXQuZ2V0RGF0YSgpIHx8IFtdO1xuICAgICAgLy8gcmVtb3ZlIGZha2UgbG9hZGluZyBlbGVtZW50XG4gICAgICBpZiAob2xkRGF0YS5sZW5ndGgpIHtcbiAgICAgICAgb2xkRGF0YS5wb3AoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5ld0RhdGEgPSBvbGREYXRhLmNvbmNhdChlbnRpdHlMaW5rc0ZhY2V0LmRhdGEpO1xuICAgICAgZW50aXR5TGlua3NGYWNldC5kYXRhID0gbmV3RGF0YTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wYWdpbmF0aW9uU3RhdGUudG90YWxDb3VudCA+IChsaW1pdCArIG9mZnNldCkpIHtcbiAgICAgIGVudGl0eUxpbmtzRmFjZXQuZGF0YS5wdXNoKGxvYWRlckl0ZW0pO1xuICAgIH1cblxuICAgIC8vIGVtcHR5IHN0YXRlXG4gICAgY29uc3QgZW50aXR5TGlua3NJbnB1dCA9IHNlYXJjaE1vZGVsLmdldElucHV0QnlGYWNldElkKEVOVElUWV9MSU5LU19DTEFTUyk7XG4gICAgZW50aXR5TGlua3NJbnB1dC5zZXRJc0VtcHR5KCF0b3RhbENvdW50KTtcblxuICAgIC8vIGZpeCBzY3JvbGxcbiAgICBpZiAob2Zmc2V0ID09PSAwKSB7XG4gICAgICBjb25zdCBzY3JvbGxFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoRU5USVRZX0xJTktTX1BBUkVOVF9TRUxFQ1RPUik7XG4gICAgICBpZiAoc2Nyb2xsRWwpIHtcbiAgICAgICAgc2Nyb2xsRWwuc2Nyb2xsVG9wID0gMDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB1cGRhdGUgbG9hZGluZyBzdGF0ZVxuICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLmxvYWRpbmcgPSBmYWxzZTtcbiAgfSxcbiAgaW5pdFBhZ2luYXRpb24oc2VhcmNoTW9kZWwpIHtcbiAgICBzZWFyY2hNb2RlbC5nZXRGaWx0ZXJzKCkuZmlsdGVyKChmaWx0ZXIpID0+IChcbiAgICAgIGZpbHRlci5wYWdpbmF0aW9uXG4gICAgKSkuZm9yRWFjaCgoeyBwYWdpbmF0aW9uIH0pID0+IHtcbiAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlID0ge1xuICAgICAgICAuLi5wYWdpbmF0aW9uLFxuICAgICAgICAuLi50aGlzLnBhZ2luYXRpb25TdGF0ZSxcbiAgICAgICAgbG9hZGluZzogZmFsc2VcbiAgICAgIH07XG4gICAgfSk7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBjb25zdCBzY3JvbGxFbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoRU5USVRZX0xJTktTX1BBUkVOVF9TRUxFQ1RPUik7XG4gICAgICBjb25zdCBzY3JvbGwkID0gZnJvbUV2ZW50KHNjcm9sbEVsLCAnc2Nyb2xsJyk7XG4gICAgICBzY3JvbGwkLnBpcGUoXG4gICAgICAgIGRlYm91bmNlVGltZSgzMDApXG4gICAgICApLnN1YnNjcmliZSgoeyB0YXJnZXQgfSkgPT4ge1xuICAgICAgICBjb25zdCB7IHNjcm9sbFRvcCwgY2xpZW50SGVpZ2h0LCBzY3JvbGxIZWlnaHQgfSA9IHRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIG9mZnNldCwgbGltaXQsIHRvdGFsQ291bnQsIGxvYWRpbmdcbiAgICAgICAgfSA9IHRoaXMucGFnaW5hdGlvblN0YXRlO1xuICAgICAgICBjb25zdCBtYXJnaW4gPSAxNTA7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAoc2Nyb2xsVG9wICsgY2xpZW50SGVpZ2h0ID49IHNjcm9sbEhlaWdodCAtIG1hcmdpbilcbiAgICAgICAgICAmJiAob2Zmc2V0ICsgbGltaXQgPCB0b3RhbENvdW50KVxuICAgICAgICAgICYmIGxvYWRpbmcgPT09IGZhbHNlXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLmxvYWRpbmcgPSB0cnVlO1xuICAgICAgICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IG9mZnNldCArIGxpbWl0O1xuICAgICAgICAgIHRoaXMucGFnaW5hdGUkLm5leHQodGhpcy5wYWdpbmF0aW9uU3RhdGUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSxcbiAgLyogY2xlYXJJbnRlcm5hbEZpbHRlcnMoc2VhcmNoTW9kZWwpIHtcbiAgICBjb25zdCBzZWFyY2hGaWx0ZXIgPSBzZWFyY2hNb2RlbC5nZXRGaWx0ZXJzQnlGYWNldElkKCdlbnRpdHktc2VhcmNoJylbMF07XG4gICAgY29uc3QgdHlwZXNGaWx0ZXIgPSBzZWFyY2hNb2RlbC5nZXRGaWx0ZXJzQnlGYWNldElkKCdlbnRpdHktdHlwZXMnKVswXTtcbiAgICBpZiAoIWlzRW1wdHkoc2VhcmNoRmlsdGVyLnZhbHVlKSB8fCAhaXNFbXB0eSh0eXBlc0ZpbHRlci52YWx1ZSkpIHtcbiAgICAgIHNlYXJjaEZpbHRlci52YWx1ZSA9ICcnO1xuICAgICAgdHlwZXNGaWx0ZXIudmFsdWUgPSBbXTtcbiAgICAgIHNlYXJjaE1vZGVsLnVwZGF0ZUlucHV0c0Zyb21GaWx0ZXJzKCk7XG4gICAgfVxuICB9LCAqL1xuICB1cGRhdGVQYXJhbXNPZmZzZXQocGFyYW1zKSB7XG4gICAgY29uc3QgZW50aXR5TGlua3NGaWx0ZXIgPSBwYXJhbXMuZmlsdGVyc1xuICAgICAgLmZpbmQoKHsgZmFjZXRJZCB9KSA9PiBmYWNldElkID09PSBFTlRJVFlfTElOS1NfQ0xBU1MpO1xuXG4gICAgaWYgKGVudGl0eUxpbmtzRmlsdGVyKSB7XG4gICAgICBlbnRpdHlMaW5rc0ZpbHRlci5wYWdpbmF0aW9uLm9mZnNldCA9IHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldDtcbiAgICB9XG4gIH0sXG4gIHJlc2V0T2Zmc2V0KCkge1xuICAgIHRoaXMucGFnaW5hdGlvblN0YXRlLm9mZnNldCA9IDA7XG4gIH0sXG4gIGFkZEluaXRpYWxMb2FkZXIoZGF0YVNvdXJjZSkge1xuICAgIGRhdGFTb3VyY2Uuc2VhcmNoTW9kZWwuc2V0SW5wdXREYXRhKEVOVElUWV9MSU5LU19DTEFTUywgW2xvYWRlckl0ZW1dKTtcbiAgICBjb25zdCBmYWNldHNXcmFwcGVyRFMgPSBkYXRhU291cmNlLmdldFdpZGdldERhdGFTb3VyY2UoJ2ZhY2V0cy13cmFwcGVyJyk7XG4gICAgZmFjZXRzV3JhcHBlckRTLnVwZGF0ZUlucHV0TGlua3MoKTtcbiAgfVxufTtcbiJdfQ==