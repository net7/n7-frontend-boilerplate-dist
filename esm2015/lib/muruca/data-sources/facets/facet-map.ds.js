import { DataSource } from '@n7-frontend/core';
import 'leaflet.markercluster';
import { Subject } from 'rxjs';
const ACTIVE_CLASS = 'is-active';
const MARKER_ICON = L.icon({
    iconUrl: '/assets/pin.png',
    iconSize: [13, 20],
    popupAnchor: [0, -15],
    className: 'marker-icon'
});
const MARKER_ICON_UNAVAILABLE = L.icon({
    iconUrl: '/assets/pin-unavailable.png',
    iconSize: [13, 20],
    popupAnchor: [0, -15],
    className: 'marker-icon'
});
const MARKER_ICON_SELECTED = L.icon({
    iconUrl: '/assets/pin-selected.png',
    iconSize: [13, 20],
    popupAnchor: [0, -15],
    className: 'marker-icon-selected'
});
export class FacetMapDS extends DataSource {
    constructor() {
        super(...arguments);
        this.value = [];
        this.markerEvents$ = new Subject();
        this.isUpdate = false;
        this.getIcon = (id, counter) => {
            if (this.value.includes(id))
                return MARKER_ICON_SELECTED;
            if (counter > 0)
                return MARKER_ICON;
            return MARKER_ICON_UNAVAILABLE;
        };
        this.getZindex = (id, counter) => {
            if (this.value.includes(id))
                return 19999;
            if (counter > 0)
                return 9999;
            return null;
        };
        this.getValue = () => this.value;
    }
    transform({ links }) {
        const markers = [];
        links
            .filter((d) => { var _a, _b; return ((_a = d.args) === null || _a === void 0 ? void 0 : _a.lat) && ((_b = d.args) === null || _b === void 0 ? void 0 : _b.lon); })
            .forEach((d) => {
            // if a link has more than one corresponding marker
            if (Array.isArray(d.args.lat)) {
                d.args.lat.forEach((element, i) => {
                    markers.push({
                        coords: [+d.args.lat[i], +d.args.lon[i]],
                        template: d.text,
                        title: d.text,
                        id: d.payload,
                        slug: d.payload,
                        counter: d.counter,
                    });
                });
            }
            else {
                // if a link has only one marker
                markers.push({
                    coords: [+d.args.lat, +d.args.lon],
                    template: d.text,
                    title: d.text,
                    id: d.payload,
                    slug: d.payload,
                    counter: d.counter,
                });
            }
        });
        return {
            containerId: 'map-canvas',
            libOptions: {
                attributionControl: false,
                minZoom: 8,
                maxBounds: [[46.8505, 10.3393], [45.6635, 12.2429]]
            },
            tileLayers: [{
                    // url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png',
                    // url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png',
                    options: null
                }],
            initialView: {
                center: [46.06, 11.21],
                zoom: 9
            },
            _setInstance: (map) => {
                this.mapInstance = map;
                this.buildMarkers(markers);
            },
        };
    }
    /**
     * Builds markers with a custom icon and adds them to the map.
     * @param markers an array of markers
     */
    buildMarkers(markers) {
        if (!markers)
            return;
        // remove all existing markers
        if (this.markerLayer) {
            this.markerLayer.clearLayers();
            this.mapInstance.removeLayer(this.markerLayer);
        }
        const markerGroup = L.markerClusterGroup({
            maxClusterRadius: 10,
            disableClusteringAtZoom: 8
        });
        markers.forEach(({ coords, template, id, slug, counter }) => {
            // create custom icon marker
            const newMarker = L.marker(coords, {
                icon: this.getIcon(id, counter),
                zIndexOffset: this.getZindex(id, counter)
            });
            if (id && slug) {
                newMarker.id = id;
                newMarker.counter = counter;
                newMarker.slug = slug;
            }
            newMarker
                // add the marker to the group
                .addTo(markerGroup)
                // add the on-click tooltip
                .bindPopup(template);
            newMarker.on('click', ({ target }) => {
                this.markerEvents$.next({
                    type: 'marker.click',
                    id: target.id
                });
            });
            newMarker.on('mouseover', ({ target }) => {
                target.openPopup();
            });
            newMarker.on('mouseout', ({ target }) => {
                target.closePopup();
            });
        });
        // add the markers to the map instance
        this.mapInstance.addLayer(markerGroup);
        // update the marker layer instance
        this.markerLayer = markerGroup;
    }
    setValue(value, update = false) {
        // prevent the search service from assigning a plain string
        // eslint-disable-next-line no-param-reassign
        if (typeof value === 'string')
            value = [value];
        if (this.value !== value) {
            this.value = value;
        }
        this.isUpdate = update || this.value === [];
        if (update && this.input) {
            const { links } = this.input;
            const updatedLinks = links.map((link) => (Object.assign(Object.assign({}, link), { classes: this.value.includes(link.payload) ? ACTIVE_CLASS : '' })));
            // update marker icons
            if (this.markerLayer) {
                this.markerLayer.eachLayer((marker) => {
                    var _a;
                    const { id } = marker;
                    const counter = ((_a = links.find(({ payload }) => payload === id)) === null || _a === void 0 ? void 0 : _a.counter) || 0;
                    marker.getPopup()._source.setIcon(this.getIcon(id, counter))
                        .setZIndexOffset(this.getZindex(id, counter));
                });
            }
            // ---
            this.update(Object.assign(Object.assign({}, this.input), { links: updatedLinks }));
        }
    }
    toggleValue(value) {
        const exists = this.value.includes(value);
        if (!exists) {
            this.value.push(value);
        }
        else if (exists) {
            this.value.splice(this.value.indexOf(value), 1);
        }
        // update
        this.setValue(this.value, true);
    }
    clear() {
        this.value = [];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjZXQtbWFwLmRzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG43LWZyb250ZW5kL2JvaWxlcnBsYXRlLyIsInNvdXJjZXMiOlsibGliL211cnVjYS9kYXRhLXNvdXJjZXMvZmFjZXRzL2ZhY2V0LW1hcC5kcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFL0MsT0FBTyx1QkFBdUIsQ0FBQztBQUMvQixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBTS9CLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQztBQXlCakMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUN6QixPQUFPLEVBQUUsaUJBQWlCO0lBQzFCLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDbEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3JCLFNBQVMsRUFBRSxhQUFhO0NBQ3pCLENBQUMsQ0FBQztBQUVILE1BQU0sdUJBQXVCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNyQyxPQUFPLEVBQUUsNkJBQTZCO0lBQ3RDLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDbEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3JCLFNBQVMsRUFBRSxhQUFhO0NBQ3pCLENBQUMsQ0FBQztBQUVILE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNsQyxPQUFPLEVBQUUsMEJBQTBCO0lBQ25DLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDbEIsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3JCLFNBQVMsRUFBRSxzQkFBc0I7Q0FDbEMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxPQUFPLFVBQVcsU0FBUSxV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LEVBQUUsT0FBTyxDQUFDLENBQUM7eUJBQ3pELGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNsRCxDQUFDLENBQUMsQ0FBQzthQUNKO1lBQ0QsTUFBTTtZQUNOLElBQUksQ0FBQyxNQUFNLGlDQUNOLElBQUksQ0FBQyxLQUFLLEtBQ2IsS0FBSyxFQUFFLFlBQVksSUFDbkIsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQWNELFdBQVcsQ0FBQyxLQUFhO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN4QjthQUFNLElBQUksTUFBTSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ2pEO1FBRUQsU0FBUztRQUNULElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBSUQsS0FBSztRQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ2xCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICdAbjctZnJvbnRlbmQvY29yZSc7XHJcbmltcG9ydCB7IE1hcERhdGEsIE1hcmtlckRhdGEgfSBmcm9tICdAbjctZnJvbnRlbmQvY29tcG9uZW50cyc7XHJcbmltcG9ydCAnbGVhZmxldC5tYXJrZXJjbHVzdGVyJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBGYWNldERhdGFTb3VyY2UgfSBmcm9tICcuL2ZhY2V0LWRhdGFzb3VyY2UnO1xyXG4vLyBsZWFmbGV0IGlzIGFscmVhZHkgcHJlc2VudCBpbiB0aGUgd2luZG93LFxyXG4vLyBhIGRvdWJsZSBpbXBvcnQgcmVzdWx0cyBpbiBlcnJvcnMgd2l0aCB0b29sdGlwcy5cclxuZGVjbGFyZSBjb25zdCBMO1xyXG5cclxuY29uc3QgQUNUSVZFX0NMQVNTID0gJ2lzLWFjdGl2ZSc7XHJcblxyXG50eXBlIEZBQ0VUX1ZBTFVFID0gc3RyaW5nW107XHJcblxyXG50eXBlIENhZGFzdHJhbFVuaXQgPSB7XHJcbiAgdGV4dDogc3RyaW5nO1xyXG4gIHBheWxvYWQ6IHN0cmluZztcclxuICBjb3VudGVyOiBudW1iZXI7XHJcbiAgYXJnczoge1xyXG4gICAgbGF0OiBzdHJpbmcgfCBudWxsO1xyXG4gICAgbG9uOiBzdHJpbmcgfCBudWxsO1xyXG4gIH07XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTWFya2VyRXZlbnQge1xyXG4gIHR5cGU6IHN0cmluZztcclxuICBpZDogc3RyaW5nO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTWFya2VyV2l0aElEIGV4dGVuZHMgTWFya2VyRGF0YSB7XHJcbiAgaWQ/OiBzdHJpbmc7XHJcbiAgY291bnRlcjogbnVtYmVyO1xyXG4gIHNsdWc6IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgTUFSS0VSX0lDT04gPSBMLmljb24oe1xyXG4gIGljb25Vcmw6ICcvYXNzZXRzL3Bpbi5wbmcnLFxyXG4gIGljb25TaXplOiBbMTMsIDIwXSxcclxuICBwb3B1cEFuY2hvcjogWzAsIC0xNV0sXHJcbiAgY2xhc3NOYW1lOiAnbWFya2VyLWljb24nXHJcbn0pO1xyXG5cclxuY29uc3QgTUFSS0VSX0lDT05fVU5BVkFJTEFCTEUgPSBMLmljb24oe1xyXG4gIGljb25Vcmw6ICcvYXNzZXRzL3Bpbi11bmF2YWlsYWJsZS5wbmcnLFxyXG4gIGljb25TaXplOiBbMTMsIDIwXSxcclxuICBwb3B1cEFuY2hvcjogWzAsIC0xNV0sXHJcbiAgY2xhc3NOYW1lOiAnbWFya2VyLWljb24nXHJcbn0pO1xyXG5cclxuY29uc3QgTUFSS0VSX0lDT05fU0VMRUNURUQgPSBMLmljb24oe1xyXG4gIGljb25Vcmw6ICcvYXNzZXRzL3Bpbi1zZWxlY3RlZC5wbmcnLFxyXG4gIGljb25TaXplOiBbMTMsIDIwXSxcclxuICBwb3B1cEFuY2hvcjogWzAsIC0xNV0sXHJcbiAgY2xhc3NOYW1lOiAnbWFya2VyLWljb24tc2VsZWN0ZWQnXHJcbn0pO1xyXG5cclxuZXhwb3J0IGNsYXNzIEZhY2V0TWFwRFMgZXh0ZW5kcyBEYXRhU291cmNlIGltcGxlbWVudHMgRmFjZXREYXRhU291cmNlIHtcclxuICBpZDogc3RyaW5nO1xyXG5cclxuICB2YWx1ZTogRkFDRVRfVkFMVUUgPSBbXTtcclxuXHJcbiAgbWFwSW5zdGFuY2U7XHJcblxyXG4gIG1hcmtlckxheWVyO1xyXG5cclxuICBtYXJrZXJFdmVudHMkID0gbmV3IFN1YmplY3Q8TWFya2VyRXZlbnQ+KCk7XHJcblxyXG4gIGlzVXBkYXRlID0gZmFsc2U7XHJcblxyXG4gIHByb3RlY3RlZCB0cmFuc2Zvcm0oeyBsaW5rcyB9OiB7IGxpbmtzOiBDYWRhc3RyYWxVbml0W10gfSk6IE1hcERhdGEge1xyXG4gICAgY29uc3QgbWFya2VycyA9IFtdO1xyXG4gICAgbGlua3NcclxuICAgICAgLmZpbHRlcigoZCkgPT4gZC5hcmdzPy5sYXQgJiYgZC5hcmdzPy5sb24pXHJcbiAgICAgIC5mb3JFYWNoKChkKSA9PiB7XHJcbiAgICAgICAgLy8gaWYgYSBsaW5rIGhhcyBtb3JlIHRoYW4gb25lIGNvcnJlc3BvbmRpbmcgbWFya2VyXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZC5hcmdzLmxhdCkpIHtcclxuICAgICAgICAgIGQuYXJncy5sYXQuZm9yRWFjaCgoZWxlbWVudCwgaSkgPT4ge1xyXG4gICAgICAgICAgICBtYXJrZXJzLnB1c2goe1xyXG4gICAgICAgICAgICAgIGNvb3JkczogWytkLmFyZ3MubGF0W2ldLCArZC5hcmdzLmxvbltpXV0gYXMgW251bWJlciwgbnVtYmVyXSxcclxuICAgICAgICAgICAgICB0ZW1wbGF0ZTogZC50ZXh0LFxyXG4gICAgICAgICAgICAgIHRpdGxlOiBkLnRleHQsXHJcbiAgICAgICAgICAgICAgaWQ6IGQucGF5bG9hZCxcclxuICAgICAgICAgICAgICBzbHVnOiBkLnBheWxvYWQsXHJcbiAgICAgICAgICAgICAgY291bnRlcjogZC5jb3VudGVyLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBpZiBhIGxpbmsgaGFzIG9ubHkgb25lIG1hcmtlclxyXG4gICAgICAgICAgbWFya2Vycy5wdXNoKHtcclxuICAgICAgICAgICAgY29vcmRzOiBbK2QuYXJncy5sYXQsICtkLmFyZ3MubG9uXSBhcyBbbnVtYmVyLCBudW1iZXJdLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZTogZC50ZXh0LFxyXG4gICAgICAgICAgICB0aXRsZTogZC50ZXh0LFxyXG4gICAgICAgICAgICBpZDogZC5wYXlsb2FkLFxyXG4gICAgICAgICAgICBzbHVnOiBkLnBheWxvYWQsXHJcbiAgICAgICAgICAgIGNvdW50ZXI6IGQuY291bnRlcixcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBjb250YWluZXJJZDogJ21hcC1jYW52YXMnLFxyXG4gICAgICBsaWJPcHRpb25zOiB7XHJcbiAgICAgICAgYXR0cmlidXRpb25Db250cm9sOiBmYWxzZSxcclxuICAgICAgICBtaW5ab29tOiA4LFxyXG4gICAgICAgIG1heEJvdW5kczogW1s0Ni44NTA1LCAxMC4zMzkzXSwgWzQ1LjY2MzUsIDEyLjI0MjldXVxyXG4gICAgICB9LFxyXG4gICAgICB0aWxlTGF5ZXJzOiBbe1xyXG4gICAgICAgIC8vIHVybDogJ2h0dHBzOi8ve3N9LnRpbGUub3BlbnN0cmVldG1hcC5vcmcve3p9L3t4fS97eX0ucG5nJyxcclxuICAgICAgICB1cmw6ICdodHRwczovL3tzfS5iYXNlbWFwcy5jYXJ0b2Nkbi5jb20vcmFzdGVydGlsZXMvdm95YWdlcl9sYWJlbHNfdW5kZXIve3p9L3t4fS97eX17cn0ucG5nJyxcclxuICAgICAgICAvLyB1cmw6ICdodHRwczovL2NhcnRvZGItYmFzZW1hcHMte3N9Lmdsb2JhbC5zc2wuZmFzdGx5Lm5ldC9saWdodF9hbGwve3p9L3t4fS97eX0ucG5nJyxcclxuICAgICAgICBvcHRpb25zOiBudWxsXHJcbiAgICAgIH1dLFxyXG4gICAgICBpbml0aWFsVmlldzoge1xyXG4gICAgICAgIGNlbnRlcjogWzQ2LjA2LCAxMS4yMV0sXHJcbiAgICAgICAgem9vbTogOVxyXG4gICAgICB9LFxyXG4gICAgICBfc2V0SW5zdGFuY2U6IChtYXApID0+IHtcclxuICAgICAgICB0aGlzLm1hcEluc3RhbmNlID0gbWFwO1xyXG4gICAgICAgIHRoaXMuYnVpbGRNYXJrZXJzKG1hcmtlcnMpO1xyXG4gICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEJ1aWxkcyBtYXJrZXJzIHdpdGggYSBjdXN0b20gaWNvbiBhbmQgYWRkcyB0aGVtIHRvIHRoZSBtYXAuXHJcbiAgICogQHBhcmFtIG1hcmtlcnMgYW4gYXJyYXkgb2YgbWFya2Vyc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRNYXJrZXJzKG1hcmtlcnM6IE1hcmtlcldpdGhJRFtdKSB7XHJcbiAgICBpZiAoIW1hcmtlcnMpIHJldHVybjtcclxuICAgIC8vIHJlbW92ZSBhbGwgZXhpc3RpbmcgbWFya2Vyc1xyXG4gICAgaWYgKHRoaXMubWFya2VyTGF5ZXIpIHtcclxuICAgICAgdGhpcy5tYXJrZXJMYXllci5jbGVhckxheWVycygpO1xyXG4gICAgICB0aGlzLm1hcEluc3RhbmNlLnJlbW92ZUxheWVyKHRoaXMubWFya2VyTGF5ZXIpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbWFya2VyR3JvdXAgPSBMLm1hcmtlckNsdXN0ZXJHcm91cChcclxuICAgICAge1xyXG4gICAgICAgIG1heENsdXN0ZXJSYWRpdXM6IDEwLFxyXG4gICAgICAgIGRpc2FibGVDbHVzdGVyaW5nQXRab29tOiA4XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgICBtYXJrZXJzLmZvckVhY2goKHtcclxuICAgICAgY29vcmRzLCB0ZW1wbGF0ZSwgaWQsIHNsdWcsIGNvdW50ZXJcclxuICAgIH0pID0+IHtcclxuICAgICAgLy8gY3JlYXRlIGN1c3RvbSBpY29uIG1hcmtlclxyXG4gICAgICBjb25zdCBuZXdNYXJrZXIgPSBMLm1hcmtlcihjb29yZHMsIHtcclxuICAgICAgICBpY29uOiB0aGlzLmdldEljb24oaWQsIGNvdW50ZXIpLFxyXG4gICAgICAgIHpJbmRleE9mZnNldDogdGhpcy5nZXRaaW5kZXgoaWQsIGNvdW50ZXIpXHJcbiAgICAgIH0pO1xyXG4gICAgICBpZiAoaWQgJiYgc2x1Zykge1xyXG4gICAgICAgIG5ld01hcmtlci5pZCA9IGlkO1xyXG4gICAgICAgIG5ld01hcmtlci5jb3VudGVyID0gY291bnRlcjtcclxuICAgICAgICBuZXdNYXJrZXIuc2x1ZyA9IHNsdWc7XHJcbiAgICAgIH1cclxuICAgICAgbmV3TWFya2VyXHJcbiAgICAgICAgLy8gYWRkIHRoZSBtYXJrZXIgdG8gdGhlIGdyb3VwXHJcbiAgICAgICAgLmFkZFRvKG1hcmtlckdyb3VwKVxyXG4gICAgICAgIC8vIGFkZCB0aGUgb24tY2xpY2sgdG9vbHRpcFxyXG4gICAgICAgIC5iaW5kUG9wdXAodGVtcGxhdGUpO1xyXG5cclxuICAgICAgbmV3TWFya2VyLm9uKCdjbGljaycsICh7IHRhcmdldCB9KSA9PiB7XHJcbiAgICAgICAgdGhpcy5tYXJrZXJFdmVudHMkLm5leHQoe1xyXG4gICAgICAgICAgdHlwZTogJ21hcmtlci5jbGljaycsXHJcbiAgICAgICAgICBpZDogdGFyZ2V0LmlkXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgbmV3TWFya2VyLm9uKCdtb3VzZW92ZXInLCAoeyB0YXJnZXQgfSkgPT4ge1xyXG4gICAgICAgIHRhcmdldC5vcGVuUG9wdXAoKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBuZXdNYXJrZXIub24oJ21vdXNlb3V0JywgKHsgdGFyZ2V0IH0pID0+IHtcclxuICAgICAgICB0YXJnZXQuY2xvc2VQb3B1cCgpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgLy8gYWRkIHRoZSBtYXJrZXJzIHRvIHRoZSBtYXAgaW5zdGFuY2VcclxuICAgIHRoaXMubWFwSW5zdGFuY2UuYWRkTGF5ZXIobWFya2VyR3JvdXApO1xyXG4gICAgLy8gdXBkYXRlIHRoZSBtYXJrZXIgbGF5ZXIgaW5zdGFuY2VcclxuICAgIHRoaXMubWFya2VyTGF5ZXIgPSBtYXJrZXJHcm91cDtcclxuICB9XHJcblxyXG4gIHNldFZhbHVlKHZhbHVlOiBGQUNFVF9WQUxVRSwgdXBkYXRlID0gZmFsc2UpIHtcclxuICAgIC8vIHByZXZlbnQgdGhlIHNlYXJjaCBzZXJ2aWNlIGZyb20gYXNzaWduaW5nIGEgcGxhaW4gc3RyaW5nXHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcGFyYW0tcmVhc3NpZ25cclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB2YWx1ZSA9IFt2YWx1ZV07XHJcblxyXG4gICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7XHJcbiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuICAgIH1cclxuICAgIHRoaXMuaXNVcGRhdGUgPSB1cGRhdGUgfHwgdGhpcy52YWx1ZSA9PT0gW107XHJcblxyXG4gICAgaWYgKHVwZGF0ZSAmJiB0aGlzLmlucHV0KSB7XHJcbiAgICAgIGNvbnN0IHsgbGlua3MgfSA9IHRoaXMuaW5wdXQ7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRMaW5rcyA9IGxpbmtzLm1hcCgobGluazogQ2FkYXN0cmFsVW5pdCkgPT4gKHtcclxuICAgICAgICAuLi5saW5rLFxyXG4gICAgICAgIGNsYXNzZXM6IHRoaXMudmFsdWUuaW5jbHVkZXMobGluay5wYXlsb2FkKSA/IEFDVElWRV9DTEFTUyA6ICcnXHJcbiAgICAgIH0pKTtcclxuICAgICAgLy8gdXBkYXRlIG1hcmtlciBpY29uc1xyXG4gICAgICBpZiAodGhpcy5tYXJrZXJMYXllcikge1xyXG4gICAgICAgIHRoaXMubWFya2VyTGF5ZXIuZWFjaExheWVyKChtYXJrZXIpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHsgaWQgfSA9IG1hcmtlcjtcclxuICAgICAgICAgIGNvbnN0IGNvdW50ZXIgPSBsaW5rcy5maW5kKCh7IHBheWxvYWQgfSkgPT4gcGF5bG9hZCA9PT0gaWQpPy5jb3VudGVyIHx8IDA7XHJcbiAgICAgICAgICBtYXJrZXIuZ2V0UG9wdXAoKS5fc291cmNlLnNldEljb24odGhpcy5nZXRJY29uKGlkLCBjb3VudGVyKSlcclxuICAgICAgICAgICAgLnNldFpJbmRleE9mZnNldCh0aGlzLmdldFppbmRleChpZCwgY291bnRlcikpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIC0tLVxyXG4gICAgICB0aGlzLnVwZGF0ZSh7XHJcbiAgICAgICAgLi4udGhpcy5pbnB1dCxcclxuICAgICAgICBsaW5rczogdXBkYXRlZExpbmtzXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0SWNvbiA9IChpZDogc3RyaW5nLCBjb3VudGVyOiBudW1iZXIpID0+IHtcclxuICAgIGlmICh0aGlzLnZhbHVlLmluY2x1ZGVzKGlkKSkgcmV0dXJuIE1BUktFUl9JQ09OX1NFTEVDVEVEO1xyXG4gICAgaWYgKGNvdW50ZXIgPiAwKSByZXR1cm4gTUFSS0VSX0lDT047XHJcbiAgICByZXR1cm4gTUFSS0VSX0lDT05fVU5BVkFJTEFCTEU7XHJcbiAgfVxyXG5cclxuICBnZXRaaW5kZXggPSAoaWQ6IHN0cmluZywgY291bnRlcjogbnVtYmVyKSA9PiB7XHJcbiAgICBpZiAodGhpcy52YWx1ZS5pbmNsdWRlcyhpZCkpIHJldHVybiAxOTk5OTtcclxuICAgIGlmIChjb3VudGVyID4gMCkgcmV0dXJuIDk5OTk7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIHRvZ2dsZVZhbHVlKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGV4aXN0cyA9IHRoaXMudmFsdWUuaW5jbHVkZXModmFsdWUpO1xyXG4gICAgaWYgKCFleGlzdHMpIHtcclxuICAgICAgdGhpcy52YWx1ZS5wdXNoKHZhbHVlKTtcclxuICAgIH0gZWxzZSBpZiAoZXhpc3RzKSB7XHJcbiAgICAgIHRoaXMudmFsdWUuc3BsaWNlKHRoaXMudmFsdWUuaW5kZXhPZih2YWx1ZSksIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIHVwZGF0ZVxyXG4gICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnZhbHVlLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIGdldFZhbHVlID0gKCk6IEZBQ0VUX1ZBTFVFID0+IHRoaXMudmFsdWU7XHJcblxyXG4gIGNsZWFyKCkge1xyXG4gICAgdGhpcy52YWx1ZSA9IFtdO1xyXG4gIH1cclxufVxyXG4iXX0=