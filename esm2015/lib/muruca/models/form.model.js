import { Subject, ReplaySubject } from 'rxjs';
import { MrInputTextDS } from '../data-sources/form/input-text.ds';
import { MrInputTextEH } from '../event-handlers/form/input-text.eh';
import { MrInputSelectDS } from '../data-sources/form/input-select.ds';
import { MrInputSelectEH } from '../event-handlers/form/input-select.eh';
import { MrInputCheckboxDS } from '../data-sources/form/input-checkbox.ds';
import { MrInputCheckboxEH } from '../event-handlers/form/input-checkbox.eh';
export class MrFormModel {
    constructor() {
        this.loaded$ = new ReplaySubject();
        this.inputs = {};
        this.inputTypes = {
            text: {
                ds: MrInputTextDS,
                eh: MrInputTextEH
            },
            select: {
                ds: MrInputSelectDS,
                eh: MrInputSelectEH
            },
            checkbox: {
                ds: MrInputCheckboxDS,
                eh: MrInputCheckboxEH
            }
        };
        this.changed$ = new Subject();
        this.getInput = (id) => this.inputs[id].ds;
        this.getInputs = () => {
            const inputs = {};
            Object.keys(this.inputs).forEach((id) => {
                inputs[id] = this.getInput(id);
            });
            return inputs;
        };
    }
    init(config) {
        this.config = config;
        // init inputs
        this.initInputs();
        // emit signal
        this.loaded$.next(true);
    }
    getState() {
        const state = {};
        Object.keys(this.inputs).forEach((key) => {
            state[key] = this.inputs[key].ds.getState();
        });
        return state;
    }
    addInputType(type, ds, eh) {
        if (this.inputTypes[type]) {
            throw Error(`input type ${type} already exists!`);
        }
        this.inputTypes[type] = { ds, eh };
    }
    initInputs() {
        const { sections } = this.config;
        sections.forEach((section) => {
            section.inputs.forEach(({ id, type, options, state, data }) => {
                const DSClass = this.inputTypes[type].ds;
                const EHClass = this.inputTypes[type].eh;
                const DSInstance = new DSClass(options || {});
                const EHInstance = new EHClass();
                // set datasource id
                DSInstance.id = id;
                // set initial data
                if (data) {
                    DSInstance.update(data);
                }
                // set state
                if (state) {
                    DSInstance.setState(state);
                }
                // set eventhandler hostid
                EHInstance.hostId = id;
                // attach datasource to eventhandler
                EHInstance.dataSource = DSInstance;
                // attach changed$ to eventhandler
                EHInstance.changed$ = this.changed$;
                // listen to input events
                EHInstance.listen();
                // save it to input
                this.inputs[id] = {
                    ds: DSInstance,
                    eh: EHInstance,
                    emit: (t, p) => EHInstance.emitInner(t, p)
                };
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuNy1mcm9udGVuZC9ib2lsZXJwbGF0ZS8iLCJzb3VyY2VzIjpbImxpYi9tdXJ1Y2EvbW9kZWxzL2Zvcm0ubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBTzdFLE1BQU0sT0FBTyxXQUFXO0lBQXhCO1FBR1MsWUFBTyxHQUEyQixJQUFJLGFBQWEsRUFBRSxDQUFDO1FBRXRELFdBQU0sR0FNVCxFQUFFLENBQUM7UUFFQyxlQUFVLEdBS2Q7WUFDRixJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLGFBQWE7Z0JBQ2pCLEVBQUUsRUFBRSxhQUFhO2FBQ2xCO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxlQUFlO2dCQUNuQixFQUFFLEVBQUUsZUFBZTthQUNwQjtZQUNELFFBQVEsRUFBRTtnQkFDUixFQUFFLEVBQUUsaUJBQWlCO2dCQUNyQixFQUFFLEVBQUUsaUJBQWlCO2FBQ3RCO1NBQ0YsQ0FBQztRQUVGLGFBQVEsR0FBNkIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQVluRCxhQUFRLEdBQUcsQ0FBQyxFQUFVLEVBQTBCLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUV0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QUNwQixtQkFBbUI7Z0JBQ25CLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUc7b0JBQ2hCLEVBQUUsRUFBRSxVQUFVO29CQUNkLEVBQUUsRUFBRSxVQUFVO29CQUNkLElBQUksRUFBRSxDQUFDLENBQVMsRUFBRSxDQUFNLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDeEQsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IE1ySW5wdXRUZXh0RFMgfSBmcm9tICcuLi9kYXRhLXNvdXJjZXMvZm9ybS9pbnB1dC10ZXh0LmRzJztcclxuaW1wb3J0IHsgTXJJbnB1dFRleHRFSCB9IGZyb20gJy4uL2V2ZW50LWhhbmRsZXJzL2Zvcm0vaW5wdXQtdGV4dC5laCc7XHJcbmltcG9ydCB7IE1ySW5wdXRTZWxlY3REUyB9IGZyb20gJy4uL2RhdGEtc291cmNlcy9mb3JtL2lucHV0LXNlbGVjdC5kcyc7XHJcbmltcG9ydCB7IE1ySW5wdXRTZWxlY3RFSCB9IGZyb20gJy4uL2V2ZW50LWhhbmRsZXJzL2Zvcm0vaW5wdXQtc2VsZWN0LmVoJztcclxuaW1wb3J0IHsgTXJJbnB1dENoZWNrYm94RFMgfSBmcm9tICcuLi9kYXRhLXNvdXJjZXMvZm9ybS9pbnB1dC1jaGVja2JveC5kcyc7XHJcbmltcG9ydCB7IE1ySW5wdXRDaGVja2JveEVIIH0gZnJvbSAnLi4vZXZlbnQtaGFuZGxlcnMvZm9ybS9pbnB1dC1jaGVja2JveC5laCc7XHJcbmltcG9ydCB7XHJcbiAgTXJDaGFuZ2VkUGFyYW1zLFxyXG4gIE1ySW5wdXREYXRhU291cmNlLFxyXG4gIE1yRm9ybUNvbmZpZyxcclxufSBmcm9tICcuLi9pbnRlcmZhY2VzL2Zvcm0uaW50ZXJmYWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBNckZvcm1Nb2RlbCB7XHJcbiAgcHVibGljIGNvbmZpZzogTXJGb3JtQ29uZmlnO1xyXG5cclxuICBwdWJsaWMgbG9hZGVkJDogUmVwbGF5U3ViamVjdDxib29sZWFuPiA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XHJcblxyXG4gIHB1YmxpYyBpbnB1dHM6IHtcclxuICAgIFtpZDogc3RyaW5nXToge1xyXG4gICAgICBkczogYW55O1xyXG4gICAgICBlaDogYW55O1xyXG4gICAgICBlbWl0OiAodDogc3RyaW5nLCBwOiBhbnkpID0+IEZ1bmN0aW9uO1xyXG4gICAgfTtcclxuICB9ID0ge307XHJcblxyXG4gIHByaXZhdGUgaW5wdXRUeXBlczoge1xyXG4gICAgW2lkOiBzdHJpbmddOiB7XHJcbiAgICAgIGRzOiBhbnk7XHJcbiAgICAgIGVoOiBhbnk7XHJcbiAgICB9O1xyXG4gIH0gPSB7XHJcbiAgICB0ZXh0OiB7XHJcbiAgICAgIGRzOiBNcklucHV0VGV4dERTLFxyXG4gICAgICBlaDogTXJJbnB1dFRleHRFSFxyXG4gICAgfSxcclxuICAgIHNlbGVjdDoge1xyXG4gICAgICBkczogTXJJbnB1dFNlbGVjdERTLFxyXG4gICAgICBlaDogTXJJbnB1dFNlbGVjdEVIXHJcbiAgICB9LFxyXG4gICAgY2hlY2tib3g6IHtcclxuICAgICAgZHM6IE1ySW5wdXRDaGVja2JveERTLFxyXG4gICAgICBlaDogTXJJbnB1dENoZWNrYm94RUhcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjaGFuZ2VkJDogU3ViamVjdDxNckNoYW5nZWRQYXJhbXM+ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgaW5pdChjb25maWc6IE1yRm9ybUNvbmZpZykge1xyXG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XHJcblxyXG4gICAgLy8gaW5pdCBpbnB1dHNcclxuICAgIHRoaXMuaW5pdElucHV0cygpO1xyXG5cclxuICAgIC8vIGVtaXQgc2lnbmFsXHJcbiAgICB0aGlzLmxvYWRlZCQubmV4dCh0cnVlKTtcclxuICB9XHJcblxyXG4gIGdldElucHV0ID0gKGlkOiBzdHJpbmcpOiBNcklucHV0RGF0YVNvdXJjZTxhbnk+ID0+IHRoaXMuaW5wdXRzW2lkXS5kcztcclxuXHJcbiAgZ2V0SW5wdXRzID0gKCk6IHtcclxuICAgIFtpZDogc3RyaW5nXTogTXJJbnB1dERhdGFTb3VyY2U8YW55PjtcclxuICB9ID0+IHtcclxuICAgIGNvbnN0IGlucHV0cyA9IHt9O1xyXG4gICAgT2JqZWN0LmtleXModGhpcy5pbnB1dHMpLmZvckVhY2goKGlkKSA9PiB7XHJcbiAgICAgIGlucHV0c1tpZF0gPSB0aGlzLmdldElucHV0KGlkKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGlucHV0cztcclxuICB9XHJcblxyXG4gIGdldFN0YXRlKCkge1xyXG4gICAgY29uc3Qgc3RhdGUgPSB7fTtcclxuICAgIE9iamVjdC5rZXlzKHRoaXMuaW5wdXRzKS5mb3JFYWNoKChrZXkpID0+IHtcclxuICAgICAgc3RhdGVba2V5XSA9IHRoaXMuaW5wdXRzW2tleV0uZHMuZ2V0U3RhdGUoKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHN0YXRlO1xyXG4gIH1cclxuXHJcbiAgYWRkSW5wdXRUeXBlKHR5cGU6IHN0cmluZywgZHM6IGFueSwgZWg6IGFueSkge1xyXG4gICAgaWYgKHRoaXMuaW5wdXRUeXBlc1t0eXBlXSkge1xyXG4gICAgICB0aHJvdyBFcnJvcihgaW5wdXQgdHlwZSAke3R5cGV9IGFscmVhZHkgZXhpc3RzIWApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaW5wdXRUeXBlc1t0eXBlXSA9IHsgZHMsIGVoIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRJbnB1dHMoKSB7XHJcbiAgICBjb25zdCB7IHNlY3Rpb25zIH0gPSB0aGlzLmNvbmZpZztcclxuICAgIHNlY3Rpb25zLmZvckVhY2goKHNlY3Rpb24pID0+IHtcclxuICAgICAgc2VjdGlvbi5pbnB1dHMuZm9yRWFjaCgoe1xyXG4gICAgICAgIGlkLCB0eXBlLCBvcHRpb25zLCBzdGF0ZSwgZGF0YVxyXG4gICAgICB9KSA9PiB7XHJcbiAgICAgICAgY29uc3QgRFNDbGFzcyA9IHRoaXMuaW5wdXRUeXBlc1t0eXBlXS5kcztcclxuICAgICAgICBjb25zdCBFSENsYXNzID0gdGhpcy5pbnB1dFR5cGVzW3R5cGVdLmVoO1xyXG4gICAgICAgIGNvbnN0IERTSW5zdGFuY2UgPSBuZXcgRFNDbGFzcyhvcHRpb25zIHx8IHt9KTtcclxuICAgICAgICBjb25zdCBFSEluc3RhbmNlID0gbmV3IEVIQ2xhc3MoKTtcclxuICAgICAgICAvLyBzZXQgZGF0YXNvdXJjZSBpZFxyXG4gICAgICAgIERTSW5zdGFuY2UuaWQgPSBpZDtcclxuICAgICAgICAvLyBzZXQgaW5pdGlhbCBkYXRhXHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgIERTSW5zdGFuY2UudXBkYXRlKGRhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBzZXQgc3RhdGVcclxuICAgICAgICBpZiAoc3RhdGUpIHtcclxuICAgICAgICAgIERTSW5zdGFuY2Uuc2V0U3RhdGUoc3RhdGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBzZXQgZXZlbnRoYW5kbGVyIGhvc3RpZFxyXG4gICAgICAgIEVISW5zdGFuY2UuaG9zdElkID0gaWQ7XHJcbiAgICAgICAgLy8gYXR0YWNoIGRhdGFzb3VyY2UgdG8gZXZlbnRoYW5kbGVyXHJcbiAgICAgICAgRUhJbnN0YW5jZS5kYXRhU291cmNlID0gRFNJbnN0YW5jZTtcclxuICAgICAgICAvLyBhdHRhY2ggY2hhbmdlZCQgdG8gZXZlbnRoYW5kbGVyXHJcbiAgICAgICAgRUhJbnN0YW5jZS5jaGFuZ2VkJCA9IHRoaXMuY2hhbmdlZCQ7XHJcbiAgICAgICAgLy8gbGlzdGVuIHRvIGlucHV0IGV2ZW50c1xyXG4gICAgICAgIEVISW5zdGFuY2UubGlzdGVuKCk7XHJcbiAgICAgICAgLy8gc2F2ZSBpdCB0byBpbnB1dFxyXG4gICAgICAgIHRoaXMuaW5wdXRzW2lkXSA9IHtcclxuICAgICAgICAgIGRzOiBEU0luc3RhbmNlLFxyXG4gICAgICAgICAgZWg6IEVISW5zdGFuY2UsXHJcbiAgICAgICAgICBlbWl0OiAodDogc3RyaW5nLCBwOiBhbnkpID0+IEVISW5zdGFuY2UuZW1pdElubmVyKHQsIHApXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19