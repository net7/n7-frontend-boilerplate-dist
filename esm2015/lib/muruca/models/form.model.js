import { Subject, ReplaySubject } from 'rxjs';
import { MrInputTextDS } from '../data-sources/form/input-text.ds';
import { MrInputTextEH } from '../event-handlers/form/input-text.eh';
import { MrInputSelectDS } from '../data-sources/form/input-select.ds';
import { MrInputSelectEH } from '../event-handlers/form/input-select.eh';
import { MrInputCheckboxDS } from '../data-sources/form/input-checkbox.ds';
import { MrInputCheckboxEH } from '../event-handlers/form/input-checkbox.eh';
export class MrFormModel {
    constructor() {
        this.loaded$ = new ReplaySubject();
        this.inputs = {};
        this.inputTypes = {
            text: {
                ds: MrInputTextDS,
                eh: MrInputTextEH
            },
            select: {
                ds: MrInputSelectDS,
                eh: MrInputSelectEH
            },
            checkbox: {
                ds: MrInputCheckboxDS,
                eh: MrInputCheckboxEH
            }
        };
        this.changed$ = new Subject();
        this.getInput = (id) => this.inputs[id].ds;
        this.getInputs = () => {
            const inputs = {};
            Object.keys(this.inputs).forEach((id) => {
                inputs[id] = this.getInput(id);
            });
            return inputs;
        };
    }
    init(config) {
        this.config = config;
        // init inputs
        this.initInputs();
        // emit signal
        this.loaded$.next(true);
    }
    getState() {
        const state = {};
        Object.keys(this.inputs).forEach((key) => {
            state[key] = this.inputs[key].ds.getState();
        });
        return state;
    }
    addInputType(type, ds, eh) {
        if (this.inputTypes[type]) {
            throw Error(`input type ${type} already exists!`);
        }
        this.inputTypes[type] = { ds, eh };
    }
    initInputs() {
        const { sections } = this.config;
        sections.forEach((section) => {
            section.inputs.forEach(({ id, type, options, state, data }) => {
                const DSClass = this.inputTypes[type].ds;
                const EHClass = this.inputTypes[type].eh;
                const DSInstance = new DSClass(options || {});
                const EHInstance = new EHClass();
                // set datasource id
                DSInstance.id = id;
                // set initial data
                if (data) {
                    DSInstance.update(data);
                }
                // set state
                if (state) {
                    DSInstance.setState(state);
                }
                // set eventhandler hostid
                EHInstance.hostId = id;
                // attach datasource to eventhandler
                EHInstance.dataSource = DSInstance;
                // attach changed$ to eventhandler
                EHInstance.changed$ = this.changed$;
                // listen to input events
                EHInstance.listen();
                // save it to input
                this.inputs[id] = {
                    ds: DSInstance,
                    eh: EHInstance,
                    emit: (t, p) => EHInstance.emitInner(t, p)
                };
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuNy1mcm9udGVuZC9ib2lsZXJwbGF0ZS8iLCJzb3VyY2VzIjpbImxpYi9tdXJ1Y2EvbW9kZWxzL2Zvcm0ubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUNyRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBTzdFLE1BQU0sT0FBTyxXQUFXO0lBQXhCO1FBR1MsWUFBTyxHQUEyQixJQUFJLGFBQWEsRUFBRSxDQUFDO1FBRXRELFdBQU0sR0FNVCxFQUFFLENBQUM7UUFFQyxlQUFVLEdBS2Q7WUFDRixJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLGFBQWE7Z0JBQ2pCLEVBQUUsRUFBRSxhQUFhO2FBQ2xCO1lBQ0QsTUFBTSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxlQUFlO2dCQUNuQixFQUFFLEVBQUUsZUFBZTthQUNwQjtZQUNELFFBQVEsRUFBRTtnQkFDUixFQUFFLEVBQUUsaUJBQWlCO2dCQUNyQixFQUFFLEVBQUUsaUJBQWlCO2FBQ3RCO1NBQ0YsQ0FBQztRQUVGLGFBQVEsR0FBNkIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQVluRCxhQUFRLEdBQUcsQ0FBQyxFQUFVLEVBQTBCLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUV0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QUNwQixtQkFBbUI7Z0JBQ25CLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUc7b0JBQ2hCLEVBQUUsRUFBRSxVQUFVO29CQUNkLEVBQUUsRUFBRSxVQUFVO29CQUNkLElBQUksRUFBRSxDQUFDLENBQVMsRUFBRSxDQUFNLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDeEQsQ0FBQztZQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0LCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBNcklucHV0VGV4dERTIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2VzL2Zvcm0vaW5wdXQtdGV4dC5kcyc7XG5pbXBvcnQgeyBNcklucHV0VGV4dEVIIH0gZnJvbSAnLi4vZXZlbnQtaGFuZGxlcnMvZm9ybS9pbnB1dC10ZXh0LmVoJztcbmltcG9ydCB7IE1ySW5wdXRTZWxlY3REUyB9IGZyb20gJy4uL2RhdGEtc291cmNlcy9mb3JtL2lucHV0LXNlbGVjdC5kcyc7XG5pbXBvcnQgeyBNcklucHV0U2VsZWN0RUggfSBmcm9tICcuLi9ldmVudC1oYW5kbGVycy9mb3JtL2lucHV0LXNlbGVjdC5laCc7XG5pbXBvcnQgeyBNcklucHV0Q2hlY2tib3hEUyB9IGZyb20gJy4uL2RhdGEtc291cmNlcy9mb3JtL2lucHV0LWNoZWNrYm94LmRzJztcbmltcG9ydCB7IE1ySW5wdXRDaGVja2JveEVIIH0gZnJvbSAnLi4vZXZlbnQtaGFuZGxlcnMvZm9ybS9pbnB1dC1jaGVja2JveC5laCc7XG5pbXBvcnQge1xuICBNckNoYW5nZWRQYXJhbXMsXG4gIE1ySW5wdXREYXRhU291cmNlLFxuICBNckZvcm1Db25maWcsXG59IGZyb20gJy4uL2ludGVyZmFjZXMvZm9ybS5pbnRlcmZhY2UnO1xuXG5leHBvcnQgY2xhc3MgTXJGb3JtTW9kZWwge1xuICBwdWJsaWMgY29uZmlnOiBNckZvcm1Db25maWc7XG5cbiAgcHVibGljIGxvYWRlZCQ6IFJlcGxheVN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuXG4gIHB1YmxpYyBpbnB1dHM6IHtcbiAgICBbaWQ6IHN0cmluZ106IHtcbiAgICAgIGRzOiBhbnk7XG4gICAgICBlaDogYW55O1xuICAgICAgZW1pdDogKHQ6IHN0cmluZywgcDogYW55KSA9PiBGdW5jdGlvbjtcbiAgICB9O1xuICB9ID0ge307XG5cbiAgcHJpdmF0ZSBpbnB1dFR5cGVzOiB7XG4gICAgW2lkOiBzdHJpbmddOiB7XG4gICAgICBkczogYW55O1xuICAgICAgZWg6IGFueTtcbiAgICB9O1xuICB9ID0ge1xuICAgIHRleHQ6IHtcbiAgICAgIGRzOiBNcklucHV0VGV4dERTLFxuICAgICAgZWg6IE1ySW5wdXRUZXh0RUhcbiAgICB9LFxuICAgIHNlbGVjdDoge1xuICAgICAgZHM6IE1ySW5wdXRTZWxlY3REUyxcbiAgICAgIGVoOiBNcklucHV0U2VsZWN0RUhcbiAgICB9LFxuICAgIGNoZWNrYm94OiB7XG4gICAgICBkczogTXJJbnB1dENoZWNrYm94RFMsXG4gICAgICBlaDogTXJJbnB1dENoZWNrYm94RUhcbiAgICB9XG4gIH07XG5cbiAgY2hhbmdlZCQ6IFN1YmplY3Q8TXJDaGFuZ2VkUGFyYW1zPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgaW5pdChjb25maWc6IE1yRm9ybUNvbmZpZykge1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgLy8gaW5pdCBpbnB1dHNcbiAgICB0aGlzLmluaXRJbnB1dHMoKTtcblxuICAgIC8vIGVtaXQgc2lnbmFsXG4gICAgdGhpcy5sb2FkZWQkLm5leHQodHJ1ZSk7XG4gIH1cblxuICBnZXRJbnB1dCA9IChpZDogc3RyaW5nKTogTXJJbnB1dERhdGFTb3VyY2U8YW55PiA9PiB0aGlzLmlucHV0c1tpZF0uZHM7XG5cbiAgZ2V0SW5wdXRzID0gKCk6IHtcbiAgICBbaWQ6IHN0cmluZ106IE1ySW5wdXREYXRhU291cmNlPGFueT47XG4gIH0gPT4ge1xuICAgIGNvbnN0IGlucHV0cyA9IHt9O1xuICAgIE9iamVjdC5rZXlzKHRoaXMuaW5wdXRzKS5mb3JFYWNoKChpZCkgPT4ge1xuICAgICAgaW5wdXRzW2lkXSA9IHRoaXMuZ2V0SW5wdXQoaWQpO1xuICAgIH0pO1xuICAgIHJldHVybiBpbnB1dHM7XG4gIH1cblxuICBnZXRTdGF0ZSgpIHtcbiAgICBjb25zdCBzdGF0ZSA9IHt9O1xuICAgIE9iamVjdC5rZXlzKHRoaXMuaW5wdXRzKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIHN0YXRlW2tleV0gPSB0aGlzLmlucHV0c1trZXldLmRzLmdldFN0YXRlKCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgYWRkSW5wdXRUeXBlKHR5cGU6IHN0cmluZywgZHM6IGFueSwgZWg6IGFueSkge1xuICAgIGlmICh0aGlzLmlucHV0VHlwZXNbdHlwZV0pIHtcbiAgICAgIHRocm93IEVycm9yKGBpbnB1dCB0eXBlICR7dHlwZX0gYWxyZWFkeSBleGlzdHMhYCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnB1dFR5cGVzW3R5cGVdID0geyBkcywgZWggfTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdElucHV0cygpIHtcbiAgICBjb25zdCB7IHNlY3Rpb25zIH0gPSB0aGlzLmNvbmZpZztcbiAgICBzZWN0aW9ucy5mb3JFYWNoKChzZWN0aW9uKSA9PiB7XG4gICAgICBzZWN0aW9uLmlucHV0cy5mb3JFYWNoKCh7XG4gICAgICAgIGlkLCB0eXBlLCBvcHRpb25zLCBzdGF0ZSwgZGF0YVxuICAgICAgfSkgPT4ge1xuICAgICAgICBjb25zdCBEU0NsYXNzID0gdGhpcy5pbnB1dFR5cGVzW3R5cGVdLmRzO1xuICAgICAgICBjb25zdCBFSENsYXNzID0gdGhpcy5pbnB1dFR5cGVzW3R5cGVdLmVoO1xuICAgICAgICBjb25zdCBEU0luc3RhbmNlID0gbmV3IERTQ2xhc3Mob3B0aW9ucyB8fCB7fSk7XG4gICAgICAgIGNvbnN0IEVISW5zdGFuY2UgPSBuZXcgRUhDbGFzcygpO1xuICAgICAgICAvLyBzZXQgZGF0YXNvdXJjZSBpZFxuICAgICAgICBEU0luc3RhbmNlLmlkID0gaWQ7XG4gICAgICAgIC8vIHNldCBpbml0aWFsIGRhdGFcbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICBEU0luc3RhbmNlLnVwZGF0ZShkYXRhKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBzZXQgc3RhdGVcbiAgICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgICAgRFNJbnN0YW5jZS5zZXRTdGF0ZShzdGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gc2V0IGV2ZW50aGFuZGxlciBob3N0aWRcbiAgICAgICAgRUhJbnN0YW5jZS5ob3N0SWQgPSBpZDtcbiAgICAgICAgLy8gYXR0YWNoIGRhdGFzb3VyY2UgdG8gZXZlbnRoYW5kbGVyXG4gICAgICAgIEVISW5zdGFuY2UuZGF0YVNvdXJjZSA9IERTSW5zdGFuY2U7XG4gICAgICAgIC8vIGF0dGFjaCBjaGFuZ2VkJCB0byBldmVudGhhbmRsZXJcbiAgICAgICAgRUhJbnN0YW5jZS5jaGFuZ2VkJCA9IHRoaXMuY2hhbmdlZCQ7XG4gICAgICAgIC8vIGxpc3RlbiB0byBpbnB1dCBldmVudHNcbiAgICAgICAgRUhJbnN0YW5jZS5saXN0ZW4oKTtcbiAgICAgICAgLy8gc2F2ZSBpdCB0byBpbnB1dFxuICAgICAgICB0aGlzLmlucHV0c1tpZF0gPSB7XG4gICAgICAgICAgZHM6IERTSW5zdGFuY2UsXG4gICAgICAgICAgZWg6IEVISW5zdGFuY2UsXG4gICAgICAgICAgZW1pdDogKHQ6IHN0cmluZywgcDogYW55KSA9PiBFSEluc3RhbmNlLmVtaXRJbm5lcih0LCBwKVxuICAgICAgICB9O1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==